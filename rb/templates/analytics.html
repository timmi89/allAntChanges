{% extends "base.html" %}
{% block title %}{{ group.name }} Analytics{%endblock%}


{% block extendedHead %}
<link rel="stylesheet" href="/static/components/morris/morris.css">
<link rel="stylesheet" href="/static/components/pikaday/css/pikaday.css">
<script src="//cdnjs.cloudflare.com/ajax/libs/raphael/2.1.0/raphael-min.js"></script>
<!-- <script src="/static/components/equalize/equalize.min.js"></script> -->
<script src="/static/components/morris/morris.js"></script>
<script src="/static/components/pikaday/pikaday-with-jquery.min.js"></script>

{% endblock %}

{% block mastheadContent %}
    {% with "analytics" as activeAdminTab %} 
    {% include "admin/nav_tabs.html" %}
    {% endwith %}
{% endblock %}

{% block wideContent %}
<div class="mostlyWide">
<section role="datepicker" class="datepicker" style="visibility:hidden;">
	<form>
        <label>Date Range: </label>
    	<input type="text" name="start_date" />
    	<label>to</label>
    	<input type="text" name="end_date" />
    	<button class="btn" type="submit" >Update</button>
    </form>
</section>


<style>
/*.summary {color:#aaa !important;}*/
.summary.hasLoader {min-height:110px; margin-bottom:0;}
.summary .engagement-rate { }
.summary .engagement-rate h2 { }
.summary .engagement-rate .donut { border-right:1px solid #ccc; width:90%;  }
.summary .other-totals {  }
/* http://css-tricks.com/vertically-center-multi-lined-text/ */
.other-totals .attribute .data { font-size:48px; font-weight:bold; text-align: center;  display: table-cell; vertical-align: middle; text-align: center; height:200px; }
.other-totals label { font-size:16px; font-weight:normal; display:block; text-align: center; }
.section { margin-bottom:80px; clear:both; overflow-y: auto; overflow-x:hidden; position: relative;}
.section h1 { font-size: 28px; color: #616161; font-family: 'Helvetica','RDR_HelveticaBold'; }
/*.section.readrboard-usage { min-height: 150px; }*/
/*.section.readrboard-usage h1 {margin-bottom: -32px;}*/
.column { text-align: center; color:#7f7f7f; font-size:20px; }
.column.left { text-align: left; }
.noteworthy { color:#247292; }
.row { clear:both; overflow:auto; }
.header { border-bottom:1px solid #ccc; padding-bottom: 0.5rem; margin-bottom: 1rem;}
.row.even { background:#f0f0f0; }
/*.row.header:hover { background:transparent; }*/
.loading { color:#ccc; font-size:16px; line-height: 35px; height: 35px; width:100%; margin:0 auto; text-align: center; padding:20px; position:absolute; xtop:33%; box-sizing: border-box; }
.loading div { display: inline-block; }
.template { opacity:0; overflow: auto; z-index: 1; position: relative; background:#fff;}
.template th {color:#616161;}
/*.template.rendered { opacity:1;transition: opacity 5s ease-in-out; -moz-transition: opacity 5s ease-in-out; -webkit-transition: opacity 5s ease-in-out; }*/



.datapoint { width:75%; margin:0 auto 5rem; }
.datapoint .number { font-family: 'RDR_HelveticaBold'; font-size:64px; color:#616161; }
.datapoint .number.medium { font-size:48px; }
.datapoint .number.small { font-size:42px; }
.datapoint label { display:block; font-family: 'Helvetica','RDR_Helvetica'; font-weight:100; font-size:16px; background:#f4f4f4; color:#616161; margin-top: -0.5rem; padding:0 0.25rem; }

.datapoint.session-donut { margin-top:-2.5rem; }

.center-column { text-align:center;  }
.center-column .datapoint { margin:0 auto; }

.dashboard-name { width:85%; margin:0 auto; border:4px solid #aaa; font-family: 'RDR_HelveticaBold'; font-size:42px; color:#616161; text-align: center; overflow: hidden; padding: 1.5rem 0.5rem; }
.first-column .dashboard-name { display:none;}

.legend { }
.legend .legend-title { font-family: 'RDR_HelveticaBold'; font-size:21px; color:#616161; }
.legend .legend-content { background:#f4f4f4; }
.legend .legend-content .legend-value { display:inline-block; margin:0.5rem 0; }
.legend .legend-content .legend-value .legend-color { display:inline-block; width:1rem; height:1rem; background:#000; margin-bottom: -2px; }
.legend .legend-content .legend-value .legend-label { display:inline-block; color:#000; font-family: 'Helvetica','RDR_Helvetica'; font-weight:100; font-size:14px; }

.legend.engagement-legend { margin:2rem auto 1rem; width:70%; }
.legend.engagement-legend .legend-content { margin-top: 2rem; margin-bottom: -1rem; }
.legend.engagement-legend .legend-color.engaged { background:#92c325; }
.legend.engagement-legend .legend-label.engaged { color:#7ba51f; margin-right:2rem; }

.legend.engagement-legend .legend-color.not-engaged { background:#909090; }
.legend.engagement-legend .legend-label.not-engaged { color:#909090; }

.graph-canvas { height:200px; z-index:1; }
.graph-title { margin:1rem 1rem -1rem; font-family: 'Helvetica','RDR_Helvetica'; font-weight:100; font-size:16px; color:#616161; }
.graph-value { font-family: 'Helvetica','RDR_Helvetica'; font-weight:100; font-size:16px; color:#616161; margin-top:-1.2rem; position: relative; z-index: 2; }

.morris-hover.morris-default-style { display:none !important; }

@media (min-width: 1px) and (max-width: 960px){
.grid-3 .datapoint .number { font-size:42px; }
.grid-3 .datapoint .number.medium { font-size:36px; }
.grid-3 .datapoint .number.small { font-size:24px; }
.dashboard-name { font-size: 32px;  }


.graph-title { font-size: 0.75rem; height: 3rem; }
}
@media (min-width: 1px) and (max-width: 480px){
.dashboard-name { display:none;}
.first-column .dashboard-name { display:block; margin-bottom: 2rem; }
}
</style>


<section id="analyticsReport" role="panels">
    <div class="grid-12 section summary hasLoader">
        <div class="loading"><div><img src="/static/site/images/reaction_preloader.gif"/> Querying Engagement Totals...</div></div>
    </div>

<script>

function numberWithCommas(x) {
    return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
}
// var readrboardUsageData = {
//         // sessions, pageviews, scroll, time
//         rb_last_30:[1431,1.9,29,10],
//         no_rb:[55012,1.5,15,10]
//     };
function topSummary() {
// console.log(readrboardUsageData);

readrboardUsageData.no_rdr_sessions_count = (readrboardUsageData.all_sessions_count-readrboardUsageData.rdr_sessions_count);

/*
all_sessions_count: 366
articles_read_count: 31
avg_pageviews: 1.46
avg_scroll_depth: 73.97
avg_time: "2:05"
engaged_page_count: 10
no_rdr_sessions_count: 292
rdr_avg_pageviews: 1.2
rdr_avg_scroll_depth: 78.59
rdr_avg_time: "3:08"
rdr_sessions_count: 74
reaction_count: 77
reaction_view_count: 108
*/

var $temp_readrboardUsage = $('<div><div class="template"></div></div>');

    var summaryHTML = [];
    summaryHTML.push( '<div class="grid-3 s-grid-whole padded right s-center first-column"> ');
        summaryHTML.push( '<div class="dashboard-name"> ');
            summaryHTML.push( '{{ group.name }}');
        summaryHTML.push( '</div> ');
        
        summaryHTML.push( '<div class="datapoint people-engaged"> ');
            summaryHTML.push( '<div class="number">'+numberWithCommas(readrboardUsageData.rdr_sessions_count)+'</div> ');
            summaryHTML.push( '<label>engaged sessions</label> ');
        summaryHTML.push( '</div> ');
        
        summaryHTML.push( '<div class="datapoint articles-engaged"> ');
            summaryHTML.push( '<div class="number">'+numberWithCommas(readrboardUsageData.engaged_page_count)+'</div> ');
            summaryHTML.push( '<label>articles actively engaged</label> ');
        summaryHTML.push( '</div> ');

        summaryHTML.push( '<div class="datapoint articles-read"> ');
            summaryHTML.push( '<div class="number">'+numberWithCommas(readrboardUsageData.articles_read_count)+'</div> ');
            summaryHTML.push( '<label>articles read</label> ');
        summaryHTML.push( '</div> ');
    summaryHTML.push( '</div> ');
    summaryHTML.push( '<div class="grid-6 s-grid-whole padded center-column second-column"> ');
        summaryHTML.push( '<div class="dashboard-name"> ');
            summaryHTML.push( '{{ group.name }}');
        summaryHTML.push( '</div> ');
        summaryHTML.push( '<div class="legend engagement-legend"> ');
            summaryHTML.push( '<div class="legend-title">Engagement Activity</div> ');
            summaryHTML.push( '<div class="legend-content"> ');
                summaryHTML.push( '<div class="legend-value"> ');
                    summaryHTML.push( '<div class="legend-color engaged"></div> ');
                    summaryHTML.push( '<div class="legend-label engaged">Used ReadrBoard</div> ');
                summaryHTML.push( '</div> ');
                summaryHTML.push( '<div class="legend-value"> ');
                    summaryHTML.push( '<div class="legend-color not-engaged"></div> ');
                    summaryHTML.push( '<div class="legend-label not-engaged">Other Visitors</div> ');
                summaryHTML.push( '</div> ');
            summaryHTML.push( '</div> ');
        summaryHTML.push( '</div> ');
        summaryHTML.push( '<div class="row engagement-bar-graphs"> ');
            summaryHTML.push( '<div class="grid-4 graphset pageview-graphset"> ');
                summaryHTML.push( '<div class="graph-title">Pageviews<br/>per Session</div> ');
                summaryHTML.push( '<div class="graph-canvas" id="pageview-graph"></div> ');
                summaryHTML.push( '<div class="grid-2">&nbsp;</div> ');
                summaryHTML.push( '<div class="grid-4 graph-value">'+readrboardUsageData.rdr_avg_pageviews+'</div> ');
                summaryHTML.push( '<div class="grid-4 graph-value">'+readrboardUsageData.avg_pageviews+'</div> ');
                summaryHTML.push( '<div class="grid-2">&nbsp;</div> ');
            summaryHTML.push( '</div> ');
            summaryHTML.push( '<div class="grid-4 graphset time-graphset"> ');
                summaryHTML.push( '<div class="graph-title">Time<br/>on Content</div> ');
                summaryHTML.push( '<div class="graph-canvas" id="time-graph"></div> ');
                summaryHTML.push( '<div class="grid-2">&nbsp;</div> ');
                summaryHTML.push( '<div class="grid-4 graph-value">'+readrboardUsageData.rdr_avg_time+'</div> ');
                summaryHTML.push( '<div class="grid-4 graph-value">'+readrboardUsageData.avg_time+'</div> ');
                summaryHTML.push( '<div class="grid-2">&nbsp;</div> ');
            summaryHTML.push( '</div> ');
            summaryHTML.push( '<div class="grid-4 graphset scroll-depth-graphset"> ');
                summaryHTML.push( '<div class="graph-title">Scroll<br/>Depth</div> ');
                summaryHTML.push( '<div class="graph-canvas" id="scroll-depth-graph"></div> ');
                summaryHTML.push( '<div class="grid-2">&nbsp;</div> ');
                summaryHTML.push( '<div class="grid-4 graph-value">'+readrboardUsageData.rdr_avg_scroll_depth+'%</div> ');
                summaryHTML.push( '<div class="grid-4 graph-value">'+readrboardUsageData.avg_scroll_depth+'%</div> ');
                summaryHTML.push( '<div class="grid-2">&nbsp;</div> ');
            summaryHTML.push( '</div> ');
        summaryHTML.push( '</div> ');
    summaryHTML.push( '</div> ');
    summaryHTML.push( '<div class="grid-3 s-grid-whole padded s-center third-column"> ');
        summaryHTML.push( '<div class="datapoint reactions"> ');
            summaryHTML.push( '<div class="number">'+numberWithCommas(readrboardUsageData.reaction_count)+'</div> ');
            summaryHTML.push( '<label>reactions</label> ');
        summaryHTML.push( '</div> ');
        summaryHTML.push( '<div class="datapoint reaction-views"> ');
            summaryHTML.push( '<div class="number">'+numberWithCommas(readrboardUsageData.reaction_view_count)+'</div> ');
            summaryHTML.push( '<label>reaction views</label> ');
        summaryHTML.push( '</div> ');
summaryHTML.push( ' ');
        summaryHTML.push( '<div class="datapoint session-donut graph-canvas" id="engaged-sessions" style="height:200px;"></div> ');
    summaryHTML.push( '</div> ');

var $temp_summarySection = $('<div class="template">'+ summaryHTML.join('')  +'</div>');

    $('.section.summary').html($temp_summarySection).find('.template').animate({'opacity':1},500);

    drawSummaryGraphs();
    $(window).smartresize(drawSummaryGraphs);

}

function timeStringToSeconds(timeString) {
    // assumes MM:SS
    var a = timeString.split(':');
    var seconds = (+a[0]) * 60 + (+a[1]);
    return seconds;
}

function drawSummaryGraphs() {
    $('.graph-canvas').html('');
Morris.Bar({
  element: 'pageview-graph',
  data: [
    { datatype: 'Pageviews', a: readrboardUsageData.rdr_avg_pageviews, b: readrboardUsageData.avg_pageviews }
  ],
  xkey: 'datatype',
  ykeys: ['a', 'b'],
  labels: ['', ''],
  grid:false,
  axes:false,
  barColors:['#92c325','#909090']
});

Morris.Bar({
  element: 'time-graph',
  data: [
    { datatype: 'Pageviews', a: readrboardUsageData.rdr_avg_time, b: readrboardUsageData.avg_time }
  ],
  xkey: 'datatype',
  ykeys: ['a', 'b'],
  labels: ['', ''],
  grid:false,
  axes:false,
  barColors:['#92c325','#909090']
});
Morris.Bar({
  element: 'scroll-depth-graph',
  data: [
    { datatype: 'Pageviews', a: readrboardUsageData.rdr_avg_scroll_depth, b: readrboardUsageData.avg_scroll_depth }
  ],
  xkey: 'datatype',
  ykeys: ['a', 'b'],
  labels: ['', ''],
  grid:false,
  axes:false,
  barColors:['#92c325','#909090']
});

var rdr_session_percentage = ((readrboardUsageData.rdr_sessions_count/readrboardUsageData.all_sessions_count) * 100).toFixed(2),
    session_percentage = ((readrboardUsageData.no_rdr_sessions_count/readrboardUsageData.all_sessions_count) * 100).toFixed(2);

    Morris.Donut({
      element: 'engaged-sessions',
      data: [
        {label: "Engaged ReadrBoard", value: rdr_session_percentage },
        {label: "Other Sessions", value: session_percentage }
      ],
      formatter: function (y) { return y + "%" }
    }).select(0);


} // end drawSummaryGraphs

function pageSummary(pages) {
    var $temp_engagedPages = $('<div><div class="template"></div></div>');
    var $table = $('<table><tr><th>Title</th><th>RB Engagement</th><th>Reactions</th><th>Reaction Views</th><th>Reads</th><th>Scroll Depth</th></tr></table>');

    if (typeof pages != 'undefined') {
        var pageNum = (pages.length > 30) ? 30 : pages.length;

        var engagedPages = [],
            engagementRates = [];
        for (var i=0;i<30;i++) {
            if (typeof pages[i] != 'undefined' ) {
                var engagement_rate = Math.round(((pages[i].a_reaction_count + pages[i].a_reaction_view_count)/pages[i].a_wl_count)*10000)/100;
                var scroll_rate = Math.round(pages[i].b_median_scroll*100)/100;
                engagedPages.push( { title:pages[i].a_pt, reaction_count:pages[i].a_reaction_count, reaction_view_count:pages[i].a_reaction_view_count, engagement_rate:engagement_rate, avg_scroll:scroll_rate, wl_count:pages[i].a_wl_count, hotness:pages[i].hotness } );
                engagementRates.push(engagement_rate);
            }
        }
        engagementRateMax = engagementRates.sort().shift();

        $.each(engagedPages, function(idx, page) {

            var $page = $('<tr class="page_card">' +
                    '<td class="title"><h1 style="background-size:'+ parseInt((page.engagement_rate / engagementRateMax)*100) +'% 30px;"><a href="#">'+page.title+'</a></h1></td>' +
                    '<td class="attribute">'+ page.engagement_rate +'% <label>Engagement</label></td>' +
                    '<td class="attribute">'+ page.reaction_count +' <label>Reactions</label></td>' +
                    '<td class="attribute">'+ page.reaction_view_count +' <label>Reaction View Count</label></td>' +
                    '<td class="attribute">'+ page.wl_count +' <label>Reads</label></td>' +
                    '<td class="attribute">'+ page.avg_scroll +'% <label>Avg Scroll</label></td>' +
                    // '<div class="grid-12 reactions padded">'+ page.reactions +'</div>' +
            '</tr>');

            $table.append($page);

        });
        $temp_engagedPages.find('.template').append( $table );

        $('.section.engaged-pages .hasLoader').html($temp_engagedPages).find('.template').animate({'opacity':1},500);
    }

}
function hotTopics(hotTopics) {
    var $temp_popularTopics = $('<div><div class="template"></div></div>');
    if (typeof hotTopics != 'undefined') {
        var topicNum = (hotTopics.length > 30) ? 30 : hotTopics.length;

        var popularTopics = [];
        for (var i=0;i<30;i++) {
            if (typeof hotTopics[i] != 'undefined' ) {
                popularTopics.push({ body:hotTopics[i][0], count:hotTopics[i][1] });
            }
        }
        var itemNumber = 1;
        $.each(popularTopics, function(idx, topic) {
            var size = (itemNumber<3) ? 'large' : (itemNumber < 9) ? 'medium' : 'small';
            var charCountModifier = (topic.body.length>20) ? 'smallest':(topic.body.length>14) ? 'smaller':'large';
            // $temp_popularTopics.find('.template').append('<div class="grid-'+gridNum+'"><span class="topic-tag '+charCountModifier+'"><a href="#">'+topic.body+' <span class="counter">'+topic.count+'</span></a></span></div>'); 
            $temp_popularTopics.find('.template').append('<span class="topic-tag '+size+'"><a href="#" class="'+charCountModifier+'">'+topic.body+'</a></span>'); 
            itemNumber++;
        });

        $('.section.reactions-and-topics').find('.topics-holder').html($temp_popularTopics).find('.template').animate({'opacity':1},500);
    }
}

function refSummary(referrers) {
    var $temp_engagedReferrers = $('<div><div class="template"></div></div>');
    var $table = $('<table><tr><th style="text-align:left;">Domain</th><th>RB Engagement</th><th>Reactions</th><th>Reaction Views</th><th>Reads</th><th>Scroll Depth</th></tr></table>');

    if (typeof referrers != 'undefined') {

        var referrerNum = (referrers.length > 30) ? 30 : referrers.length;
        var engagedReferrers = [],
            engagementRates = [];
        for (var i=0;i<30;i++) {
            if (typeof referrers[i] != 'undefined') {
                // var engagement_rate = Math.round(((referrers[i].a_reaction_count + referrers[i].a_reaction_view_count)/referrers[i].a_wl_count)*100);
                var engagement_rate = Math.round(((referrers[i].a_reaction_count + referrers[i].a_reaction_view_count)/referrers[i].a_wl_count)*10000)/100;
                var scroll_rate = Math.round(referrers[i].b_median_scroll*100)/100;
                engagedReferrers.push( { title:referrers[i].a_ref, reaction_count:referrers[i].a_reaction_count, reaction_view_count:referrers[i].a_reaction_view_count, hotness:referrers[i].hotness, engagement_rate:engagement_rate, avg_scroll:scroll_rate, wl_count:referrers[i].a_wl_count } );
                engagementRates.push(engagement_rate);
            }
        }
        engagementRateMax = engagementRates.sort().shift();

        $.each(engagedReferrers, function(idx, referrer) {
            var $referrer = $('<tr class="page_card">' +
                    '<td class="title"><h1 style="background-size:'+ parseInt((referrer.engagement_rate / engagementRateMax)*100) +'% 30px;"><a href="#">'+referrer.title+'</a></h1></td>' +
                    // '<td class="attribute">'+ referrer.hotness +' <label>Engagement</label></td>' +
                    '<td class="attribute">'+ referrer.engagement_rate +'% <label>Engagement</label></td>' +
                    '<td class="attribute">'+ referrer.reaction_count +' <label>Reactions</label></td>' +
                    '<td class="attribute">'+ referrer.reaction_view_count +' <label>Reaction View Count</label></td>' +
                    '<td class="attribute">'+ referrer.wl_count +' <label>Reads</label></td>' +
                    '<td class="attribute">'+ referrer.avg_scroll +'% <label>Avg Scroll</label></td>' +
            '</tr>');

            $table.append($referrer);

        });
        $temp_engagedReferrers.find('.template').append( $table );

        $('.section.engaged-referrers .hasLoader').html($temp_engagedReferrers).find('.template').animate({'opacity':1},500);
    }
}

</script>



<style>
a { color:#5ba0bc; }
.reactions-and-topics .hasLoader { min-height:150px; }
.topic-tag { display: inline-block; }
.topic-tag:hover { background:#f0f0f0; }
.topic-tag a { color:#5ba0bc; text-decoration: none;  }
.topic-tag.large { font-size:51px; padding:10px 10px; }
.topic-tag.medium { font-size:31px; padding:10px 10px; }
.topic-tag.small { font-size:20px; padding:10px 10px; }
.reaction-tag { border:4px solid #737373; padding:10px 20px; display:block; text-align:center; margin-right:10px; margin-bottom:10px; white-space: nowrap;}
    .grid-6 .reaction-tag { font-size:2rem; }
    .grid-4 .reaction-tag { font-size:1.25rem; padding:10px; }
    .grid-3 .reaction-tag { font-size:14px; padding:10px; }
    .topic-tag .mediumer,
    .reaction-tag.mediumer a { font-size:90%; }
    .topic-tag .smaller,
    .reaction-tag.smaller a { font-size:80%; }
    .topic-tag .smallest,
    .reaction-tag.smallest a { font-size:60%; }
.reaction-tag a {  color:#3c3c3c; font-weight:bold; display: inline-block; overflow: hidden; width: 100%;}
.reaction-tag .counter { display:block;font-size:16px; }
.reactions-and-topics .reactions-holder .grid-6 .reaction-tag { height:78px; }
.reactions-and-topics .reactions-holder .grid-4 .reaction-tag { height:53px; }
.reactions-and-topics .reactions-holder .grid-3 .reaction-tag { height:39px; }
.hasLoader {position: relative; min-height: 100px;}
/*.loading{display:none;}*/
</style>
    <div class="section reactions-and-topics">
        <div class="grid-12 padded">
            <div class="grid-6 s-grid-whole hasLoader">
                <h1 class="header">Most Popular Reactions</h1> 
                <div class="loading"><div><img src="/static/site/images/reaction_preloader.gif"/> Counting Reactions...</div></div>
                <div class="reactions-holder">&nbsp;</div>
            </div>
            <div class="grid-6 s-grid-whole hasLoader">
                <h1 class="header">Most Engaged Topics</h1>
                <div class="loading"><div><img src="/static/site/images/reaction_preloader.gif"/> Analyzing Topics...</div></div>
                <div class="topics-holder">&nbsp;</div>
            </div>
        </div>
    </div>
<style>
table { width:100%; }
.page_card { clear:both; overflow:auto; }
.page_card:hover { background:#f3f3f3; }
.page_card:nth-child(even) { border-top:1px solid #ddd; border-bottom:1px solid #ddd; }
.page_card td {padding:10px 0; text-align: center;}
.page_card .title { width:40%;  text-align: left; }
.page_card .title h1 { font-size:14px; font-weight:normal; background:url(/static/images/site/green_bar.png) 0 0 no-repeat; padding:0.25rem;}
.page_card .title h1 a { color:#616161;}
.page_card .attribute { font-size:14px; xfont-weight:bold; width:12%; }
.page_card .attribute label { font-size:12px; font-weight:normal; display:none; }
.page_card .reactions { font-size:11px; font-weight:bold; } 
</style>
    <div class="section engaged-pages">
        <div class="grid-12 row padded">
            <h1 class="header">Most Engaged Pages</h1>
        </div>
        <div class="grid-12 row padded hasLoader">
            <div class="loading"><div><img src="/static/site/images/reaction_preloader.gif"/> Analyzing Page Engagement...</div></div>
        </div>
    </div>
<style>
.content-item a { font-weight:normal; font-size:18px; color:#3c3c3c; }
.content-item .reactions { margin-top:10px;}
.content-item .reaction-tag { font-weight:normal; font-size:12px; padding:5px; display:inline-block; border-width:2px;}
.via { padding:10px 0; color:#999; font-size:12px; }
.via a { font-size:12px; color:#5ba0bc; }
.engaged-content {
    /* until we have a simple iframe that can load the content... */
    /* <iframe src="readrboard.com/content/ID"></iframe> */
    display:none;
}
</style>
    <div class="section engaged-content">
        <div class="grid-12 row padded">
            <h1 class="header">Most Engaged Content</h1>
        </div>
        <div class="grid-12 row padded">
            <div class="grid-4 padded">
                <section class="content-item">
                    <h1><a href="#">All three of us, Ludo, Silvia and myself, are from three different countries. So there all three of us were, speaking different languages, and having fun reading GIFs aloud and comparing in our native tongues, along with different customs and perceptions,” Petrovici says.</a></h1>
                    <div class="grid-12 via">
                        <em>via <a href="#">SomeArticle Name</a></em>
                    </div>
                    <div class="grid-12">
                        <div class="reaction-tag">Amazing (29)</div>
                        <div class="reaction-tag">Crazy (17)</div>
                    </div>
                </section>
            </div>
            <div class="grid-4 padded">
                <section class="content-item">
                    <h1><a href="#"><img src="http://www.vancouverdesi.com/wp-content/uploads/2014/04/9737239-300x186.jpg"/></a></h1>
                    <div class="grid-12 via">
                        <em>via <a href="#">SomeArticle Name</a></em>
                    </div>
                    <div class="grid-12 reactions">
                        <div class="reaction-tag">Sad (12)</div>
                        <div class="reaction-tag">Shocking (10)</div>
                    </div>
                </section>
            </div>
            <div class="grid-4 padded">
                <section class="content-item">
                    <h1><a href="#"><iframe class="contentBody" width="300" height="250" frameborder="0" src="http://www.youtube.com/embed/kzcs5EQOLwo"></iframe></a></h1>
                    <div class="grid-12 via">
                        <em>via <a href="#">SomeArticle Name</a></em>
                    </div>
                    <div class="grid-12">
                        <div class="reaction-tag">LOVE IT (9)</div>
                        <div class="reaction-tag">Legit (8)</div>
                    </div>
                </section>
            </div>
        </div>
    </div>
    <div class="section engaged-referrers">
        <div class="grid-12 row padded">
            <h1 class="header">Most Engaged Referrers</h1>
        </div>
        <div class="grid-12 row padded hasLoader">
            <div class="loading"><div><img src="/static/site/images/reaction_preloader.gif"/> Analyzing Referrer Engagement...</div></div>
        </div>
    </div>

</section>
</div>

<script>

(function(){

        // put in external file...
        RB.analytics = {
            queryHost: (document.domain != "local.readrboard.com") ? "//events.readrboard.com" : "//localnode.com:3000",
            queue:{
                'createSessionPageloads' : false,
                'createRdrSessions' : false,
                'sessionPageTimes' : false
            },
            dequeue: function(funcName) {
                console.log( 'dequeue: ' + funcName );
                RB.analytics.queue[funcName] = true;

                for (var i in RB.analytics.queue){
                    if (RB.analytics.queue[i] == false) {
                        return;
                    }
                }

                // RB.analytics.toggleGlobalLoader();
            },
            toggleGlobalLoader: function() {
                // TODO animate something
                // console.log('toggleGlobalLoader');
            },
            initAnalytics: function() {
                RB.analytics.getTopPages();
                RB.analytics.getTopReactions();
                RB.analytics.getSummaries();
                RB.analytics.getTopReferrers();


                // RB.analytics.toggleGlobalLoader();
                // RB.analytics.createRdrSessions();
                // RB.analytics.createSessionPageloads();
                // RB.analytics.sessionPageTimes();

                // console.log('initAnalytics');
                // $.ajax({
                //     url: RB.analytics.queryHost + '/initAnalytics',
                //     type: "get",
                //     data: {
                //         json: $.toJSON( { sn:'{{group.short_name}}',gid:RB.group.id } )
                //     },
                //     success: function(response) {
                //         console.log('received: init success');
                //         console.log(response);
                //         RB.group.tempTablePre = response.tempTablePre;
                //         RB.analytics.createRdrSessions();
                //         RB.analytics.createSessionPageloads();
                //         RB.analytics.sessionPageTimes();
                //         }
                //     });
            },
            createSessionPageloads: function() {
                console.log('createSessionPageloads');
                $.ajax({
                url: RB.analytics.queryHost + '/createSessionPageloads',
                type: "get",
                data: {
                    json: $.toJSON( { temp:RB.group.tempTablePre, gid:RB.group.id } )
                },
                success: function(response) {
                    console.log('received: create sessions success');
                    console.log(response);
                    RB.analytics.dequeue('createSessionPageloads');
                    }
                });
            },
            createRdrSessions: function() {
                console.log('createRdrSessions');
                $.ajax({
                url: RB.analytics.queryHost + '/createRdrSessions',
                type: "get",
                data: {
                    json: $.toJSON( { temp:RB.group.tempTablePre, gid:RB.group.id } )
                },
                success: function(response) {
                    console.log('received: create sessions success');
                    console.log(response);
                    RB.analytics.dequeue('createRdrSessions');
                    RB.analytics.simulate();
                    }
                });
            },
            sessionPageTimes: function() {
                console.log('sessionPageTimes');
                $.ajax({
                url: RB.analytics.queryHost + '/sessionPageTimes',
                type: "get",
                data: {
                    json: $.toJSON( { temp:RB.group.tempTablePre, gid:RB.group.id } )
                },
                success: function(response) {
                    console.log('received: create sessionPageTimes success');
                    console.log(response);
                    RB.analytics.dequeue('sessionPageTimes');
                    }
                });
            },
            getSummaries: function() {
                console.log('getSummaries');
                $.ajax({
                url: RB.analytics.queryHost + '/getSummaries',
                type: "get",
                data: {
                    json: $.toJSON( { gid:RB.group.id } )
                },
                success: function(response) {
                    console.log('received: getSummaries success');
                    console.log(response);
                    readrboardUsageData = response;
                    topSummary();
                    // RB.analytics.dequeue('getSummaries');

                    }
                });
            },
            getTopPages: function() {
                console.log('getTopPages');
                // var tempPageOb = { 'pages': [
                //     {
                //         'a_pid': "655899",
                //         'a_pt': "Glamour Boy Lyrics | Burton Cummings",
                //         'a_reaction_count': 4,
                //         'a_reaction_view_count': 9,
                //         'a_wl_count': 11,
                //         'b_median_scroll': 76,
                //         'hotness': 1.8433333333333333
                //     },
                //     {
                //         'a_pid': "591875",
                //         'a_pt': "No Time Lyrics | Burton Cummings",
                //         'a_reaction_count': 18,
                //         'a_reaction_view_count': 36,
                //         'a_wl_count': 73,
                //         'b_median_scroll': 82.29508196721312,
                //         'hotness': 1.552680549401861
                //     },{
                //         'a_pid': "655909",
                //         'a_pt': "Hang On To Your Life Lyrics | Burton Cummings",
                //         'a_reaction_count': 14,
                //         'a_reaction_view_count': 34,
                //         'a_wl_count': 59,
                //         'b_median_scroll': 69.76744186046511,
                //         'hotness': 1.4976744186046511
                //     },{
                //         'a_pid': "655863",
                //         'a_pt': "American Woman Lyrics | Burton Cummings",
                //         'a_reaction_count': 23,
                //         'a_reaction_view_count': 23,
                //         'a_wl_count': 75,
                //         'b_median_scroll': 70.58823529411765,
                //         'hotness': 1.3111455108359134
                //     },{
                //         'a_pid': "655940",
                //         'a_pt': "Rain Dance Lyrics | Burton Cummings",
                //         'a_reaction_count': 4,
                //         'a_reaction_view_count': 0,
                //         'a_wl_count': 7,
                //         'b_median_scroll': 80,
                //         'hotness': 1.3
                //     },{
                //         'a_pid': "655860",
                //         'a_pt': "Albert Flasher Lyrics | Burton Cummings",
                //         'a_reaction_count': 1,
                //         'a_reaction_view_count': 0,
                //         'a_wl_count': 5,
                //         'b_median_scroll': 90,
                //         'hotness': 1.0666666666666667
                //     },{
                //         'a_pid': "655891",
                //         'a_pt': "Dreams Lyrics | Burton Cummings",
                //         'a_reaction_count': 6,
                //         'a_reaction_view_count': 2,
                //         'a_wl_count': 39,
                //         'b_median_scroll': 69.6,
                //         'hotness': 0.8959999999999999
                //     },{
                //         'a_pid': "619469",
                //         'a_pt': "These Eyes Lyrics | Burton Cummings",
                //         'a_reaction_count': 4,
                //         'a_reaction_view_count': 1,
                //         'a_wl_count': 26,
                //         'b_median_scroll': 70,
                //         'hotness': 0.8851851851851851
                //     }]
                // };

                // pageSummary(tempPageOb.pages);
                
                $.ajax({
                    url: RB.analytics.queryHost + '/getTopPages',
                    type: "get",
                    data: {
                        json: $.toJSON( { gid:RB.group.id } )
                    },
                    success: function(response) {
                        console.log('received: getTopPages success');
                        console.log(response);
                        pageSummary(response.pages);
                        hotTopics(response.hot_topics);
                        // RB.analytics.dequeue('getSummaries');

                    }, error: function(request, status, error) {
                        console.log('error: ', status, error);
                    }, complete:function(request, status) {
                        console.log('get top pages COMPLETE: '+status);
                    }
                });
            },
            getTopReferrers: function() {
                console.log('getTopReferrers');
                $.ajax({
                url: RB.analytics.queryHost + '/getTopReferrers',
                type: "get",
                data: {
                    json: $.toJSON( { gid:RB.group.id } )
                },
                success: function(response) {
                    // console.log('received: getTopReferrers success');
                    // console.log(response);
                    refSummary(response.referrers);
                    // RB.analytics.dequeue('getSummaries');

                }, error: function(request, status, error) {
                    console.log('error: ', status, error);
                }, complete:function(request, status) {
                    console.log('get top pages COMPLETE: '+status);
                }
                });
            },
            getTopReactions: function() {
                console.log('getTopReactions');
                $.ajax({
                url: RB.analytics.queryHost + '/getTopReactions',
                type: "get",
                data: {
                    json: $.toJSON( { gid:RB.group.id } )
                },
                success: function(response) {
                    console.log('received: getTopReactions success');
                    console.log(response);

                    var $temp_popularReactions = $('<div><div class="template"></div></div>');
                    var popularReactions = response.reactions;
                    // [
                    //     { body:'Love It', count:1668 },
                    //     { body:'Amazing', count:260 },
                    //     { body:'Uh, no', count:127 },
                    //     { body:'I\'ll Take it', count:77 },
                    //     { body:'You sure?', count:55 },
                    //     { body:'Hilarious', count:31 },
                    //     { body:'A lesson in patience', count:25 },
                    //     { body:'Solid Collectively', count:20 }
                    // ];
                    var itemNumber = 1;
                    $.each(popularReactions, function(idx, reaction) {
                        console.log(reaction);
                        var gridNum = (itemNumber<3) ? '6' : (itemNumber < 9) ? '4' : '3';
                        // var charCountModifier = (reaction.body.length>14) ? 'smaller':(reaction.body.length>20) ? 'smallest':'' 
                        var charCountModifier = (reaction.body.length>20) ? 'smallest' : (reaction.body.length>14) ? 'smaller':(reaction.body.length>7) ? 'mediumer':'large';
                        $temp_popularReactions.find('.template').append('<div class="grid-'+gridNum+'"><span class="reaction-tag '+charCountModifier+'"><a href="/group/'+RB.group.short_name+'/?s='+reaction.body+'" target="_blank">'+reaction.body+' <span class="counter">'+numberWithCommas(reaction.count)+'</span></a></span></div>'); 
                        itemNumber++;
                    });

                    $('.section.reactions-and-topics').find('.reactions-holder').html($temp_popularReactions).find('.template').animate({'opacity':1},500);
                    // RB.analytics.dequeue('getSummaries');

                    }
                });
            },
        	updateAll: function() {
                console.log('group_id: {{ group.id }}');
        	},
            simulate: function() {
                var readrboardUsageData = {
                    // sessions, pageviews, scroll, time
                    rb_last_30:[14984,2.55,58.1,'4:42'],
                    no_rb:[149510,1.56,58.55,'3:48']
                };
                topSummary( readrboardUsageData );
            },
            setDates: function(){

                var nowDate = moment().format("MM/DD/YY");
                RB.analytics.startDate = RB.util.getHashValue('start') || nowDate;
                RB.analytics.endDate = RB.util.getHashValue('end') || moment().add('days',1).format("MM/DD/YY");

                RB.analytics.jsStartDate = RB.analytics.startDate ? new Date(RB.analytics.startDate) : new Date();
                RB.analytics.jsEndDate = RB.analytics.endDate ? new Date(RB.analytics.endDate) : new Date();

                console.log('RB.analytics.startDate');
                console.log(RB.analytics.jsStartDate);
                console.log( moment(RB.analytics.jsStartDate).unix() );

                console.log('RB.analytics.endDate');
                console.log(RB.analytics.jsendDate);
                console.log( moment(RB.analytics.jsendtDate).unix() );

    //Oh - another thing - createdAt and updatedAt are now stored in their own columns also - thus you can do time-based queries. 
    // The complication is that they are stored as standard bigint values, being the number of milliseconds since 1970
    //             So for example to get everything in events for the past 1 hour you can do
    // in your javascript
    //     var hourAgo = new Date().getTime() - (60 * 60 * 1000);
    // sql = “select count(*) from events where createdAt >= “ + hourAgo;
            }

        };


        // defined in template
        RB.group.short_name = "{{ group.short_name }}";
        RB.group.full_name = "{{ group.name }}";
        RB.group.id = "{{ group.id }}";
        // RB.group.id = 1660;
        
        $(function(){
            // RB.group.id = 1660;
            RB.group.id = {{ group.id }};

            RB.analytics.setDates();

            //init this once so that the destroy function doesn't error when it refreshes this.
            // $('section[role="tag cloud grid"]').isotope();
            
            // $('section[role="datepicker"] input' ).datepicker({ dateFormat: 'mm/dd/y' });

            var start_date = new Pikaday({ field: $('input[name="start_date"]')[0], format: 'MM/DD/YY' });
            var end_date = new Pikaday({ field: $('input[name="end_date"]')[0], format: 'MM/DD/YY' });

            $('input[name="start_date"]').val( RB.analytics.startDate );
            $('input[name="end_date"]').val( RB.analytics.endDate );

            
            // ***** DATE PICKER: re-enable
            // $('section[role="datepicker"] form').submit( function() {

            //     var startDate = $('input[name="start_date"]').val();
            //     var endDate = $('input[name="end_date"]').val();
                
            //     RB.util.setHashValue('start', startDate );
            //     RB.util.setHashValue('end', endDate );

            //     RB.analytics.updateAll();
            //     return false;
            // });

            RB.analytics.initAnalytics();
            // RB.analytics.dequeue();

        });


})();

</script>
{% endblock wideContent %}
