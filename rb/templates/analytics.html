{% extends "base.html" %}

{% block title %}{{ group.name }} Analytics{%endblock%}

{% block bodyClass %}wide{% endblock %}

{% block extendedHead %}
<script src="{{ STATIC_URL }}global/js/jquery-ui-datepicker.custom.min.js"></script>
<script src="{{ STATIC_URL }}site/js/highcharts/highcharts.js"></script>
<link rel="stylesheet" href="{{ STATIC_URL }}global/css/datepicker_css/ui-lightness/jquery-ui-1.8.15.custom.css">
<style>
    section[role="datepicker"] button {
        position: relative;
        top:-4px;
    }
</style>
{% endblock %}

{% block mainContent %}
<h1>{{ group.name }} Analytics</h1>
<section role="datepicker" class="datepicker">
	<label>Date Range: </label>
	<input type="text" name="start_date" />
	<label>to</label>
	<input type="text" name="end_date" />
	<button class="btn" >Update</button>
</section>
<section role="panels">

	<div class="section_content">
        <div class="reactions">
            <div class="other_reactions">
                <section role="most popular tags">
                    <h1 class="sectionHeader">Other Reactions</h1>
                    <ol></ol>
                </section>
            </div>
            <div class="most_popular">
                <h1 class="sectionHeader">Most Popular Reactions</h1>
                <div id="pie_chart_labels">
                    <ol></ol>
                </div>
                <div id="pie_chart_container">
                    <div id="pie_chart"></div>
                    <div id="pie_chart_credit">
                        <span>Highcharts.com</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
	<section role="wide panels">

		<section role="interaction frequency">
			<div role="total interactions">
				<h1>0</h1>
				<h4>Interactions</h4>
			</div>
			<div role="frequency chart" id="frequency_chart">
				<h5>frequency chart</h5>
			</div>
		</section> <!-- / interaction frequency -->

		<!-- <section role="most popular tags">
			<h3>Most Popular Tags</h3>
			<ol></ol>
		</section> --> <!-- /most popular tags -->

		<section role="most active pages">
			<h3>Most Active Pages</h3>
			<table role="active pages table" cellpadding="0" cellspacing="0" border="0">
				<thead>
					<tr>
						<td role="url">URL</td>
						<td role="title">Title</td>
						<td role="reactions"><img src="/static/site/images/blank.png" class="icon" /> Reactions</td>
						<td role="shares"><img src="/static/site/images/blank.png" class="icon" /> Shares</td>
						<td role="comments"><img src="/static/site/images/blank.png" class="icon" /> Comments</td>
					</tr>
				</thead>
				<tbody></tbody>
			</table>
		</section><!-- /most popular tags -->

		<section role="most active content">
			<h3>Most Active Content</h3>
			<table role="active content table" cellpadding="0" cellspacing="0" border="0">
				<thead>
					<tr>
						<!-- <td role="via">via</td> -->
						<td role="content">Content</td>
						<td role="reactions"><img src="/static/site/images/blank.png" class="icon" /> Reactions</td>
						<td role="shares"><img src="/static/site/images/blank.png" class="icon" /> Shares</td>
						<td role="comments"><img src="/static/site/images/blank.png" class="icon" /> Comments</td>
					</tr>
				</thead>
				<tbody></tbody>
			</table>
		</section> <!-- /most active content -->

	</section> <!-- / wide panels -->

	<section role="thin panels">
		<section role="most active readers">
			<h3>Most Active Readers</h3>
			<table role="active user table" cellpadding="0" cellspacing="0" border="0">
				<thead>
					<td colspan="2">Reader</td>
					<td role="reactions"><img src="/static/site/images/blank.png" class="icon" /></td>
					<td role="shares"><img src="/static/site/images/blank.png" class="icon" /></td>
					<td role="comments"><img src="/static/site/images/blank.png" class="icon" /></td>
				</thead>
				<tbody></tbody>
			</table>
		</section> <!-- / most active readers -->

		<section role="recent pages" style="display:none;">
			<h3>Recently Active Pages</h3>
			<table role="recent pages table" cellpadding="0" cellspacing="0" border="0">
				<tbody></tbody>
			</table>
		</section> <!-- / most popular bookmarks -->

		<section role="most popular shares">
			<h3>Popular Shared Content</h3>
			<table role="popular shares" cellpadding="0" cellspacing="0" border="0">
				<tbody></tbody>
			</table>
		</section> <!-- / most popular shares -->

		<!-- 
		<section role="most popular bookmarks">
			<h3>Popular Bookmarked Content</h3>
			<table role="popular bookmarks" cellpadding="0" cellspacing="0" border="0">
				<tbody></tbody>
			</table>
		</section>
		/ most popular bookmarks -->

	</section>
</section>

<script>
$( 'section[role="datepicker"] input' ).datepicker({ dateFormat: 'mm/dd/y' });

// Radialize the colors
Highcharts.getOptions().colors = $.map(Highcharts.getOptions().colors, function(color) {
    return {
        radialGradient: { cx: 0.5, cy: 0.3, r: 0.7 },
        stops: [
            [0, color],
            [1, Highcharts.Color(color).brighten(-0.3).get('rgb')] // darken
        ]
    };
});

// put in external file...
RB.analytics = {

	mostPopular: function( args ) {
		var start = ( args && args.start ) ? args.start : RB.analytics.startDate;
		var end = ( args && args.end ) ? args.end : RB.analytics.endDate;
		var type = ( args && args.type ) ? args.type : "tags";  // users, pages, content
		var max_count = ( args && args.max_count ) ? args.max_count : 20;  // users, pages, content

		var querystring = "?" +
			"start="+start +
			"&end="+end +
			"&max_count="+max_count;

		$.ajax({
			url: '/analytics/group/'+RB.group.short_name+'/'+type+'/popular/'+querystring,
			type: "get",
			contentType: "application/json",
			dataType: "jsonp",
			success: function(response){
				if (type == "tags") {
					// function SortByTagCount(a,b) { return b.count - a.count; }
                	// interaction_order.sort( SortByTagCount );

					var other_tag_list = "",
						$pie_chart_labels = $('#pie_chart_labels ol'),
						tag_count = 0,
						pie_chart_data = [];
					for ( var i in response ) {
						if ( tag_count < 8 ) {
							$pie_chart_labels.append('<li><a href="/group/'+RB.group.short_name+'/?s='+response[i].interaction_node__body+'">'+response[i].interaction_node__body+' <span>('+response[i].count+')</span></a></li>');
							pie_chart_data.push( [response[i].interaction_node__body, response[i].count] );
						} else {
							var sizeClass = "medium"; //( response[i].count > 7 ) ? "large" : (response[i].count > 4 ) ? "medium" : "small";
							other_tag_list += '<li class="'+sizeClass+'"><a href="/group/{{ group.short_name }}/?s='+response[i].interaction_node__body+'" target="_blank">('+response[i].count+') '+response[i].interaction_node__body+'</a></li>';
						}
						tag_count++;
					}

					if ( tag_count == 0 ) {
						$('section[role="panels"]').hide().after(('<h1 style="margin:20px auto;text-align:center;">No interactions in this date range!</h1>'));
						return;
					} else {
						$('section[role="panels"]').show();
					}
					if ( tag_count <= 8 ) {
						$('div.most_popular').addClass('solo').siblings().hide();
					} else {
						$('div.most_popular').removeClass('solo').siblings().show();
						$('section[role="most popular tags"] ol').html( $(other_tag_list) );
					}
                
                // Build the chart
                var pie_chart;
                pie_chart = new Highcharts.Chart({
                    chart: {
                        renderTo: 'pie_chart',
                        plotBackgroundColor: null,
                        plotBorderWidth: null,
                        plotShadow: false
                    },
                    title: {
                        text: ''
                    },
                    tooltip: {
                        // pointFormat: '{series.name}',
                        // enabled:false
                    },
                    plotOptions: {
                        series: {
                            point: {
                        events: {
                            mouseOver: function() {
                                var nthChild = this.x+1;
                                $('#pie_chart_labels ol li:nth-child('+nthChild+')').addClass('active');
                            },
                            mouseOut: function() {
                                var nthChild = this.x+1;
                                $('#pie_chart_labels ol li:nth-child('+nthChild+')').removeClass('active');
                            }
                        }
                    },
                        },
                        pie: {
                            allowPointSelect: true,
                            cursor: 'pointer',
                            dataLabels: {
                                enabled: false
                            }
                        }
                    },
                    series: [{
                        type: 'pie',
                        name: 'Reactions',
                        data: pie_chart_data
                    }]
                });
				} else if (type=="bookmarks") {
					// var bookmarkHtml = "";
					// for ( var i in response ) {
					// 	var bookmark = response[i];
					// 	bookmarkHtml += '<tr><td role="content">('+bookmark[0].count+') '+bookmark[0].content__body+'</td></tr><tr><td role="reactions"><strong>Reactions:</strong>';
					// 	for ( var j in bookmark[1].related_reactions ) {
					// 		var reaction = bookmark[1].related_reactions[j];
					// 		bookmarkHtml += '('+reaction.count+') '+reaction.interaction_node__body;
					// 		if ( j < bookmark[1].related_reactions.length - 1 ) bookmarkHtml += ", ";
					// 	}
					// 	bookmarkHtml += '</td></tr>'; 
					// 	// bookmarkHtml += '<tr><td role="via"><em>View <a href="#" target="_blank">On your site <img src="/static/site/images/external_link_icon.gif" /></a> | <a href="#" target="_blank">Page Info</a></em></td></tr>';
					// }

					// $('table[role="popular bookmarks"] tbody').html( $(bookmarkHtml) );
				} else if (type=="shares") {

					var shareHtml = "";
					for ( var i in response ) {
						var share = response[i];
						shareHtml += '<tr><td role="content">('+share[0].count+') '+share[0].content__body+'</td></tr><tr><td role="reactions"><strong>Reactions:</strong>';
						for ( var j in share[1].related_reactions ) {
							var reaction = share[1].related_reactions[j];
							shareHtml += '('+reaction.count+') '+reaction.interaction_node__body;
							if ( j < share[1].related_reactions.length - 1 ) shareHtml += ", ";
						}
						shareHtml += '</td></tr><tr>'; 
						// shareHtml += '<tr><td role="via"><em>View <a href="#" target="_blank">On your site <img src="/static/site/images/external_link_icon.gif" /></a> | <a href="#" target="_blank">Page Info</a></em></td></tr>';
					}

					$('table[role="popular shares"] tbody').html( $(shareHtml) );
				}
				
			}
		});
	},
	mostActive: function( args ) {
		var start = ( args && args.start ) ? args.start : RB.analytics.startDate;
		var end = ( args && args.end ) ? args.end : RB.analytics.endDate;
		var type = ( args && args.type ) ? args.type : "pages";  // users, pages, content
		var max_count = ( args && args.max_count ) ? args.max_count : 20;  // users, pages, content

		var querystring = "?" +
			"start="+start +
			"&end="+end +
			"&max_count="+max_count;

		$.ajax({
			url: '/analytics/group/'+RB.group.short_name+'/'+type+'/active/'+querystring,
			type: "get",
			contentType: "application/json",
			dataType: "jsonp",
			success: function(response){
				if ( type == "pages" ) {
					var pageHtml = "";
					for ( var i in response) {
						var tagCount = (response[i].counts.tag) ? response[i].counts.tag:0;
						var shrCount = (response[i].counts.shr) ? response[i].counts.shr:0;
						var comCount = (response[i].counts.com) ? response[i].counts.com:0;
						pageHtml += '<tr><td role="url"><div><a href="'+response[i].page.canonical_url+'" target="_blank">'+response[i].page.canonical_url+'&nbsp;&nbsp;<img src="/static/site/images/external_link_icon.gif" /></a>&nbsp;&nbsp;</div></td>'
						+'<td role="title"><a href="/page/'+response[i].page.id+'" target="_blank">'+response[i].page.title+'</td>'
						+'<td role="reactions">'+tagCount+'</td>'
						+'<td role="shares">'+shrCount+'</td>'
						+'<td role="comments">'+comCount+'</td></tr>';
					}

					$('table[role="active pages table"] tbody').html( pageHtml );
				} else if ( type == "content" ) {
					var contentHtml = "";
					for ( var i in response) {
						contentHtml += '<tr>'; // TODO add back in:  <td role="via"><div><a href="'+response[i].content.canonical_url+'" target="_blank">'+response[i].content.canonical_url+'&nbsp;&nbsp;<img src="/static/site/images/external_link_icon.gif" /></a>&nbsp;&nbsp;</div></td>'
						if ( response[i].content.kind == "img" ) {
							contentHtml += '<td role="content"><img src="'+response[i].content.body+'" /></td>'
						} else if ( response[i].content.kind == "txt" ) {
							contentHtml += '<td role="content">'+response[i].content.body+'</td>'
						} else if ( response[i].content.kind == "med" ) {
							contentHtml += '<td role="content">[ Video ] <a href="javascript:void(0);" onclick="$(this).next().toggle();">See It</a><div style="display:none;" class="video"><iframe src="'+response[i].content.body+'" width="200" frameborder="0"/></div></td>'
						}
						contentHtml += '<td role="reactions">'+ ( (response[i].counts.tag)?response[i].counts.tag:0 ) +'</td>'
						+'<td role="shares">'+ ( (response[i].counts.shr)?response[i].counts.shr:0 ) +'</td>'
						+'<td role="comments">'+ ( (response[i].counts.com)?response[i].counts.com:0 ) +'</td></tr>';
					}

					$('table[role="active content table"] tbody').html( contentHtml );
					
				} else if ( type == "users" ) {
					var userHtml = "";
					for ( var i in response) {
						if ( response[i].user.img_url ) {
							userHtml += '<tr><td role="avatar"><a href="/user/'+response[i].user.user.id+'" target="_blank"><img src="'+response[i].user.img_url+'" /></a></td><td><a href="/user/'+response[i].user.user.id+'" target="_blank">'+response[i].user.full_name+'</a></td>'
								+ '<td role="reactions">'+ ( (response[i].counts.tag)?response[i].counts.tag:0 ) +'</td>'
								+ '<td role="shares">'+ ( (response[i].counts.shr)?response[i].counts.shr:0 ) +'</td>'
								+ '<td role="comments">'+ ( (response[i].counts.com)?response[i].counts.com:0 ) +'</td>'
							+ '</tr>';
						}
					}
					$('table[role="active user table"] tbody').html( userHtml );
				}
			}
		});
	},
	recentlyActive: function( args ) {
		var start = ( args && args.start ) ? args.start : RB.analytics.startDate;
		var end = ( args && args.end ) ? args.end : RB.analytics.endDate;
		var type = ( args && args.type ) ? args.type : "pages";  // users, pages, content
		var max_count = ( args && args.max_count ) ? args.max_count : 20;  // users, pages, content

		var querystring = "?" +
			"start="+start +
			"&end="+end +
			"&max_count="+max_count;

		$.ajax({
			url: '/analytics/group/'+RB.group.short_name+'/'+type+'/recent/'+querystring,
			type: "get",
			contentType: "application/json",
			dataType: "jsonp",
			success: function(response){
				var recentHtml = "";
				for (var i in response) {
					// recentHtml += '<tr><td><strong>'+response[0].title+'</strong></td></tr><tr>';
					recentHtml += '<tr><td><strong><a href="/page/'+response[0].id+'" target="_blank">'+response[0].title+'</a></strong></td></tr><tr>';
					// TODO make above line link to page profile
				}

				$('table[role="recent pages table"] tbody').html( recentHtml );
			}
		});
	},
	interactionFrequency: function( args ) {
		var start = ( args && args.start ) ? args.start : RB.analytics.startDate;
		var end = ( args && args.end ) ? args.end : RB.analytics.endDate;
		var type = ( args && args.type ) ? args.type : "pages";  // users, pages, content
		var max_count = ( args && args.max_count ) ? args.max_count : 20;  // users, pages, content

		var querystring = "?" +
			"start="+start +
			"&end="+end +
			"&max_count="+max_count;

		$.ajax({
			url: '/analytics/group/'+RB.group.short_name+'/frequency/'+querystring,
			type: "get",
			contentType: "application/json",
			dataType: "jsonp",
			success: function(response){
				var tags = 0,
					shares = 0,
					comments = 0,
					bookmarks = 0;

				for ( var i in response ) {
					for ( var j in response[i]) {
						if ( response[i][j].tag ) tags += response[i][j].tag;
						if ( response[i][j].shr ) shares += response[i][j].shr;
						if ( response[i][j].com ) comments += response[i][j].com;
						if ( response[i][j].bkm ) bookmarks += response[i][j].bkm;
					}
				}

				var total = tags + shares + comments + bookmarks;

				$('div[role="total interactions"] h1').text( total );

				// make chart
				var chart;
				chart = new Highcharts.Chart({
					chart: {
						renderTo: 'frequency_chart',
						defaultSeriesType: 'bar',
						height:'200'
					},
					title: {
						text: 'Interaction Distribution'
					},
					xAxis: {
						labels: {enabled:false}
					},
					yAxis: {
						min: 0,
						title: {text:null}
					},
					legend: {
						backgroundColor: '#FFFFFF',
						reversed: true
					},
					tooltip: {
						formatter: function() {
							return ''+
							this.series.name +': '+ this.y +'';
						}
					},
					plotOptions: {
						series: {
							stacking: 'normal'
						}
					},
					series: [{
					// 	name: 'Bookmarks',
					// 	data: [bookmarks]
					// }, {
						name: 'Comments',
						data: [comments]
					}, {
						name: 'Shares',
						data: [shares]
					}, {
						name: 'Reactions',
						data: [tags]
					}]
				});
			}
		});
	}, 
	updateAll: function() {
		RB.analytics.interactionFrequency();

		RB.analytics.mostPopular();
		RB.analytics.mostPopular( {type:'bookmarks'} );
		RB.analytics.mostPopular( {type:'shares'} );

		RB.analytics.mostActive();
		RB.analytics.mostActive({type:'users'});
		RB.analytics.mostActive({type:'content'});

		RB.analytics.recentlyActive();
	}
};

if ( RB.util.getHashValue('start') ) {
	RB.analytics.startDate = RB.util.getHashValue('start');
} else {
	RB.analytics.startDate = "{% now "m/d/y" %}";
}

if ( RB.util.getHashValue('end') ) {
	RB.analytics.endDate = RB.util.getHashValue('end');
} else {
	RB.analytics.endDate = "{% now "m/d/y" %}";
	// this line is here b/c i suck at python datetime string BS:
	RB.analytics.endDate = RB.analytics.endDate.split('/')[0]+'/'+(parseInt(RB.analytics.endDate.split('/')[1])+1)+'/'+RB.analytics.endDate.split('/')[2];
}

$('input[name="start_date"]').val( RB.analytics.startDate );
$('input[name="end_date"]').val( RB.analytics.endDate );


$('section[role="datepicker"] button').click( function() {
	// get form values
	RB.analytics.startDate = $('input[name="start_date"]').val();
	RB.analytics.endDate = $('input[name="end_date"]').val();

	// update hash, too
	RB.util.setHashValue('start', RB.analytics.startDate );
	RB.util.setHashValue('end', RB.analytics.endDate );

	// re-execute the API calls
	RB.analytics.updateAll();
});


// defined in template
RB.group.short_name = "{{ group.short_name }}";
RB.group.full_name = "{{ group.name }}";

RB.analytics.updateAll();
/* for links:

http://local.readrboard.com:8080/page/3/?s=not+sure

http://local.readrboard.com:8080/group/demo/
http://local.readrboard.com:8080/group/demo/tags/?s=not+sure
http://local.readrboard.com:8080/group/demo/shares/?s=not+sure

http://local.readrboard.com:8080/user/2/

Aanlytics links
Profile stream links (interactions.html)
Sidebar links

Ajaxify the dashboard QS.
*/
</script>



{% endblock mainContent %}













