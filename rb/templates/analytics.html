{% extends "base.html" %}

{% block title %}{{ group.name }} Analytics{%endblock%}

{% block bodyClass %}wide{% endblock %}

{% block extendedHead %}
<script src="{{ STATIC_URL }}global/js/jquery-ui-datepicker.custom.min.js"></script>
<script src="{{ STATIC_URL }}site/js/highcharts/highcharts.js"></script>
<link rel="stylesheet" href="{{ STATIC_URL }}global/css/datepicker_css/ui-lightness/jquery-ui-1.8.15.custom.css">
<style>
    section[role="datepicker"] button {
        position: relative;
        top:-4px;
    }
</style>
{% endblock %}

{% block mainContent %}
<h1>{{ group.name }} Analytics</h1>
<section role="datepicker" class="datepicker">
	<form>
        <label>Date Range: </label>
    	<input type="text" name="start_date" />
    	<label>to</label>
    	<input type="text" name="end_date" />
    	<button class="btn" type="submit" >Update</button>
    </form>
</section>
<section role="panels">

            <div class="parseTest">
            </div>
        
	<div class="section_content">
		<div role="total interactions">
			<h1>0</h1>
			<h4>Interactions</h4>
		</div>
        <div class="reactions" style="width:960px;overflow:hidden;">
        	<h1 style="margin:40px 0 0;text-align:center;width:960x;">Reactions</h1>
        	<div id="tag_cloud_container">
			    <section role="tag cloud grid">
			        <!-- this will get dynamically populated -->
			    </section>
			</div>
        </div>
    </div>
	<section role="wide panels">

		<section role="interaction frequency">
			<div role="frequency chart" id="frequency_chart">
				<h5>frequency chart</h5>
			</div>
		</section> <!-- / interaction frequency -->

		<section role="most active pages">
			<h3>Most Active Pages</h3>
			<table role="active pages table" cellpadding="0" cellspacing="0" border="0">
				<thead>
					<tr>
						<td role="url">URL</td>
						<td role="title">Title</td>
						<td role="reactions">Reactions</td>
						<td role="shares">Shares</td>
						<td role="comments">Comments</td>
					</tr>
				</thead>
				<tbody></tbody>
			</table>
		</section><!-- /most popular tags -->

		<section role="most active content">
			<h3>Most Active Content</h3>
			<table role="active content table" cellpadding="0" cellspacing="0" border="0">
				<thead>
					<tr>
						<!-- <td role="via">via</td> -->
						<td role="content">Content</td>
						<td role="reactions">Reactions</td>
						<td role="shares">Shares</td>
						<td role="comments">Comments</td>
					</tr>
				</thead>
				<tbody></tbody>
			</table>
		</section> <!-- /most active content -->

		<section role="most active readers">
			<h3>Most Active Readers</h3>
			<table role="active user table" cellpadding="0" cellspacing="0" border="0">
				<thead>
					<td colspan="2">Reader</td>
					<td role="reactions"><img src="/static/site/images/blank.png" class="icon" /></td>
					<td role="shares"><img src="/static/site/images/blank.png" class="icon" /></td>
					<td role="comments"><img src="/static/site/images/blank.png" class="icon" /></td>
				</thead>
				<tbody></tbody>
			</table>
		</section> <!-- / most active readers -->

		<section role="recent pages" style="display:none;">
			<h3>Recently Active Pages</h3>
			<table role="recent pages table" cellpadding="0" cellspacing="0" border="0">
				<tbody></tbody>
			</table>
		</section> <!-- / most popular bookmarks -->

		<section role="most popular shares">
			<h3>Popular Shared Content</h3>
			<table role="popular shares" cellpadding="0" cellspacing="0" border="0">
				<tbody></tbody>
			</table>
		</section> <!-- / most popular shares -->

		<!-- 
		<section role="most popular bookmarks">
			<h3>Popular Bookmarked Content</h3>
			<table role="popular bookmarks" cellpadding="0" cellspacing="0" border="0">
				<tbody></tbody>
			</table>
		</section>
		/ most popular bookmarks -->

	</section>
</section>

<script>
(function(){

    $( 'section[role="datepicker"] input' ).datepicker({ dateFormat: 'mm/dd/y' });

    // Radialize the colors
    Highcharts.getOptions().colors = $.map(Highcharts.getOptions().colors, function(color) {
        return {
            radialGradient: { cx: 0.5, cy: 0.3, r: 0.7 },
            stops: [
                [0, color],
                [1, Highcharts.Color(color).brighten(-0.3).get('rgb')] // darken
            ]
        };
    });

    // put in external file...
    RB.analytics = {
        parseData: {},
    	mostPopular: function( args ) {
    		var start = ( args && args.start ) ? args.start : RB.analytics.startDate;
    		var end = ( args && args.end ) ? args.end : RB.analytics.endDate;
    		var type = ( args && args.type ) ? args.type : "tags";  // users, pages, content
    		var max_count = ( args && args.max_count ) ? args.max_count : 20;  // users, pages, content

    		var querystring = "?" +
    			"start="+start +
    			"&end="+end +
    			"&max_count="+max_count;

    		$.ajax({
    			url: '/analytics/group/'+RB.group.short_name+'/'+type+'/popular/'+querystring,
    			type: "get",
    			contentType: "application/json",
    			dataType: "jsonp",
    			success: function(response){
    				if (type == "tags") {
    					$('section[role="tag cloud grid"]').isotope('destroy').html('<section role="tag cloud grid"/>');

    					function SortByTagCount(a,b) { return b.count - a.count; }
    	                var sorted_interactions = [];

    	                $.each( response, function(idx, reaction_data) {
    	                    sorted_interactions.push( { body:reaction_data.interaction_node__body, count:reaction_data.count } );
    	                });

    	                sorted_interactions.sort( SortByTagCount ); // each as a .body and a .count

    	                // do tag cloud logic
    	                // render the tag cloud
    	                // medium, small, small, big
    	                var boxSizes = [ "medium", "small", "small", "big" ],
    	                    currentBoxSize = 0,
    	                    colorInt = 1,
    	                    $tagCloud = $('section[role="tag cloud grid"]');

    	                $tagCloud.html('').removeAttr('style').removeClass('isotope');
    	                while ( sorted_interactions.length ) {
    	                    if ( boxSizes[ currentBoxSize ] == "medium" ) {
    	                        var median = Math.floor(sorted_interactions.length/2);
    	                        var $thisBox = $( '<a href="/?s='+sorted_interactions[ median ].body+'"><div class="color'+colorInt+' box2 box"><div class="tag">'+sorted_interactions[ median ].body+'<br/><span class="count">'+sorted_interactions[ median ].count+'</span></div></div></a>' );
    	                        $tagCloud.append( $thisBox );
    	                        sorted_interactions.splice( median, 1 );
    	                    } else if ( boxSizes[ currentBoxSize ] == "small" ) {
    	                        var thisTag = sorted_interactions.pop(),
    	                            $thisBox = $( '<a href="/?s='+thisTag.body+'"><div class="color'+colorInt+' box3 box"><div class="tag">'+thisTag.body+'<br/><span class="count">'+thisTag.count+'</span></div></div></a>' );
    	                        $tagCloud.append( $thisBox );
    	                    } else if ( boxSizes[ currentBoxSize ] == "big" ) {
    	                        var thisTag = sorted_interactions.shift(),
    	                            $thisBox = $( '<a href="/?s='+thisTag.body+'"><div class="color'+colorInt+' box1 box"><div class="tag">'+thisTag.body+'<br/><span class="count">'+thisTag.count+'</span></div></div></a>' );
    	                        $tagCloud.append( $thisBox );
    	                    }
    	                    
    	                    // set next color and box size
    	                    colorInt++;
    	                    currentBoxSize++;
    	                    if ( colorInt == 6 ) colorInt = 1;
    	                    if ( currentBoxSize == 4 ) currentBoxSize = 0;
    	                }

    	                // isotope and bigtext the cloud
    	                $('section[role="tag cloud grid"]').isotope({
    	                  layoutMode: 'masonryHorizontal',
    	                  masonryHorizontal: {
    	                    rowHeight: 70
    	                  }
    	                }, function() {
    	                    $('.box').bigtext();
    	                    var tagBoxesCount = $('section[role="tag cloud grid"] a').length,
    	                        currentTagBoxAnimating = 0;
    	                    var animationQueue = setInterval( animateNextBox, 100 );

    	                    function animateNextBox() {
    	                        var $thisBox = $('section[role="tag cloud grid"] a:eq('+currentTagBoxAnimating+') .box');
    	                        if ( $thisBox.hasClass('box1') ) {
    	                            $thisBox.find('div.tag').animate( {bottom:'0%'}, { queue:false, duration: 333 } );
    	                        } else {
    	                            $thisBox.find('div.tag').animate( {top:'0%'}, { queue:false, duration: 333 } );
    	                        }
    	                        currentTagBoxAnimating++;
    	                        if ( currentTagBoxAnimating > tagBoxesCount ) {
    	                            clearInterval( animationQueue );
    	                        	if ( $('#tag_cloud_container').jScrollPane().data().jsp ) { $('#tag_cloud_container').jScrollPane().data().jsp.destroy(); }
    	                            initHorizontalScrollbar();
    	                        }
    	                    }
    	                    function initHorizontalScrollbar(){
    	                        $('#tag_cloud_container').jScrollPane();
    	                    }
    	                });
    				} else if (type=="shares") {

    					var shareHtml = "";
    					for ( var i in response ) {
    						var share = response[i];
    						shareHtml += '<tr><td role="content">('+share[0].count+') '+share[0].content__body+'</td></tr><tr><td role="reactions"><strong>Reactions:</strong>';
    						for ( var j in share[1].related_reactions ) {
    							var reaction = share[1].related_reactions[j];
    							shareHtml += '('+reaction.count+') '+reaction.interaction_node__body;
    							if ( j < share[1].related_reactions.length - 1 ) shareHtml += ", ";
    						}
    						shareHtml += '</td></tr><tr>'; 
    						// shareHtml += '<tr><td role="via"><em>View <a href="#" target="_blank">On your site <img src="/static/site/images/external_link_icon.gif" /></a> | <a href="#" target="_blank">Page Info</a></em></td></tr>';
    					}

    					$('table[role="popular shares"] tbody').html( $(shareHtml) );
    				}
    				
    			}
    		});
    	},
    	mostActive: function( args ) {
    		var start = ( args && args.start ) ? args.start : RB.analytics.startDate;
    		var end = ( args && args.end ) ? args.end : RB.analytics.endDate;
    		var type = ( args && args.type ) ? args.type : "pages";  // users, pages, content
    		var max_count = ( args && args.max_count ) ? args.max_count : 20;  // users, pages, content

    		var querystring = "?" +
    			"start="+start +
    			"&end="+end +
    			"&max_count="+max_count;

    		$.ajax({
    			url: '/analytics/group/'+RB.group.short_name+'/'+type+'/active/'+querystring,
    			type: "get",
    			contentType: "application/json",
    			dataType: "jsonp",
    			success: function(response){
    				if ( type == "pages" ) {
    					var pageHtml = "";
    					for ( var i in response) {
    						var tagCount = (response[i].counts.tag) ? response[i].counts.tag:0;
    						var shrCount = (response[i].counts.shr) ? response[i].counts.shr:0;
    						var comCount = (response[i].counts.com) ? response[i].counts.com:0;
    						pageHtml += '<tr><td role="url"><div><a href="'+response[i].page.canonical_url+'" target="_blank">'+response[i].page.canonical_url+'&nbsp;&nbsp;<img src="/static/site/images/external_link_icon.gif" /></a>&nbsp;&nbsp;</div></td>'
    						+'<td role="title"><a href="/page/'+response[i].page.id+'" target="_blank">'+response[i].page.title+'</td>'
    						+'<td role="reactions">'+tagCount+'</td>'
    						+'<td role="shares">'+shrCount+'</td>'
    						+'<td role="comments">'+comCount+'</td></tr>';
    					}

    					$('table[role="active pages table"] tbody').html( pageHtml );
    				} else if ( type == "content" ) {
    					var contentHtml = "";
    					for ( var i in response) {
    						contentHtml += '<tr>'; // TODO add back in:  <td role="via"><div><a href="'+response[i].content.canonical_url+'" target="_blank">'+response[i].content.canonical_url+'&nbsp;&nbsp;<img src="/static/site/images/external_link_icon.gif" /></a>&nbsp;&nbsp;</div></td>'
    						if ( response[i].content.kind == "img" ) {
    							contentHtml += '<td role="content"><img src="'+response[i].content.body+'" /></td>'
    						} else if ( response[i].content.kind == "txt" ) {
    							contentHtml += '<td role="content">'+response[i].content.body+'</td>'
    						} else if ( response[i].content.kind == "med" ) {
    							contentHtml += '<td role="content">[ Video ] <a href="javascript:void(0);" onclick="$(this).next().toggle();">See It</a><div style="display:none;" class="video"><iframe src="'+response[i].content.body+'" width="200" frameborder="0"/></div></td>'
    						}
    						contentHtml += '<td role="reactions">'+ ( (response[i].counts.tag)?response[i].counts.tag:0 ) +'</td>'
    						+'<td role="shares">'+ ( (response[i].counts.shr)?response[i].counts.shr:0 ) +'</td>'
    						+'<td role="comments">'+ ( (response[i].counts.com)?response[i].counts.com:0 ) +'</td></tr>';
    					}

    					$('table[role="active content table"] tbody').html( contentHtml );
    					
    				} else if ( type == "users" ) {
    					var userHtml = "";
    					for ( var i in response) {
    						if ( response[i].user.img_url ) {
    							userHtml += '<tr><td role="avatar"><a href="/user/'+response[i].user.user_id+'" target="_blank"><img src="'+response[i].user.img_url+'" /></a></td><td><a href="/user/'+response[i].user.user_id+'" target="_blank">'+response[i].user.full_name+'</a></td>'
    								+ '<td role="reactions">'+ ( (response[i].counts.tag)?response[i].counts.tag:0 ) +'</td>'
    								+ '<td role="shares">'+ ( (response[i].counts.shr)?response[i].counts.shr:0 ) +'</td>'
    								+ '<td role="comments">'+ ( (response[i].counts.com)?response[i].counts.com:0 ) +'</td>'
    							+ '</tr>';
    						}
    					}
    					$('table[role="active user table"] tbody').html( userHtml );
    				}
    			}
    		});
    	},
    	recentlyActive: function( args ) {
    		var start = ( args && args.start ) ? args.start : RB.analytics.startDate;
    		var end = ( args && args.end ) ? args.end : RB.analytics.endDate;
    		var type = ( args && args.type ) ? args.type : "pages";  // users, pages, content
    		var max_count = ( args && args.max_count ) ? args.max_count : 20;  // users, pages, content

    		var querystring = "?" +
    			"start="+start +
    			"&end="+end +
    			"&max_count="+max_count;

    		$.ajax({
    			url: '/analytics/group/'+RB.group.short_name+'/'+type+'/recent/'+querystring,
    			type: "get",
    			contentType: "application/json",
    			dataType: "jsonp",
    			success: function(response){
    				var recentHtml = "";
    				for (var i in response) {
    					// recentHtml += '<tr><td><strong>'+response[0].title+'</strong></td></tr><tr>';
    					recentHtml += '<tr><td><strong><a href="/page/'+response[0].id+'" target="_blank">'+response[0].title+'</a></strong></td></tr><tr>';
    					// TODO make above line link to page profile
    				}

    				$('table[role="recent pages table"] tbody').html( recentHtml );
    			}
    		});
    	},
        initParse: function(){

            if( typeof Parse === "undefined" ){
                return;
            }
            debugger;
            //todo: temp 
            var parseTrackingRepo = RB.RDR_offline ? "EventTracking_Dev" : "EventTracking";
            // var parseTrackingRepo = "EventTracking";

            var ParseTracker = Parse.Object.extend(parseTrackingRepo);

            getAllData(ParseTracker, {
                success: function(results) {
                    // debugger;
                    var res = $.toJSON(results);
                    $('.parseTest').html(res);
                    // alert("Successfully retrieved " + results.length + " scores.");
                },
                error: function(error) {
                    alert("Error: " + error.code + " " + error.message);
                }
            });

            // RB.analytics.parseData

            function getAllData(Table, callbacks){
                var query = new Parse.Query(Table);
                query.greaterThanOrEqualTo("createdAt", RB.analytics.jsStartDate);
                query.lessThanOrEqualTo("createdAt", RB.analytics.jsEndDate);
                query.equalTo("group_id", RB.group.id);
                query.limit(30);
                query.find(callbacks);
            }

        },
    	interactionFrequency: function( args ) {
    		var start = ( args && args.start ) ? args.start : RB.analytics.startDate;
    		var end = ( args && args.end ) ? args.end : RB.analytics.endDate;
    		var type = ( args && args.type ) ? args.type : "pages";  // users, pages, content
    		var max_count = ( args && args.max_count ) ? args.max_count : 20;  // users, pages, content

    		var querystring = "?" +
    			"start="+start +
    			"&end="+end +
    			"&max_count="+max_count;

    		$.ajax({
    			url: '/analytics/group/'+RB.group.short_name+'/frequency/'+querystring,
    			type: "get",
    			contentType: "application/json",
    			dataType: "jsonp",
    			success: function(response){
    				var tags = 0,
    					shares = 0,
    					comments = 0,
    					bookmarks = 0;

    				for ( var i in response ) {
    					for ( var j in response[i]) {
    						if ( response[i][j].tag ) tags += response[i][j].tag;
    						if ( response[i][j].shr ) shares += response[i][j].shr;
    						if ( response[i][j].com ) comments += response[i][j].com;
    						if ( response[i][j].bkm ) bookmarks += response[i][j].bkm;
    					}
    				}

    				var total = tags + shares + comments + bookmarks;

    				$('div[role="total interactions"] h1').text( total );

    				// make chart
    				// keep this chart for now
    				var chart;
    				chart = new Highcharts.Chart({
    					chart: {
    						renderTo: 'frequency_chart',
    						defaultSeriesType: 'bar',
    						height:'200'
    					},
    					title: {
    						text: 'Interaction Distribution'
    					},
    					xAxis: {
    						labels: {enabled:false}
    					},
    					yAxis: {
    						min: 0,
    						title: {text:null}
    					},
    					legend: {
    						backgroundColor: '#FFFFFF',
    						reversed: true
    					},
    					tooltip: {
    						formatter: function() {
    							return ''+
    							this.series.name +': '+ this.y +'';
    						}
    					},
    					plotOptions: {
    						series: {
    							stacking: 'normal'
    						}
    					},
    					series: [{
    					// 	name: 'Bookmarks',
    					// 	data: [bookmarks]
    					// }, {
    						name: 'Comments',
    						data: [comments]
    					}, {
    						name: 'Shares',
    						data: [shares]
    					}, {
    						name: 'Reactions',
    						data: [tags]
    					}]
    				});
    			}
    		});
    	}, 
    	updateAll: function() {
    		RB.analytics.interactionFrequency();

    		RB.analytics.mostPopular();
    		RB.analytics.mostPopular( {type:'bookmarks'} );
    		RB.analytics.mostPopular( {type:'shares'} );

    		RB.analytics.mostActive();
    		RB.analytics.mostActive({type:'users'});
    		RB.analytics.mostActive({type:'content'});

    		RB.analytics.recentlyActive();

            RB.analytics.initParse();
    	}
    };


    var nowDate = moment().format("MM/DD/YY");
    RB.analytics.startDate = RB.util.getHashValue('start') || nowDate;
    RB.analytics.endDate = RB.util.getHashValue('end') || moment().add('days',1).format("MM/DD/YY");

    RB.analytics.jsStartDate = RB.analytics.startDate ? new Date(RB.analytics.startDate) : new Date();
    RB.analytics.jsEndDate = RB.analytics.endDate ? new Date(RB.analytics.endDate) : new Date();

    $('input[name="start_date"]').val( RB.analytics.startDate );
    $('input[name="end_date"]').val( RB.analytics.endDate );

    $('section[role="datepicker"] form').submit( function() {
    	// get form values
    	RB.analytics.startDate = $('input[name="start_date"]').val();
    	RB.analytics.endDate = $('input[name="end_date"]').val();

    	// update hash, too
    	RB.util.setHashValue('start', RB.analytics.startDate );
    	RB.util.setHashValue('end', RB.analytics.endDate );

    	// re-execute the API calls
    	RB.analytics.updateAll();
        return false;
    });


    // defined in template
    RB.group.short_name = "{{ group.short_name }}";
    RB.group.full_name = "{{ group.name }}";

    $(function(){
        
        RB.analytics.updateAll();

    });

    /* for links:

    http://local.readrboard.com:8080/page/3/?s=not+sure

    http://local.readrboard.com:8080/group/demo/
    http://local.readrboard.com:8080/group/demo/tags/?s=not+sure
    http://local.readrboard.com:8080/group/demo/shares/?s=not+sure

    http://local.readrboard.com:8080/user/2/

    Aanlytics links
    Profile stream links (interactions.html)
    Sidebar links

    Ajaxify the dashboard QS.
    */

})();
</script>



{% endblock mainContent %}













