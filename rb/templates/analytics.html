{% extends "wide_base.html" %}

{% block mainContent %}

<style>
	section[role="analytics header"] 			{ width:100%; background:#7f7f7f; color:#eee; overflow:auto; box-shadow:0px -10px 9px -9px #454545 inset; }
	section[role="analytics header"] h3			{ float:left; overflow:auto; padding:10px; margin:0; font-size:16px; background: none repeat scroll 0 0 #638296; box-shadow: 0 -10px 9px -9px #454545 inset; }

	section[role="controls"] 		{ padding:10px; font-size:12px; float:left; border-left:1px solid #ddd; text-shadow:1px 1px 2px #454545;}
	section[role="controls"] input	{ width:80px; text-align:center; margin:o 3px; }
</style>

<section role="analytics header">
	<h3>{{ group.name }} Activity</h3>
	<section role="controls">
		<label>Date Range: </label>
		<input type="text" name="start_date" />
		<label>to</label>
		<input type="text" name="end_date" />
		<button>Update</button>
	</section>
</section>

<style>
	section[role="panels"] 					{ float:left; overflow:auto; padding:10px; }

	section[role="wide panels"] 			{ float:left; padding:0 10px 10px; width: 740px; }
	section[role="wide panels"] section		{ margin-bottom:20px; }
	section[role="wide panels"] h3 			{ font-family:'ReadrLeague'; font-size:30px; margin:0; border-top:1px solid #aaa; padding:7px 0; }
	section[role="wide panels"] h4 			{ font-family:'ReadrLeague'; font-size:24px; margin:0; }

	section[role="interaction frequency"] 				{ overflow:auto; text-align:center; }
	section[role="interaction frequency"] h1			{ font-family:'ReadrLeague'; font-size:80px; text-shadow: 1px 2px 1px #fff; padding:0; margin:0; color:#638296; }
	div[role="total interactions"]						{ width:130px; float:left; overflow:auto; }
	div[role="frequency chart"]							{ width:610px; margin-left:130px; background:#aaa; color:#ddd; box-shadow:0px -10px 9px -9px #454545 inset; min-height:100px; padding-top:40px; }

	section[role="most popular tags"] ol				{ margin:0; padding:0; overflow:auto; list-style-type:none;}
	section[role="most popular tags"] ol li				{ margin:0 10px 0 0; display:inline-block; padding-right:25px; }
	section[role="most popular tags"] ol li.large		{ font-size:24px; }
	section[role="most popular tags"] ol li.medium		{ font-size:16px; }
	section[role="most popular tags"] ol li.small		{ font-size:12px; }

	section[role="thin panels"] 			{ float:left; padding:0 10px 10px; width:320px; font-size:12px; }
	section[role="thin panels"] h3 			{ font-family:'ReadrLeague'; font-size:24px; margin-bottom:0; border-top:1px solid #aaa; padding:7px 0; }
</style>

<section role="panels">
	<section role="wide panels">
		
		<section role="interaction frequency">
			<div role="total interactions">
				<h1>1,100</h1>
				<h4>Interactions</h4>
			</div>
			<div role="frequency chart">
				<h5>frequency chart</h5>
			</div>
		</section> <!-- / interaction frequency -->

		<section role="most popular tags">
			<h3>Most Popular Tags</h3>
			<ol></ol>
		</section> <!-- /most popular tags -->

<style>
	table[role="active content table"] thead td,
	table[role="active pages table"] thead td						{ font-weight:bold;}

	table[role="active content table"] tr:hover,
	table[role="active pages table"] tr:hover						{ background:#d8e8f6;}

	table[role="active content table"] td,
	table[role="active pages table"] td								{ vertical-align:top; font-size:12px; }

	table[role="active content table"] td[role="via"],
	table[role="active pages table"] td[role="url"]					{ width:130px; overflow:visible;}

	table[role="active content table"] td[role="via"] div,
	table[role="active pages table"] td[role="url"]	div				{ width:120px; overflow:hidden; white-space:nowrap; border:1px solid #fff; }

	table[role="active content table"] td[role="via"] div a,
	table[role="active pages table"] td[role="url"]	div	a			{ text-decoration:none; color:#666; }

	table[role="active content table"] td[role="via"] div a img,
	table[role="active pages table"] td[role="url"]	div	a img		{ display:none; }
	
	table[role="active content table"] td[role="via"] div:hover,
	table[role="active pages table"] td[role="url"]	div:hover		{ width:auto; background:#ddd; border:1px solid #999; position:absolute; }
	
	table[role="active content table"] td[role="via"] div:hover a,
	table[role="active pages table"] td[role="url"]	div:hover a		{ text-decoration:underline; color:#1777af; }
	
	table[role="active content table"] td[role="via"] div:hover a img,
	table[role="active pages table"] td[role="url"]	div:hover a	img	{ display:inline; }
	
	table[role="active content table"] tbody td[role="content"]		{ font-size:14px; font-weight:bold; width:515px;}
	table[role="active content table"] tbody td[role="content"] img	{ max-width:80px; max-height:80px; }
	table[role="active pages table"] tbody td[role="title"]			{ font-style:italic; }
	
	table[role="active content table"] td[role="reactions"],
	table[role="active pages table"] td[role="reactions"]			{ width:90px; text-align:center; color:; }
	
	table[role="active content table"] td[role="shares"],
	table[role="active pages table"] td[role="shares"]				{ width:90px; text-align:center; color:; }
	
	table[role="active content table"] td[role="comments"],
	table[role="active pages table"] td[role="comments"]			{ width:90px; text-align:center; color:; }
</style>

		<section role="most active pages">
			<h3>Most Active Pages</h3>
			<table role="active pages table" cellpadding="0" cellspacing="0" border="0">
				<thead>
					<tr>
						<td role="url">URL</td>
						<td role="title">Title</td>
						<td role="reactions"><img src="/static/site/images/blank.png" class="icon" /> Reactions</td>
						<td role="shares"><img src="/static/site/images/blank.png" class="icon" /> Shares</td>
						<td role="comments"><img src="/static/site/images/blank.png" class="icon" /> Comments</td>
					</tr>
				</thead>
				<tbody></tbody>
			</table>
		</section><!-- /most popular tags -->

		<section role="most active content">
			<h3>Most Active Content</h3>
			<table role="active content table" cellpadding="0" cellspacing="0" border="0">
				<thead>
					<tr>
						<!-- <td role="via">via</td> -->
						<td role="content">Content</td>
						<td role="reactions"><img src="/static/site/images/blank.png" class="icon" /> Reactions</td>
						<td role="shares"><img src="/static/site/images/blank.png" class="icon" /> Shares</td>
						<td role="comments"><img src="/static/site/images/blank.png" class="icon" /> Comments</td>
					</tr>
				</thead>
				<tbody></tbody>
			</table>
		</section> <!-- /most active content -->

	</section> <!-- / wide panels -->
<style>
	table[role="active user table"] thead td				{ font-weight:bold; }
	table[role="active user table"] td 						{ vertical-align:middle; font-size:12px; }
	table[role="active user table"] td[role="avatar"]		{ width:35px; text-align:left;}
	table[role="active user table"] td[role="avatar"] img	{ width:25px; }
	
	table[role="active user table"] td[role="reactions"],
	table[role="active user table"] td[role="shares"],
	table[role="active user table"] td[role="comments"]		{ text-align:center; width:30px; }

	td[role="reactions"] img.icon	{ background:url(/static/widget/images/readr_icons.png) 0px 0px no-repeat transparent; width:16px; margin:0 3px -4px;}
	td[role="shares"] img.icon		{ background:url(/static/widget/images/readr_icons.png) -50px 0px no-repeat transparent; width:16px; margin:0 3px -4px;}
	td[role="comments"] img.icon	{ background:url(/static/widget/images/readr_icons.png) -24px 0px no-repeat transparent; width:16px; margin:0 3px -4px;}
	
	section[role="thin panels"] section[role="most active readers"] h3	{ border-top:0; }
</style>
	<section role="thin panels">
		<section role="most active readers">
			<h3>Most Active Readers</h3>
			<table role="active user table" cellpadding="0" cellspacing="0" border="0">
				<thead>
					<td colspan="2">Reader</td>
					<td role="reactions"><img src="/static/site/images/blank.png" class="icon" /></td>
					<td role="shares"><img src="/static/site/images/blank.png" class="icon" /></td>
					<td role="comments"><img src="/static/site/images/blank.png" class="icon" /></td>
				</thead>
				<tbody></tbody>
			</table>
		</section> <!-- / most active readers -->

<style>
	table[role="recent pages table"] td 						{ vertical-align:middle; }
	table[role="recent pages table"] td[role="via"]			{ padding-bottom:10px;}
</style>

		<section role="recent pages">
			<h3>Recently Interacted Pages</h3>
			<table role="recent pages table" cellpadding="0" cellspacing="0" border="0">
				<tbody></tbody>
			</table>
		</section> <!-- / most popular bookmarks -->

<style>
	table[role="popular shares"] td 					{ vertical-align:middle; }
	table[role="popular shares"] td[role="content"]		{ font-size:14px;}
	table[role="popular shares"] td[role="reactions"]	{ padding:0 0 10px 23px; }
	table[role="popular shares"] td[role="via"]			{ padding-bottom:10px;}
	table[role="popular bookmarks"] td 						{ vertical-align:middle; }
	table[role="popular bookmarks"] td[role="content"]			{ font-size:14px;}
	table[role="popular bookmarks"] td[role="reactions"]	{ padding:0 0 10px 23px; }
	table[role="popular bookmarks"] td[role="via"]			{ padding-bottom:10px;}
</style>

		<section role="most popular shares">
			<h3>Popular Shared Content</h3>
			<table role="popular shares" cellpadding="0" cellspacing="0" border="0">
				<tbody></tbody>
			</table>
		</section> <!-- / most popular shares -->

		<section role="most popular bookmarks">
			<h3>Popular Bookmarked Content</h3>
			<table role="popular bookmarks" cellpadding="0" cellspacing="0" border="0">
				<tbody></tbody>
			</table>
		</section> <!-- / most popular bookmarks -->

	</section>
</section>

<script>
$( 'section[role="controls"] input' ).datepicker({ dateFormat: 'mm/dd/y' });

// put in external file...
RB.analytics = {
	defaultStart: "08/14/11", //TODO make this "today"
	defaultEnd: "08/15/11", //TODO make this "today"

	mostPopular: function( type, start, end ) {
		if ( !start ) start = RB.analytics.defaultStart;
		if ( !end ) end = RB.analytics.defaultEnd;
		if ( !type ) type = "tags";

		$.ajax({
			url: '/analytics/group/'+RB.group.short_name+'/'+type+'/popular/',
			type: "get",
			contentType: "application/json",
			dataType: "jsonp",
			success: function(response){
				if (type == "tags") {
					var tag_list = "";
					for ( var i in response ) {
						var sizeClass = ( response[i].count > 7 ) ? "large" : (response[i].count > 4 ) ? "medium" : "small";
						tag_list += '<li class="'+sizeClass+'"><a href="#">('+response[i].count+') '+response[i].interaction_node__body+'</a></li>';
					}
					$('section[role="most popular tags"] ol').html( $(tag_list) );
				} else if (type=="bookmarks") {

					var bookmarkHtml = "";
					for ( var i in response ) {
						var bookmark = response[i];
						bookmarkHtml += '<tr><td role="content">('+bookmark[0].count+') '+bookmark[0].content__body+'</td></tr><tr><td role="reactions"><strong>Reactions:</strong>';
						for ( var j in bookmark[1].related_reactions ) {
							var reaction = bookmark[1].related_reactions[j];
							bookmarkHtml += '('+reaction.count+') '+reaction.interaction_node__body;
							if ( j < bookmark[1].related_reactions.length - 1 ) bookmarkHtml += ", ";
						}
						bookmarkHtml += '</td></tr><tr>'; 
						// TODO bookmarkHtml += '<td role="via"><em>via <a href="#" target="_blank">www.dailycandy.com/some-article</a></em></td></tr>';
					}

					$('table[role="popular bookmarks"] tbody').html( $(bookmarkHtml) );
				} else if (type=="shares") {

					var shareHtml = "";
					for ( var i in response ) {
						var share = response[i];
						shareHtml += '<tr><td role="content">('+share[0].count+') '+share[0].content__body+'</td></tr><tr><td role="reactions"><strong>Reactions:</strong>';
						for ( var j in share[1].related_reactions ) {
							var reaction = share[1].related_reactions[j];
							shareHtml += '('+reaction.count+') '+reaction.interaction_node__body;
							if ( j < share[1].related_reactions.length - 1 ) shareHtml += ", ";
						}
						shareHtml += '</td></tr><tr>'; 
						// TODO shareHtml += '<td role="via"><em>via <a href="#" target="_blank">www.dailycandy.com/some-article</a></em></td></tr>';
					}

					$('table[role="popular shares"] tbody').html( $(shareHtml) );
				}
				
			}
		});
	},
	mostActive: function( type, start, end ) {
		if ( !start ) start = RB.analytics.defaultStart;
		if ( !end ) end = RB.analytics.defaultEnd;
		if ( !type ) type = "pages";  // users, pages, content

		$.ajax({
			url: '/analytics/group/'+RB.group.short_name+'/'+type+'/active/',
			type: "get",
			contentType: "application/json",
			dataType: "jsonp",
			success: function(response){
				
				if ( type == "pages" ) {
					var pageHtml = "";
					
					for ( var i in response) {
						pageHtml += '<tr><td role="url"><div><a href="'+response[i].page.canonical_url+'" target="_blank">'+response[i].page.canonical_url+'&nbsp;&nbsp;<img src="/static/site/images/external_link_icon.gif" /></a>&nbsp;&nbsp;</div></td>'
						+'<td role="title">'+response[i].page.title+'</td>'
						+'<td role="reactions">'+response[i].counts.tag+'</td>'
						+'<td role="shares">'+response[i].counts.shr+'</td>'
						+'<td role="comments">'+response[i].counts.com+'</td></tr>';
					}

					$('table[role="active pages table"] tbody').html( pageHtml );
				} else if ( type == "content" ) {
					var contentHtml = "";
					
					for ( var i in response) {
						contentHtml += '<tr>'; // TODO add back in:  <td role="via"><div><a href="'+response[i].content.canonical_url+'" target="_blank">'+response[i].content.canonical_url+'&nbsp;&nbsp;<img src="/static/site/images/external_link_icon.gif" /></a>&nbsp;&nbsp;</div></td>'
						if ( response[i].content.kind == "img" ) {
							contentHtml += '<td role="content"><img src="'+response[i].content.body+'" /></td>'
						} else if ( response[i].content.kind == "txt" ) {
							contentHtml += '<td role="content">'+response[i].content.body+'</td>'
						}
						contentHtml += '<td role="reactions">'+ ( (response[i].counts.tag)?response[i].counts.tag:0 ) +'</td>'
						+'<td role="shares">'+ ( (response[i].counts.shr)?response[i].counts.shr:0 ) +'</td>'
						+'<td role="comments">'+ ( (response[i].counts.com)?response[i].counts.com:0 ) +'</td></tr>';
					}

					$('table[role="active content table"] tbody').html( contentHtml );
					
				} else if ( type == "users" ) {
					
					var userHtml = "";
					for ( var i in response) {
						if ( response[i].user.img_url ) {
							userHtml += '<tr><td role="avatar"><img src="'+response[i].user.img_url+'" /></td><td>'+response[i].user.full_name+'</td>'
								+ '<td role="reactions">'+ ( (response[i].counts.tag)?response[i].counts.tag:0 ) +'</td>'
								+ '<td role="shares">'+ ( (response[i].counts.shr)?response[i].counts.shr:0 ) +'</td>'
								+ '<td role="comments">'+ ( (response[i].counts.com)?response[i].counts.com:0 ) +'</td>'
							+ '</tr>';
						}
					}
					$('table[role="active user table"] tbody').html( userHtml );
				}
			}
		});
	},
	recentlyActive: function( type, start, end ) {
		if ( !start ) start = RB.analytics.defaultStart;
		if ( !end ) end = RB.analytics.defaultEnd;
		if ( !type ) type = "pages";  // users, pages, content

		$.ajax({
			url: '/analytics/group/'+RB.group.short_name+'/'+type+'/recent/',
			type: "get",
			contentType: "application/json",
			dataType: "jsonp",
			success: function(response){
				console.dir(response);

				var recentHtml = "";
				for (var i in response) {
					recentHtml += '<tr><td><strong><a href="'+response[0].id+'">'+response[0].title+'</a></strong></td></tr><tr>';
					// TODO make above line link to page profile
				}

				$('table[role="recent pages table"] tbody').html( recentHtml );
			}
		});
	},
	interactionFrequency: function( type, start, end ) {
		if ( !start ) start = RB.analytics.defaultStart;
		if ( !end ) end = RB.analytics.defaultEnd;
		if ( !type ) type = "pages";  // users, pages, content

		$.ajax({
			url: '/analytics/group/'+RB.group.short_name+'/frequency/',
			type: "get",
			contentType: "application/json",
			dataType: "jsonp",
			success: function(response){
				var tags = 0,
					shares = 0,
					comments = 0,
					bookmarks = 0;
				console.log('interactionFrequency');
				console.dir(response);
				for ( var i in response ) {
					for ( var j in response[i]) {
						if ( response[i][j].tag ) tags += response[i][j].tag;
						if ( response[i][j].shr ) shares += response[i][j].shr;
						if ( response[i][j].com ) comments += response[i][j].com;
						if ( response[i][j].bkm ) bookmarks += response[i][j].bkm;
					}
				}

				var total = tags + shares + comments + bookmarks;
console.log( total );
				$('div[role="total interactions"] h1').text( total );
			}
		});
	}
};

// defined in template
RB.group.short_name = "{{ group.short_name }}";
RB.group.full_name = "{{ group.name }}";

RB.analytics.interactionFrequency();

RB.analytics.mostPopular();
RB.analytics.mostPopular('bookmarks');
RB.analytics.mostPopular('shares');

RB.analytics.mostActive();
RB.analytics.mostActive('users');
RB.analytics.mostActive('content');

RB.analytics.recentlyActive();
</script>



{% endblock mainContent %}













