<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en-US" xmlns:x2="http://www.w3.org/2002/06/xhtml2" xmlns:fb="http://www.facebook.com/2008/fbml">
   <head>
     <title>Log In to ReadrBoard</title>
	<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.5.1/jquery.min.js" type="text/javascript"></script>
	<script src="/static/js/jquery.ba-postmessage.min.js" type="text/javascript"></script>
	<script src="/static/js/jquery.cookie.js" type="text/javascript"></script>
	<style type="text/css">
	img		{ border:0; }
	</style>
   </head>
   <body>
     <div id="fb-root"></div>
	<div id="fb-login-button" style="display:none;">
		<a href="javascript:void(0);" onclick="RDRAuth.doFBLogin();"><img src="/static/images/fb-login_to_readrboard.png" /></a>
	</div>
	<div id="fb-logged-in" style="display:none;">
		<a href="javascript:void(0);" onclick="FB.logout( RDRAuth.doFBlogout );">Log out</a>
		<br/><br/>
		<a href="javascript:void(0);" onclick="RDRAuth.getReadrToken();">Send Facebook Response again</a>
	</div>
	<a href="javascript:void(0);" onclick="RDRAuth.postMessageTest();">test postMessage</a>
     <script src="http://connect.facebook.net/en_US/all.js"></script>
     <script>
		// querystring stuff
		// TODO get the parentURL and use it in the postMessage call
		var qs = window.location.search.substr(1).split('&');
		var qs_args = [];
		for ( var i in qs ) {
			var this_arg = qs[i].split('=');
			qs_args[this_arg[0]] = this_arg[1];
		}
		
		FB.init({ 
			appId:'{{ fb_client_id }}', cookie:true, 
			status:true, xfbml:true 
		});
		
		var RDRAuth = RDRAuth ? RDRAuth : {};
		RDRAuth = {
			fb_response: {},
			rdr_user: {},
			postMessage: function(params) {
				$.postMessage(
					params.message,
					qs_args.parentUrl,
					parent
				);	
			},
			getReadrToken: function() {
				if ( RDRAuth.fb_response && RDRAuth.fb_response.status == "connected" ) {
					var sendData = {
						fb: RDRAuth.fb_response,
						group_id: qs_args.group_id
					};
					$.ajax({
						url: "/api/fb/",
						type: "get",
						contentType: "application/json",
						dataType: "jsonp",
						data: {
							json: JSON.stringify( sendData )
						},
						success: function(response){
							console.dir( response );
							RDRAuth.rdr_user = response;
							// TODO send this info up to the widget!
						}
					});
				} else {
					RDRAuth.doFBLogin();
				}
			},
			doFBLogin: function() {
				FB.login( function(response) {
					if (response.session) {
						//user is logged in
						$('#fb-logged-in').show();
						$('#fb-login-button').hide();
						RDRAuth.fb_response = response;
						RDRAuth.getReadrToken();
					
					} else {
						// user is not logged in
						// TODO do something.  post to parent that there was a bug logging in to FB
	 				}
				}, {perms:'email'});
			},		
			doFBlogout: function() {
				window.location.reload();
			},
			
		}

		FB.getLoginStatus(function(response) {
	  		if (response.session) {
				//user is logged in
				$('#fb-logged-in').show();
				$('#fb-login-button').hide();
				console.dir(response);
				RDRAuth.fb_response = response;
				RDRAuth.getReadrToken();
	  		} else {
				$('#fb-logged-in').hide();
				$('#fb-login-button').show();
	  		}
		});
	</script>
   </body>
</html>