<section>
<script>
var comments = [],
    interactions = [];

{% regroup current_page.object_list by page as pi %}
{% for page in pi %}
{% for interaction in page.list %}
{% if interaction.kind != 'com' and interaction.human_kind != 'Share' %}
var interaction = {
      "id"    :   {{ interaction.id }},
      "kind"  :   "{{ interaction.content.kind }}",
      "date"  :   "{{ interaction.created|date:"M d, Y"|escapejs }}",
      "interaction_node_body" :   "{% if interaction.kind = 'tag' or interaction.kind = 'bkm' %}{{interaction.interaction_node.body|escapejs }}{% else %}{{ interaction.human_kind|escapejs }}{% endif %}",
      "content_body"          :   '{{ interaction.content.body|escapejs }}',
      "page_title"            :   "{{ page.grouper.title|escapejs }}",
      "external_url"          :   "{% if interaction.page.canonical_url %}{{ interaction.page.canonical_url|escapejs }}{% else %}{{ interaction.page.url|escapejs }}{% endif %}",
      "approved"              :   {% if interaction.approved %}true{% else %}false{% endif %},
      "group" : {
        "short_name"  :   "{{ page.grouper.site.group.short_name }}",
        "id"          :   "{{ page.grouper.site.id }}",
        "logo_url"    :   "{{ STATIC_URL }}{{ page.grouper.site.group.logo_url_sm }}",
        "logo_url_lg" :   "{{ STATIC_URL }}{{ page.grouper.site.group.logo_url_lg }}",
        "name"        :   "{{ page.grouper.site.group.name|escapejs }}",
        "title"       :   "{{ page.grouper.site.group.title|escapejs }}"
      },
      "created"           :   "{{ interaction.created|date:"M d g:ia" }}",
      "moderator"         :   {% if cookie_user and interaction.page.site.group.id in ga_ids %}true{% else %}false{% endif %},
      "page" : {{interaction.page}}
};
interactions.push( interaction );
/*
      <h5>Other Reactions</h5>
      <ul class="other_reactions">
        {% for other_tag in interaction.related_tags %}
            <li>{{ other_tag.body }}</li>
        {% endfor %}
      </ul>

  </div>
</div>
*/
{% endif %}
{% if interaction.kind == 'com' %}

  // if parent interaction content type is txt or med or img
  var comment = {
    "parent" : {
      "id"    :   {{ interaction.parent.id }},
      "kind"  :   "{{ interaction.parent.content.kind }}",
      "date"  :   "{{ interaction.parent.created|date:"M d, Y" }}",
      "interaction_node_body" :   "{% if interaction.parent.kind = 'tag' or interaction.parent.kind = 'bkm' %}{{interaction.parent.interaction_node.body|escapejs }}{% else %}{{ interaction.parent.human_kind|escapejs }}{% endif %}",
      "content_body"          :   '{{ interaction.parent.content.body|escapejs }}',
      "page_title"            :   "{{ page.grouper.title|escapejs }}",
      "external_url"          :   "{% if interaction.page.canonical_url %}{{ interaction.page.canonical_url|escapejs }}{% else %}{{ interaction.page.url|escapejs }}{% endif %}",
      "approved"              :   {% if interaction.parent.approved %}true{% else %}false{% endif %},
      "group" : {
        "short_name"  :   "{{ page.grouper.site.group.short_name }}",
        "id"          :   "{{ page.grouper.site.id }}",
        "logo_url"    :   "{{ STATIC_URL }}{{ page.grouper.site.group.logo_url_sm }}",
        "name"        :   "{{ page.grouper.site.group.name|escapejs }}",
        "title"       :   "{{ page.grouper.site.group.title|escapejs }}"
      }
    },
    "id"                :   "{{ interaction.id }}",
    "approved"          :   {% if interaction.approved %}true{% else %}false{% endif %},
    "created"           :   "{{ interaction.created|date:"M d g:ia" }}",
    "user_profile_link" :   "/user/{{interaction.user.id}}",
    "user_avatar"       :   "{{ interaction.user.social_user.img_url }}",
    "user_name"         :   "{{ interaction.user.social_user.full_name }}",
    "comment"           :   "{% filter force_escape %}{{ interaction.interaction_node.body|linebreaksbr }}{% endfilter %}",
    "moderator"         :   {% if cookie_user and interaction.page.site.group.id in ga_ids %}true{% else %}false{% endif %}
  };
  comments.push(comment);

{% endif %}

  {% endfor %}
{% endfor %}
</script>

</section>
<div class="pagination">
  <span class="step-links">
    {% if current_page.has_previous %}
      <a href="?{% if query_string %}s={{ query_string }}{% endif %}&page_num={{ current_page.previous_page_number }}">prev</a>
    {% endif %}
    <span class="current">
      Page {{ current_page.number }} of {{ current_page.paginator.num_pages }}
    </span>
    {% if current_page.has_next %}
      <a href="?{% if query_string %}s={{ query_string }}{% endif %}&page_num={{ current_page.next_page_number }}">next</a>
    {% endif %}
  </span>
</div>


<script>
function writeCard( interaction, showBlocked ) {

  if ( window.location.href.indexOf('/page/') != -1 ) {
    // this should really be done by the back-end.
    if ( !$('#sidebar div#avatar').length ) {
      var $avatar = $('<div id="avatar"><a href="/group/'+interaction.group.short_name+'"><img alt="'+interaction.group.name+'" src="'+interaction.group.logo_url_lg+'"></a></div>')
      $('#sidebar').prepend( $avatar );
    }

    if ( !$('#sidebar h3').length ) {
      var $pageTitle = $('<h3>'+interaction.page_title+'</h3><div style="text-align:center;padding-right:20px;margin-bottom:20px"><a href="'+interaction.external_url+'" target="_blank"><img src="{{ STATIC_URL }}site/images/external_link_icon.gif"/> See It</a></div>')
      $('#sidebar h4').text('Activty on:').after( $pageTitle );
    }

  }

  if ( interaction.approved || ( !interaction.approved && showBlocked ) ) {
    // write the card first, then append the comment
    var $card = $('<div class="card '+interaction.kind+'" id="card_'+interaction.id+'" />');
    $card.append('<div class="date">'+interaction.date+'</div>');
    var $header = $('<header/>').attr('title', interaction.interaction_node_body)
         .append('<h1><a href="/stream/?s='+interaction.interaction_node_body+'">'+interaction.interaction_node_body+'</a></h1>')
         .append('<span class="count"></span>');

    var $content = $('<div class="content"/>');
    
    if ( interaction.kind == "txt" ) {
        $content.append('<div class="content_type" rel="tooltip" title="This reaction is to text from the article.">quote</div>');
    } else if ( interaction.kind == "pag" ) {
        $content.append('<div class="content_type" rel="tooltip" title="This is reaction is to a whole page.">page</div>');
    }

    if ( interaction.kind == "img" ) {
      $content.append('<div class="content_body"><img src="'+interaction.content_body+'"></div><div class="comments"></div>');
    } else if ( interaction.kind == "med" ) {
      $content.append('<div class="content_body"><iframe width="418" height="244" frameborder="0" src="'+interaction.content_body+'"></iframe></div><div class="comments"></div>');
    } else if ( interaction.kind == "txt" ) {
      $content.append('<div class="content_body">'+interaction.content_body+'</div><div class="comments"></div>');
    } else if ( interaction.kind == "pag" ) {
      $content.append('<div class="content_body">'+interaction.page_title+'</div><div class="comments"></div>');
    }

    var $meta = $('<div class="meta"/>');
    if ( interaction.group.logo_url != "" ) {
      $meta.append('<div class="publisher"><a href=/group/' + interaction.group.short_name + '><img alt="' + interaction.group.name + '" src="' + interaction.group.logo_url + '"></a></div>');
    } else {
      $meta.append('<div class="publisher"><a href=/group/' + interaction.group.short_name + '>'+interaction.group.name+'</a></div>');
    }
    $meta.append('<div class="title">'
            + '<strong><a href="'+interaction.external_url+'">'+interaction.page_title+'</a></strong>'
            + '<a class="external_link" href="{{ BASE_URL }}/i/'+interaction.id+'" target="_blank"><img src="{{ STATIC_URL }}site/images/external_link_icon.gif"/> See It</a>'
            + '</div>');
    if ( interaction.moderator ) {
        $meta.append('<div class="block_content">'
          + '<a href="javascript:void(0);" onclick="RB.admin.blockContent('+interaction.id+');" id="moderate_'+interaction.id+'">'
          + (( interaction.approved ) ? 'Block this':'Unblock')
          + '</a></div>');
    }
    $card.append( $header, $content, $meta );
    $('#cards section').append( $card );
  }
}

function writeComment( comment, showBlocked ) {
  if ( comment.approved || ( !comment.approved && showBlocked ) ) {
    var $card = $('#card_'+comment.parent.id);

    // check to see if the card for the interaction exists yet
    if ( !$card.length ) {
      writeCard( comment.parent );
      var $card = $('#card_'+comment.parent.id);
    }

    var $comments = $card.find('div.comments'),
        $comment_container = $('<div class="comment_container"/>');

    $comment_container.html('<div class="header">' +
        '<div class="when">'+comment.created+'</div>' +
        '<a href="'+comment.user_profile_link+'">' +
          '<div class="avatar"><img src="'+comment.user_avatar+'"></div>' +
          '<div class="who">'+comment.user_name+'</div>' +
        '</a>' +
      '</div>' +
      '<div class="comment">' +
        '<div class="quote open">"</div>' +
        '<div class="comment_body">'+comment.comment+'</div>' +
        '<div class="quote close">"</div>' +
      '</div>' +
      '<a class="block_content" href="javascript:void(0);" onclick="RB.admin.blockContent('+comment.id+');" id="moderate_'+comment.id+'">Block this</a></div>');
    
      $comments.show();
      if ( !$comments.find('h2').length ) $comments.append('<h2>Comments</h2>');
      $comments.append( $comment_container );
  }
}

$.each( interactions, function(idx, interaction) {
  writeCard( interaction );
});

$.each( comments, function(idx, comment) {
  writeComment( comment );
});

var $container = $('#cards section');
$container.imagesLoaded(function(){
  $container.masonry({
      // options
      itemSelector : '.card',
      columnWidth : 439
  });
  $container.tooltip({
    selector: "div.content_type"
  })
});
</script>