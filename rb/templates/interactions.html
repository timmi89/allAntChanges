<script>
var comments = [];
</script>
<section>
<!--
<div class="card text">
  <header>
    <h1 title="Hilarious">Hilarious <span class="count"></span></h1>
  </header>
  <div class="content">
    <div class="content_type" rel="tooltip" title="This is reaction is to text from the article.">quote</div>
    <div class="content_body">
      four score and seven years ago and something else really cool, too.
    </div>
  </div>
  <div class="meta">
    <div class="publisher"><img src="/static/site/images/logo_sm.png"/></div>
    <div class="title"><strong><a href="#">the title of the article goes here</a></strong></div>
  </div>
</div>

<div class="card page">
  <header>
    <h1 title="Love It">Love It <span class="count"></span></h1>
  </header>
  <div class="content">
    <div class="content_type" rel="tooltip" title="This is reaction is to a whole page.">page</div>
    <div class="content_body">
      ReadrBoard launches on HyperVocal
    </div>
  </div>
  <div class="meta">
    <div class="publisher"><img src="/static/site/images/logo_sm.png"/></div>
  </div>
</div>

<div class="card media">
  <header>
    <h1 title="Beautiful">Beautiful <span class="count"></span></h1>
  </header>
  <div class="content">
    <div class="content_type"></div>
    <div class="content_body">
      <img src="http://www.metrolic.com/wp-content/uploads/2011/02/6iceland.jpg" />
    </div>
  </div>
  <div class="meta">
    <div class="publisher"><img src="/static/site/images/logo_sm.png"/></div>
    <div class="title"><strong><a href="#">the title of the article goes here</a></strong></div>
  </div>
</div>
-->


{% regroup current_page.object_list by page as pi %}
{% for page in pi %}
{% for interaction in page.list %}

{% if interaction.kind != 'com' %}
<div class="card {{ interaction.content.kind }}" id="card_{{ interaction.id }}">
  <div class="date">
    {{ interaction.created|date:"M d, Y" }}
  </div>
  <header>
    <h1 title="{% if interaction.kind = 'tag' or interaction.kind = 'bkm' %}{{ interaction.interaction_node.body }}{% else %}{{ interaction.human_kind }}:{% endif %}">
      {% if interaction.kind = 'tag' or interaction.kind = 'bkm' %}{{ interaction.interaction_node.body }}{% else %}{{ interaction.human_kind }}:{% endif %}
      <span class="count"></span>
    </h1>
  </header>
  <div class="content">
    {% if interaction.content.kind == "txt" %}
    <div class="content_type" rel="tooltip" title="This reaction is to text from the article.">quote</div>
    {% endif %}
    {% if interaction.content.kind == "pag" %}
    <div class="content_type" rel="tooltip" title="This is reaction is to a whole page.">page</div>
    {% endif %}
    <div class="content_body">
      {% if interaction.content.kind == "img" %}
      <img src="{{ interaction.content.body }}">
      {% endif %}
      {% if interaction.content.kind == "med" %}
      <iframe width="418" frameborder="0" src="{{ interaction.content.body }}"></iframe>
      {% endif %}
      {% if interaction.content.kind == "txt" %}
      {{ interaction.content.body }}
      {% endif %}
      {% if interaction.content.kind == "pag" %}
      {{ page.grouper.title }}
      {% endif %}
    </div>
  </div>
  <div class="comments"></div>
  <div class="meta">
    <div class="publisher">
      <a href=/group/{{ page.grouper.site.group.short_name }}>
      {% if page.grouper.site.group.logo_url_sm %}
        <img alt="{{ page.grouper.site.group.name }}" src="{{ STATIC_URL }}{{ page.grouper.site.group.logo_url_sm }}">
      {% else %}
        {{ page.grouper.site.group.name }}
      {% endif %}
      </a>
    </div>
    <div class="title">
      <strong><a href="/page/{{ page.grouper.id }}/">{{ page.grouper.title }}</a></strong>
      <a class="external_link" href="{% if interaction.page.canonical_url %}{{ interaction.page.canonical_url }}{% else %}{{ interaction.page.url }}{% endif %}" target="_blank"><img src="{{ STATIC_URL }}site/images/external_link_icon.gif"/> See It</a>
    </div>
    {% if cookie_user and interaction.page.site.group.id in ga_ids %}
    <div class="block_content">
      <a href="javascript:void(0);" onclick="RB.admin.blockContent({{interaction.id}});" id="moderate_{{interaction.id}}">
        {% if interaction.approved %}
          Block this
        {% else %}
          Unblock
        {% endif %}
      </a>
    </div>
    {% endif %}
    <!-- 
      <h5>Other Reactions</h5>
      <ul class="other_reactions">
        {% for other_tag in interaction.related_tags %}
            <li>{{ other_tag.body }}</li>
        {% endfor %}
      </ul>
    -->
  </div>
</div>
{% endif %}
{% if interaction.kind == 'com' %}
<script>
  // if parent interaction content type is txt or med or img
  // { % if interaction.content.kind == "txt" % }
  var comment = {
    "parent":{
      "id":{{ interaction.parent.id }}
    },
    "created":"{{ interaction.created|date:"M d g:ia" }}",
    "user_profile_link":"/user/{{interaction.user.id}}",
    "user_avatar":"{{ interaction.user.social_user.img_url }}",
    "user_name":"{{ interaction.user.social_user.full_name }}",
    "comment":"{% filter force_escape %}{{ interaction.interaction_node.body }}{% endfilter %}"
  };
  comments.push(comment);

  // if (         $('#card_{{ interaction.parent.id }}').length ) {
  function writeComment( comment ) {
      var $card = $('#card_'+comment.parent.id),
          $comments = $card.find('div.comments'),
          $comment_container = $('<div class="comment_container"/>');

      $comment_container.html('<div class="header">' +
          '<div class="when">'+comment.created+'</div>' +
          '<a href="'+comment.user_profile_link+'">' +
            '<div class="avatar"><img src="'+comment.user_avatar+'"></div>' +
            '<div class="who">'+comment.user_name+'</div>' +
          '</a>' +
        '</div>' +
        '<div class="comment">' +
          '<div class="quote open">"</div>' +
          '<div class="comment_body">'+comment.comment+'</div>' +
          '<div class="quote close">"</div>' +
        '</div>');
      
      if ( $card.length ) {
        $comments.show();
        if ( !$comments.find('h2').length ) $comments.append('<h2>Comments</h2>');
        $comments.append( $comment_container );
      } else {
        // write the card first, then append the comment
        /*
        var $newCard = $('<div class="card {{ interaction.content.kind }}" id="card_{{ interaction.id }}" />');
        
        $newCard.append('<div class="date">{{ interaction.created|date:"M d, Y" }}</div>');
          <header>
            <h1 title="{% if interaction.kind = 'tag' or interaction.kind = 'bkm' %}{{ interaction.interaction_node.body }}{% else %}{{ interaction.human_kind }}:{% endif %}">
              {% if interaction.kind = 'tag' or interaction.kind = 'bkm' %}{{ interaction.interaction_node.body }}{% else %}{{ interaction.human_kind }}:{% endif %}
              <span class="count"></span>
            </h1>
          </header>
          <div class="content">
            {% if interaction.content.kind == "txt" %}
            <div class="content_type" rel="tooltip" title="This reaction is to text from the article.">quote</div>
            {% endif %}
            {% if interaction.content.kind == "pag" %}
            <div class="content_type" rel="tooltip" title="This is reaction is to a whole page.">page</div>
            {% endif %}
            <div class="content_body">
              {% if interaction.content.kind == "img" %}
              <img src="{{ interaction.content.body }}">
              {% endif %}
              {% if interaction.content.kind == "med" %}
              <iframe width="418" frameborder="0" src="{{ interaction.content.body }}"></iframe>
              {% endif %}
              {% if interaction.content.kind == "txt" %}
              {{ interaction.content.body }}
              {% endif %}
              {% if interaction.content.kind == "pag" %}
              {{ page.grouper.title }}
              {% endif %}
            </div>
          </div>
          <div class="comments"></div>
          <div class="meta">
            <div class="publisher">
              <a href=/group/{{ page.grouper.site.group.short_name }}>
              {% if page.grouper.site.group.logo_url_sm %}
                <img alt="{{ page.grouper.site.group.name }}" src="{{ STATIC_URL }}{{ page.grouper.site.group.logo_url_sm }}">
              {% else %}
                {{ page.grouper.site.group.name }}
              {% endif %}
              </a>
            </div>
            <div class="title">
              <strong><a href="/page/{{ page.grouper.id }}/">{{ page.grouper.title }}</a></strong>
              <a class="external_link" href="{% if interaction.page.canonical_url %}{{ interaction.page.canonical_url }}{% else %}{{ interaction.page.url }}{% endif %}" target="_blank"><img src="{{ STATIC_URL }}site/images/external_link_icon.gif"/> See It</a>
            </div>
            {% if cookie_user and interaction.page.site.group.id in ga_ids %}
            <div class="block_content">
              <a href="javascript:void(0);" onclick="RB.admin.blockContent({{interaction.id}});" id="moderate_{{interaction.id}}">
                {% if interaction.approved %}
                  Block this
                {% else %}
                  Unblock
                {% endif %}
              </a>
            </div>
            {% endif %}
          </div>
        </div>
*/








      }


  }
</script>
{% endif %}


  {% endfor %}
{% endfor %}

</section>
<div class="pagination">
  <span class="step-links">
    {% if current_page.has_previous %}
      <a href="?{% if query_string %}s={{ query_string }}{% endif %}&page_num={{ current_page.previous_page_number }}">prev</a>
    {% endif %}
    <span class="current">
      Page {{ current_page.number }} of {{ current_page.paginator.num_pages }}
    </span>
    {% if current_page.has_next %}
      <a href="?{% if query_string %}s={{ query_string }}{% endif %}&page_num={{ current_page.next_page_number }}">next</a>
    {% endif %}
  </span>
</div>


<script>
$.each( comments, function(idx, comment) {
  writeComment( comment );
});

var $container = $('#cards section');
$container.imagesLoaded(function(){
  $container.masonry({
      // options
      itemSelector : '.card',
      columnWidth : 439
  });
  $container.tooltip({
    selector: "div.content_type"
  })
});
</script>