<section>
<script>
var comments = [],
    interactions = [],
    shares = [];
    
if ( window.location.href.indexOf('/user/') != -1 ) {
  $('#cards').addClass('user_profile');
}
{% regroup current_page.object_list by page as pi %}
{% for page in pi %}
    {% for interaction in page.list %}
        {% if interaction.kind != 'com' and interaction.human_kind != 'Share' %}
            var interaction = {
                  "id"    :   {{ interaction.id }},
                  "kind"  :   "{{ interaction.content.kind }}",
                  "date"  :   "{{ interaction.created|date:"M d, Y"|escapejs }}",
                  "interaction_node_body" :   "{% if interaction.kind = 'tag' or interaction.kind = 'bkm' %}{{interaction.interaction_node.body|escapejs }}{% else %}{{ interaction.human_kind|escapejs }}{% endif %}",
                  "content_body"          :   '{{ interaction.content.body|escapejs }}',
                  "content_id"          :   '{{ interaction.content.id }}',
                  "page_title"            :   "{{ page.grouper.title|escapejs }}",
                  "external_url"          :   "{% if interaction.page.canonical_url %}{{ interaction.page.canonical_url|escapejs }}{% else %}{{ interaction.page.url|escapejs }}{% endif %}",
                  "domain"              : "{{page.grouper.site.domain}}",
                  "approved"              :   {% if interaction.approved %}true{% else %}false{% endif %},
                  "singleton"              :   {% if singleton %}true{% else %}false{% endif %},
                  "group" : {
                    "short_name"  :   "{{ page.grouper.site.group.short_name }}",
                    "id"          :   "{{ page.grouper.site.id }}",
                    "logo_url"    :   "{{ page.grouper.site.group.logo_url_sm }}",
                    "logo_url_lg" :   "{{ page.grouper.site.group.logo_url_lg }}",
                    "name"        :   "{{ page.grouper.site.group.name|escapejs }}",
                    "title"       :   "{{ page.grouper.site.group.title|escapejs }}"
                  },
                  "user_profile_link" :   "/user/{{interaction.user.id}}",
                  "user_avatar"       :   "{{ interaction.user.social_user.img_url }}",
                  "user_name"         :   "{{ interaction.user.social_user.full_name }}",
                  "created"           :   "{{ interaction.created|date:"M d g:ia" }}",
                  "moderator"         :   {% if cookie_user and ga_ids and interaction.page.site.group.id in ga_ids %}true{% else %}false{% endif %},
                  "page" : {{interaction.page}},
                  "page_id" : {{interaction.page}},
                  "comments" : [
                  {% for comment in interaction.comments %}
                      {
                      "id": {{comment.id}},
                      "approved"          :   {% if comment.approved %}true{% else %}false{% endif %},
                      "created"           :   "{{ comment.created|date:"M d g:ia" }}",
                      "user_profile_link" :   "/user/{{comment.user.id}}",
                      "user_avatar"       :   "{{ comment.user.social_user.img_url }}",
                      "user_name"         :   "{{ comment.user.social_user.full_name }}",
                      "comment"           :   "{% filter force_escape %}{{ comment.interaction_node.body|linebreaksbr|escapejs }}{% endfilter %}",
                      "moderator"         :   {% if cookie_user and ga_ids and comment.page.site.group.id in ga_ids %}true{% else %}false{% endif %}
                      }{% if not forloop.last %},{% endif %}
                  {% endfor %}
                  ],
            };
            if ( interaction.user_name == "" ) {
              interaction.user_name = "Unregistered User";
            }
            interactions.push( interaction );
            /*
                  <h5>Other Reactions</h5>
                  <ul class="other_reactions">
                    {% for other_tag in interaction.related_tags %}
                        <li>{{ other_tag.body }}</li>
                    {% endfor %}
                  </ul>

              </div>
            </div>
            */
        {%endif%}

        {% if interaction.human_kind == 'Share' %}
            var share = {
                  "id"    :   {{ interaction.id }},
                  "kind"  :   "{{ interaction.content.kind }}",
                  "date"  :   "{{ interaction.created|date:"M d, Y"|escapejs }}",
                  "interaction_node_body" :   "{% if interaction.kind = 'tag' or interaction.kind = 'bkm' %}{{interaction.interaction_node.body|escapejs }}{% else %}{{ interaction.human_kind|escapejs }}{% endif %}",
                  "content_body"          :   '{{ interaction.content.body|escapejs }}',
                  "page_title"            :   "{{ page.grouper.title|escapejs }}",
                  "external_url"          :   "{% if interaction.page.canonical_url %}{{ interaction.page.canonical_url|escapejs }}{% else %}{{ interaction.page.url|escapejs }}{% endif %}",
                  "approved"              :   {% if interaction.approved %}true{% else %}false{% endif %},
                  "group" : {
                    "short_name"  :   "{{ page.grouper.site.group.short_name }}",
                    "id"          :   "{{ page.grouper.site.id }}",
                    "logo_url"    :   "{{ page.grouper.site.group.logo_url_sm }}",
                    "logo_url_lg" :   "{{ page.grouper.site.group.logo_url_lg }}",
                    "name"        :   "{{ page.grouper.site.group.name|escapejs }}",
                    "title"       :   "{{ page.grouper.site.group.title|escapejs }}"
                  },
                  "created"           :   "{{ interaction.created|date:"M d g:ia" }}",
                  "moderator"         :   {% if cookie_user and ga_ids and interaction.page.site.group.id in ga_ids %}true{% else %}false{% endif %},
                  "page" : {{interaction.page}},
                  "page_id" : {{interaction.page}}
            };
            shares.push( share );
        {% endif %}
    {% endfor %}
{% endfor %}
var metoos = {
    {% if child_interactions %}
    {% for key, value in child_interactions.items %}
        {{key}} : {{value}},
    {% endfor %}
    {% endif %}
};
</script>

</section>
<div class="pagination">
  <span class="step-links">
    {% if current_page.has_previous %}
      <a href="?{% if query_string %}s={{ query_string }}{% endif %}&page_num={{ current_page.previous_page_number }}">prev</a>
    {% endif %}
    <span class="current">
      Page {{ current_page.number }} of {{ current_page.paginator.num_pages }}
    </span>
    {% if current_page.has_next %}
      <a href="?{% if query_string %}s={{ query_string }}{% endif %}&page_num={{ current_page.next_page_number }}">next</a>
    {% endif %}
  </span>
</div>


<script>
var zIndex = 400;
function writeCard( interaction, showBlocked ) {

  if ( window.location.href.indexOf('/page/') != -1 ) {
    // this should really be done by the back-end.
    if ( !$('#sidebar div#avatar').length ) {
      var $avatar = $('<div id="avatar"><a href="/group/'+interaction.group.short_name+'"><img alt="'+interaction.group.name+'" src="'+interaction.group.logo_url_lg+'"></a></div>')
      $('#sidebar').prepend( $avatar );
    }

    if ( !$('#sidebar h3').length ) {
      var $pageTitle = $('<h3>'+interaction.page_title+'</h3><div style="text-align:center;padding-right:20px;margin-bottom:20px"><a href="'+interaction.external_url+'" target="_blank"><img src="{{ STATIC_URL }}site/images/external_link_icon.gif"/> See It</a></div>')
      $('#sidebar h4').text('Activity on:').after( $pageTitle );
    }

  }

  if ( interaction.approved || ( !interaction.approved && showBlocked ) ) {
    
    // if a page-level one, let's group it into a container.  This is Part 1 of the process.
    if ( interaction.kind == "pag" ) {
      if ( !$('div.card.pag_container').last().length || $('div.card.pag_container').last().find('div.card').length != 1 ) {
        // var $pag_container = $('div.card.pag_container').last();
      // } else {
        $('#cards section').append('<div class="card pag_container" style="z-index:'+zIndex+'" />');
      }
    }

    // write the card first, then append the comment
    var $card = $('<div class="card '+interaction.kind+'" id="card_'+interaction.id+'" style="z-index:'+zIndex+'" />');
    var $header = $('<header/>').attr('title', interaction.interaction_node_body)
         .append('<h1><a href="/stream/?s='+interaction.interaction_node_body+'">'+interaction.interaction_node_body+'</a></h1>')
         .append('<span class="count"></span>')

    if ( interaction.moderator ) {
        $header.append('<div class="block_content">'
          + '<a href="javascript:void(0);" onclick="RB.admin.blockContent('+interaction.id+');" id="moderate_'+interaction.id+'">'
          + (( interaction.approved ) ? 'Block':'Unblock')
          + '</a></div>');
    }

    var $content = ( interaction.kind != "pag" ) ? $('<div class="content"/>'):'';
    
    if ( interaction.kind == "img" ) {
      $content.append('<div class="content_body"><a href="{{ BASE_URL }}/i/'+interaction.id+'" target="_blank"><img src="'+interaction.content_body+'"></a></div><div class="comments" />');
    } else if ( interaction.kind == "med" ) {
      
      var videoUrl = interaction.content_body;
      //if we want this later...
      // var videoUrl = RB.fixUrlParams(interaction.content_body, {
      //   wmode:"transparent"
      // });

      $content.append('<div class="content_body"><a href="{{ BASE_URL }}/i/'+interaction.id+'" target="_blank"><iframe width="418" height="244" frameborder="0" src="'+videoUrl+'"></iframe></a></div><div class="comments" />');
    } else if ( interaction.kind == "txt" ) {
      $content.append('<div class="content_body"><a href="{{ BASE_URL }}/i/'+interaction.id+'" target="_blank">'+interaction.content_body+'</a></div><div class="comments" />');
    }

    var $meta = $('<div class="meta"/>'),
        $metaLeft = $('<div class="metaLeft"/>'),
        $metaRight = $('<div class="metaRight"/>');

    if ( interaction.kind == "txt" ) {
        $metaLeft.append('<div class="content_type" rel="tooltip" title="This reaction is to <strong>text</strong> from the page."><img src="{{ STATIC_URL }}site/images/type_text.png" /></div>');
    } else if ( interaction.kind == "img" ) {
        $metaLeft.append('<div class="content_type" rel="tooltip" title="This is reaction is to an <strong>image</strong> from the page."><img src="{{ STATIC_URL }}site/images/type_img.png" /></div>');
    } else if ( interaction.kind == "med" ) {
        $metaLeft.append('<div class="content_type" rel="tooltip" title="This is reaction is to a <strong>video or other type of media</strong> from the page."><img src="{{ STATIC_URL }}site/images/type_media.png" /></div>');
    } else if ( interaction.kind == "pag" ) {
        $metaLeft.append('<div class="content_type" rel="tooltip" title="This is reaction is to the <strong>whole page</strong>.">'
                + '<img class="pageIcon" src="{{ STATIC_URL }}site/images/type_page.png" />'
                + '<div class="favicon"><img src="http://www.google.com/s2/favicons?domain='+interaction.domain+'" /></div>'
            +'</div>'
        );
    }

    $meta.prepend('<div class="date">'+interaction.date+'</div>');
    $meta.append($metaLeft);
    $meta.append($metaRight);
    $meta.append('<div class="clear" />');

    if ( interaction.group.logo_url != "" ) {
      $metaRight.append('<div class="publisher"><a href=/group/' + interaction.group.short_name + '><img alt="' + interaction.group.name + '" src="' + interaction.group.logo_url + '"></a></div>');
    } else {
      $metaRight.append('<div class="publisher"><a href=/group/' + interaction.group.short_name + '>'+interaction.group.name+'</a></div>');
    }
    $metaRight.append('<div class="title">'
                + '<a href="{{ BASE_URL }}/i/'+interaction.id+'" target="_blank">'+interaction.page_title+'</a>'
              + '</div>');
    
    var hasProfilePic =  interaction.user_avatar != "None" && interaction.user_avatar != "";
    var profilePic = hasProfilePic ? interaction.user_avatar : "{{ STATIC_URL }}site/images/anonymous-user.png";
    var $addedBy = $( '<div class="added_by">'
        + '<img src="{{ STATIC_URL }}site/images/blank.png" class="me_too" title="Add this to your profile"/>'
        + '<a href="'+interaction.user_profile_link+'" rel="tooltip" title="'+interaction.user_name +'">'
        + '<img src="'+profilePic+'" class="user_avatar" />'
        + '</a>'
        + '<div class="me_too_outcome" />'
        + '</div>'
    );

    $addedBy.find('img.me_too').click( function() {
      RB.interactions.me_too( interaction.id );
    });

    $card.append( $header, $content, $meta, $addedBy );
    zIndex--;

    if ( interaction.kind == "pag" ) {
      var $pag_container = $('div.card.pag_container').last(),
          $pag_cards = $pag_container.find('div.card');
      if ( $pag_cards.length == 0 ) {
        $card.addClass('first');
      }
      $pag_container.append( $card );

      $pag_cards = $pag_container.find('div.card');
      var pag_card_height = 0;

      $pag_cards.each( function() {
        var this_card_height = $(this).height();
        pag_card_height = ( this_card_height > pag_card_height ) ? this_card_height:pag_card_height;
      });

      $pag_cards.each( function() { 
        var this_card_height = $(this).height();
        if ( this_card_height < pag_card_height ) {
          $(this).css( 'min-height', pag_card_height ).addClass('heightAdjusted').find('div.added_by').css('margin-top', (pag_card_height - this_card_height + 5) );
        }
      });

    } else {
      $('#cards section').append( $card );
    }
  }
}

function writeComment( comment, parent, showBlocked ) {
  if ( comment.approved || ( !comment.approved && showBlocked ) ) {
    var $card = $('#card_'+parent.id);

    // check to see if the card for the interaction exists yet
    if ( !$card.length ) {
      writeCard( parent );
      var $card = $('#card_'+parent.id);
    }

    var $comments = $card.find('div.comments'),
        $comment_container = $('<div class="comment_container"/>');

    $comment_container.html(
        '<div class="header">' +
            '<div class="when">'+comment.created+'</div>' +
            '<a href="'+comment.user_profile_link+'">' +
                '<div class="avatar"><img src="'+comment.user_avatar+'"></div>' +
                '<div class="who">'+comment.user_name+'</div>' +
            '</a>' +
        '</div>' +
        '<div class="comment">' +
            '<div class="quote open">"</div>' +
            '<div class="comment_body">'+comment.comment+'</div>' +
            '<div class="quote close">"</div>' +
        '</div>'
    );

    if ( interaction.moderator ) {
        $comment_container.append('<div class="block_content">'
          + '<a class="block_content" href="javascript:void(0);" onclick="RB.admin.blockContent('+comment.id+');" id="moderate_'+comment.id+'">Block</a>'
          + '</div>'
        );
    }

      $comments.show();
      if ( !$comments.find('h2').length ) $comments.append('<h2>Comments</h2>');
      $comments.append( $comment_container );
  }
}

$.each( interactions, function(idx, interaction) {
  writeCard( interaction );
  $.each( interaction.comments, function(idx, comment) {
    writeComment( comment, interaction );
  });
});

var $container = $('#cards section');
// $container.imagesLoaded(function(){
$(document).ready(function(){
  $container.masonry({
      // options
      itemSelector : 'div.card.pag_container,div.card.img,div.card.txt,div.card.med',
      columnWidth : 316,
      isFitWidth:true,
      containerStyle : {
        "margin":"0 auto"
      }
  });
  $container.tooltip({
    selector: "div.content_type, .added_by a, .added_by img.me_too"
  });
});
</script>