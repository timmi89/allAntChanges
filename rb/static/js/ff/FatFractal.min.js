function RegisterRequest(){return this.userName=null,this.password=null,this.firstName=null,this.lastName=null,this.email=null,this}function FFUser(){return this.clazz="FFUser",this.userName=null,this.firstName=null,this.lastName=null,this.email=null,this.active=null,this}function FFMetaData(a){return this.clazz=null,this.ffUrl=null,this.guid=null,this.ffRL=null,this.objVersion=null,this.createdBy=null,this.createdAt=null,this.updatedBy=null,this.updatedAt=null,this.ffRefs=[],this.ffUserCanEdit=!1,a&&(this.clazz=a.clazz,this.ffUrl=a.ffUrl,this.guid=a.guid,this.ffRL=a.ffRL,this.objVersion=a.objVersion,this.createdBy=a.createdBy,this.createdAt=a.createdAt,this.updatedBy=a.updatedBy,this.updatedAt=a.updatedAt,this.ffRefs=a.ffRefs,this.ffUserCanEdit=a.ffUserCanEdit),this}function Token(a,b){this.token=a,this.secret=b}function FatFractal(){function v(){var a=location.href;i&&console.log("FatFractal().getWindowURL(String) url is: "+a);var b=a.substring(0,a.indexOf("/",14));i&&console.log("FatFractal().getWindowURL(String) baseURL is: "+b);var c,d,e;c=location.pathname,d=a.indexOf(c),e=a.indexOf("/",d+1);var f=a.substr(0,e)+"/";return i&&console.log("FatFractal().getWindowURL(String) returning : "+f),f}function x(a){l=a===!0?!0:!1}function z(a){function b(a,b,c,d,e){var f=new XDomainRequest;f.onload=function(){var a;try{a=JSON.parse(f.responseText)}catch(b){e?e(f.status,f.responseText):y(f.status,f.responseText)}a&&d&&d(a,f)},f.onerror=f.ontimeout=function(){console.error&&console.error("FatFractal.m_ajax "+f.status+", "+f.responseText),e&&e(f.status,f.responseText)},f.onprogress=function(){},f.open(a,b),f.send(c)}var c;try{c=new XMLHttpRequest}catch(f){try{c=new ActiveXObject("Msxml2.XMLHTTP")}catch(f){try{c=new ActiveXObject("Microsoft.XMLHTTP")}catch(f){try{"undefined"!=typeof XDomainRequest&&b(a.type,a.url,a.data,a.success,a.error)}catch(f){var g="A browser that supports AJAX requests is required!";throw alert(g),g}}}}var h=!1;c.open(a.type.toUpperCase(),a.url,!0),a.dataType?"application/json"==a.dataType.toLowerCase()||"json"==a.dataType.toLowerCase()?c.setRequestHeader("Data-type","application/json"):c.setRequestHeader("Data-type",a.dataType):c.setRequestHeader("Data-type","application/json"),a.contentType?"application/json"==a.contentType.toLowerCase()||"json"==a.contentType.toLowerCase()?c.setRequestHeader("Content-type","application/json"):c.setRequestHeader("Content-type",a.contentType):c.setRequestHeader("Content-type","application/json"),a.contentLength&&c.setRequestHeader("Content-Length",a.contentLength),a.contentName&&c.setRequestHeader("Content-Name",a.contentName),a.fileName&&c.setRequestHeader("x-file-name",a.fileName),a.fileSize&&c.setRequestHeader("x-file-size",a.fileSize),a.fileType&&c.setRequestHeader("x-file-type",a.fileType),l&&d&&(c.setRequestHeader("X-Ff-Auth-User-Guid",e.guid),c.setRequestHeader("X-Ff-Auth-Session-Id",k)),c.send(a.data),c.onreadystatechange=function(){if(4==c.readyState){if(i&&console.log("xmlHTTP.status: "+c.status+", xmlHTTP.readyState: "+c.readyState+", xmlHTTP.responseText: "+c.responseText),h)return;if(h=!0,c.status>=200&&c.status<300){var b=JSON.parse(c.responseText);a.success?(i&&console.log(JSON.stringify(b)),a.success(b)):i&&console.log("no success callback")}else 304==c.status||(console.error&&console.error(c.status+": "+c.statusText),401==c.status&&(console.error&&console.error("Got a 401 - clearing all session info"),d=!1,e=null,k=null,J()),a.error?(a.error(c),console.error&&console.error("xmlHTTP : "+u(c))):i&&console.log("no success callback"))}else i&&console.log("xmlHTTP.status: "+c.status+", xmlHTTP.readyState: "+c.readyState+", xmlHTTP.responseText: "+c.responseText)}}function G(a){var b,c,d,e=document.cookie.split(";");for(b=0;b<e.length;b++)if(c=e[b].substr(0,e[b].indexOf("=")),d=e[b].substr(e[b].indexOf("=")+1),c=c.replace(/^\s+|\s+$/g,""),c==a)return unescape(d);return null}function I(a){return null==c&&(c=H.getBaseUrl()),c+"::"+a}function J(){sessionStorage.removeItem(I("user")),sessionStorage.removeItem(I("sessionID"))}function K(a,b){i&&console.log("Storing session info for "+I("user"),a),sessionStorage.setItem(I("user"),JSON.stringify(a)),i&&console.log("Storing session info for "+I("sessionID"),b),sessionStorage.setItem(I("sessionID"),b),g[a.ffUrl]=a}function L(){var a;return a=l===!0?sessionStorage.getItem(I("sessionID")):G("sessionId"),a?a:null}function M(){i&&console.log("Retrieving user info for "+I("user"));var a=JSON.parse(sessionStorage.getItem(I("user")));return null===a||void 0===a?(console.log&&console.log("No existing user info found - creating new FFUser"),a=new FFUser):i&&console.log("Found existing FFUser session info: ",a),g[a.ffUrl]=a,a}var a=this,b=b;b||(b={}),b.console&&"undefined"!=typeof b.console||(b.console={}),b.console.log&&"undefined"!=typeof b.console.log||(b.console.log={log:function(){}}),b.console.error&&"undefined"!=typeof b.console.error||(b.console.error={error:function(){}}),Array.isArray||(Array.isArray=function(a){return"[object Array]"===Object.prototype.toString.call(a)}),Object.prototype.__defineGetter__&&!Object.defineProperty&&(Object.defineProperty=function(a,b,c){"get"in c&&a.__defineGetter__(b,c.get),"set"in c&&a.__defineSetter__(b,c.set)}),Array.prototype.indexOf||(Array.prototype.indexOf=function(a,b){for(var c=b||0,d=this.length;d>c;c++)if(this[c]===a)return c;return-1});var c=null,d=!1,e=null,f=null,g={},h={},i=!1,j=!1,k=null,l=!1,m={},n={},o={},p=!0,q=!1,r="FF_JS_CS_SDK_R1.2.0_R2656";this.SCRIPT_AUTH_SERVICE_FACEBOOK="FACEBOOK",this.SCRIPT_AUTH_SERVICE_TWITTER="TWITTER";var t=function(){var a=new XMLHttpRequest;return a.upload?!0:!1},u=function(a){var b=[];return JSON.stringify(a,function(a,c){if("object"==typeof c){if(b.indexOf(c)>=0)return void 0;b.push(c)}return c})};this.setDebug=function(a){i=a?!0:!1,console.log("FatFractal().setDebug(boolean) set debug mode to: "+i)},this.setAutoLoadRefs=function(a){p=a?!0:!1},this.setAutoLoadBlobs=function(a){q=a?!0:!1},this.getDebug=function(){return i&&console.log("FatFractal().getDebug() determined debug mode is: "+i),i?!0:!1},this.version=function(){return i&&console.log("FatFractal().version() determined version is: "+r),r};var w=function(a,b){i&&console.log("FatFractal().m_validUrl received url: "+a),i&&console.log("FatFractal().m_validUrl received type: "+b);var c=null;return c="extension"==b?"/"==a.substring(0,1)?"/ff/ext/"==a.substring(0,8)?a.substring(1,a.length):"ff/ext"+a:"ff/ext/"==a.substring(0,7)?a:"ff/ext/"+a:"resources"==b||"resource"==b?"/"==a.substring(0,1)?"/ff/resources/"==a.substring(0,14)?a.substring(1,a.length):"ff/resources"+a:"ff/resources/"==a.substring(0,13)?a:"ff/resources/"+a:"/"==a.substring(0,1)?"/ff/resources/"==a.substring(0,14)?a.substring(1,a.length):"/ff/ext/"==a.substring(0,8)?a.substring(1,a.length):"ff/resources"+a:"ff/resources/"==a.substring(0,13)?a:"ff/ext/"==a.substring(0,7)?a:"ff/resources/"+a,i&&console.log("FatFractal().m_validUrl returned validUrl: "+c),c};this.setBaseUrl=function(a){return c=a?"/"==a.charAt(a.length-1)?a:a+"/":null,i&&console.log("FatFractal().setBaseUrl(String) m_baseUrl to: "+c),c},this.getBaseUrl=function(){var a=null;return null==c?(a=v(),i&&console.log("FatFractal().getBaseUrl() window location is: "+a)):a=c,i&&console.log("FatFractal().getBaseUrl() determined base url is: "+a),a},this.setSSLUrl=function(){},this.getSSLUrl=function(){return this.getBaseUrl()},this.setSimulateCookies=x,this.loggedIn=function(){return k=L(),i&&console.log("FatFractal().loggedIn() determined m_sessionId is: "+k),M().guid&&(e=M()),i&&console.log("FatFractal().loggedIn() determined m_loggedInUser is: "+u(e)),k&&e?d=!0:(k=null,d=!1,e=null,J()),i&&console.log("FatFractal().loggedIn() determined loggedIn is: "+d),d},this.loggedInUser=function(){return k=L(),i&&console.log("FatFractal().loggedInUser() determined m_sessionId is: "+k),M().guid&&(e=M()),i&&console.log("FatFractal().loggedInUser() determined m_loggedInUser is: "+u(e)),k&&e?d=!0:(k=null,d=!1,e=null,J()),i&&console.log("FatFractal().loggedInUser() determined m_loggedInUser is: "+u(e)),e},this.sessionId=function(){return null==k&&(k=L(),i&&console.log("FatFractal().sessionId() determined m_sessionId is: "+k),M().guid&&(e=M()),i&&console.log("FatFractal().sessionId() determined m_loggedInUser is: "+u(e)),k&&e?d=!0:(k=null,d=!1,e=null,J())),i&&console.log("FatFractal().sessionId() determined sessionId is: "+k),k},this.getCallbackUriForScriptAuthService=function(a){return m[a]},this.setCallbackUriForScriptAuthService=function(a,b){m[a]=b},this.getTokenForScriptAuthService=function(a){return n[a]},this.setTokenForScriptAuthService=function(a,b){n[a]=b},this.clearTokenForScriptAuthService=function(a){delete n[a]},this.getRequestTokenForScriptAuthService=function(a){return o[a]},this.setRequestTokenForScriptAuthService=function(a,b){o[a]=b},this.clearRequestTokenForScriptAuthService=function(a){delete o[a]},this.serverStatusMessage=function(){return f},this.defaultErrorCallback=function(a,b){console.error&&console.error(a+": "+b)};var y=this.defaultErrorCallback;this.defaultSuccessCallback=function(a){console.log&&console.log(a)},this._toJSON=JSON.stringify,this._fromJSON=JSON.parse,this.AjaxParams=function(){this.dataType=null,this.contentType=null,this.contentLength=null,this.contentName=null,this.fileName=null,this.fileType=null,this.fileSize=null},this.setDefaultPermission=function(a,b,d){var e=w(a.ffUrl)+"/ffACL";c&&(e=c+e),z({type:"PUT",url:e,dataType:"json",contentType:"application/json",data:null,success:function(a){b&&b(a)},error:function(a){console.error&&console.error("FatFractal.setDefaultPermission "+a.status+", "+a.responseText),f="HTTP request failed - response code was "+a.status+" responseText was "+a.responseText,d&&d(a.status,a.responseText)}})},this.PermissionObject=function(a,b,c,d){this.readUsers=a?a:null,this.readGroups=b?b:null,this.writeUsers=c?c:null,this.writeGroups=d?d:null},this.setPermission=function(b,d,e,g,h,i,j){var k=new this.PermissionObject(d,e,g,h),l=w(b.ffUrl)+"/ffACL";c&&(l=c+l),z({type:"PUT",url:l,dataType:"json",contentType:"application/json",data:a._toJSON(k),success:function(a){i&&i(a)},error:function(a){console.error&&console.error("FatFractal.setPermission "+a.status+", "+a.responseText),f="HTTP request failed - response code was "+a.status+" responseText was "+a.responseText,j&&j(a.status,a.responseText)}})},this.grabBagGetAll=function(b,c,d,e){a.grabBagGetAllForQuery(b,c,null,d,e)},this.grabBagGetAllForQuery=function(b,c,d,e,f){var g=b.ffUrl+"/"+c;null!=d&&(g=g+"/("+d+")"),a.getArrayFromUri(g,e,f)},this.grabBagAdd=function(b,c,d,e,f){a.handleGrabBagRequest(b,c,d,!0,e,f)},this.grabBagRemove=function(b,c,d,e,f){a.handleGrabBagRequest(b,c,d,!1,e,f)},this.GrabBagAddOrRemoveObj=function(a,b){this.ffUrl=a?a:null,this.AddOrRemove=b?b:null},this.handleGrabBagRequest=function(b,d,e,g,h,i){if(!h)throw new Error("FatFractal.handleGrabBagRequest: successCallback not supplied");if(i||(i=a.defaultErrorCallback),!i)throw new Error("FatFractal.handleGrabBagRequest: errorCallback not supplied");var j=g?"ADD":"REMOVE",k=d.ffUrl+"/"+e,l=b.ffUrl,m=new this.GrabBagAddOrRemoveObj(l,j),n=w(k);c&&(n=c+n),z({type:"POST",url:n,dataType:"json",contentType:"application/json",data:a._toJSON(m),success:function(a){h&&h(a)},error:function(a){console.error&&console.error("FatFractal.handleGrabBagRequest "+a.status+", "+a.responseText),f="HTTP request failed - response code was "+a.status+" responseText was "+a.responseText,i&&i(a.status,a.responseText)}})},this.register=function(b,c,g){if(!c)throw new Error("FatFractal.register: successCallback not supplied");if(g||(g=a.defaultErrorCallback),!g)throw new Error("FatFractal.register: errorCallback not supplied");var h=this.getBaseUrl()+"ff/register";z({type:"POST",url:h,dataType:"json",contentType:"application/json",data:a._toJSON(b),success:function(a){null!=a.result&&null!=a.result.loggedInUser?(d=!0,e=a.result.loggedInUser,k=a.result.authResult.session.sessionId,K(e,k),c&&c(e)):g&&g(500,"No result.loggedInUser in response")},error:function(a){console.error&&console.error("FatFractal.register "+a.status+", "+a.responseText),f="HTTP request failed - response code was "+a.status+" responseText was "+a.responseText,g&&g(a.status,a.responseText)}})},this.registerWithScriptAuthService=function(a,b,c){var d=new RegisterRequest;d.authDomain="SCRIPT",d.scriptAuthService=a;var e=this.getTokenForScriptAuthService(a);d.token=e.token,d.secret=e.secret,this.register(d,b,c)},this.login=function(a,b,c,d){var e={userName:a,password:b};this.loginUsingCredential(e,c,d)},this.loginUsingConsoleCredentials=function(a,b,c,d){var e={authDomain:"FFCONSOLE",userName:a,password:b};this.loginUsingCredential(e,c,d)},this.loginWithScriptAuthService=function(a,b,c){var d=this.getTokenForScriptAuthService(a),e={authDomain:"SCRIPT",scriptAuthService:a,token:d.token,secret:d.secret};this.loginUsingCredential(e,b,c)},this.loginUsingCredential=function(b,c,g){if(!c)throw new Error("FatFractal.loginUsingConsoleCredentials: successCallback not supplied");if(g||(g=a.defaultErrorCallback),!g)throw new Error("FatFractal.loginUsingConsoleCredentials: errorCallback not supplied");var h={credential:b},i=this.getBaseUrl()+"ff/login";z({type:"POST",url:i,dataType:"json",contentType:"application/json",data:a._toJSON(h),success:function(a){null!=a.result&&null!=a.result.loggedInUser?(d=!0,e=a.result.loggedInUser,k=a.result.authResult.session.sessionId,K(e,k),c&&c(e)):g&&g(500,"No result.loggedInUser in response")},error:function(a){console.error&&console.error("FatFractal.login "+a.status+", "+a.responseText),f="HTTP request failed - response code was "+a.status+" responseText was "+a.responseText,g&&g(a.status,a.responseText)}})},this.logout=function(b,h){if(b||(b=a.defaultSuccessCallback),!b)throw new Error("FatFractal.logout: successCallback not supplied");if(h||(h=a.defaultErrorCallback),!h)throw new Error("FatFractal.logout: errorCallback not supplied");var i="ff/logout";c&&(i=c+"ff/logout"),z({type:"POST",url:i,dataType:"json",contentType:"application/json",success:function(a){d=!1,e=null,k=null,J(),g={},b&&b(a)},error:function(a){console.error&&console.error("FatFractal.logout "+a.status+", "+a.responseText),f="HTTP request failed - response code was "+a.status+" responseText was "+a.responseText,h&&h(a.status,a.responseText)}})},this.authUriForScriptAuthService=function(a,b,c){var d=this.getCallbackUriForScriptAuthService(a);if(!d)throw new Error("FatFractal.authUriForScriptAuthService: no callback URI found for ScriptAuth service "+a);var e=this.getBaseUrl()+"/ff/auth?action=getAuthUri&scriptAuthService="+a+"&callbackUri="+encodeURIComponent(d),g=this;z({type:"GET",url:e,dataType:"JSON",data:null,success:function(c){if(!c.result)throw new Error("FatFractal.authUriForScriptAuthService: response does not contain 'result'");var d=c.result.authorizationUri;if(!d)throw new Error("FatFractal.authUriForScriptAuthService: response does not contain 'authorizationUri'");var e=c.result.token,f=c.result.secret;e&&g.setRequestTokenForScriptAuthService(a,new Token(e,f)),b(d,c.statusMessage)},error:function(a){console.error&&console.error("FatFractal.authUriForScriptAuthService "+a.status+", "+a.responseText),f="HTTP request failed - response code was "+a.status+" responseText was "+a.responseText,c&&c(a.status,a.responseText)}})},this.retrieveAccessTokenForScriptAuthService=function(a,b,c,d){var e=this.getCallbackUriForScriptAuthService(a);if(!e)throw new Error("FatFractal.authUriForScriptAuthService: no callback URI found for ScriptAuth service "+a);var g=b.substr(b.indexOf("?")+1);g.indexOf("#")>=0&&(g=g.substr(0,g.indexOf("#")));var h=this.getBaseUrl()+"ff/auth?action=getToken&scriptAuthService="+a+"&callbackUri="+encodeURIComponent(e)+"&codeQuery="+encodeURIComponent(g),i=o[a];i?(h+="&token="+i.token+"&secret="+i.secret,delete o[a]):console.log("Did not find token");var j=this;z({type:"GET",url:h,dataType:"JSON",data:null,success:function(b){if(!b.result)throw new Error("FatFractal.authUriForScriptAuthService: response does not contain 'result'");if(!b.result.credential)throw new Error("FatFractal.authUriForScriptAuthService: response does not contain 'credential'");var d=b.result.credential.token;if(!d)throw new Error("FatFractal.authUriForScriptAuthService: response does not contain token");var e=b.result.credential.secret;j.setTokenForScriptAuthService(a,new Token(d,e)),c(null,b.statusMessage)},error:function(a){console.error&&console.error("FatFractal.retrieveAccessTokenForScriptAuthService "+a.status+", "+a.responseText),f="HTTP request failed - response code was "+a.status+" responseText was "+a.responseText,d&&d(a.status,a.responseText)}})};var A=function(a,b){for(var c in b)a[c]=b[c]};this.createObjAtUri=function(b,d,e,j){function l(a){if(a&&a.constructor&&a.constructor.toString){var b=a.constructor.toString().match(/function\s*(\w+)/);if(b&&2==b.length)return b[1]}return void 0}var k=this;if(i&&console.log("FatFractal.createObjAtUri was called."),e||(e=a.defaultSuccessCallback),!e)throw new Error("FatFractal.createObjAtUri: successCallback not supplied");if(j||(j=a.defaultErrorCallback),!j)throw new Error("FatFractal.createObjAtUri: errorCallback not supplied");var m=l(b);b.clazz?console.log("object has clazz defined: "+b.clazz):m?b.clazz=m:console.error&&console.error("cannot resolve the class name for this object"),i&&console.log("FatFractal.createObjAtUri thinks this class is: "+m+".");var n=F(b),o=b.ffUrl,p=w(d);c&&(p=c+p),z({type:"POST",url:p,dataType:"json",contentType:"application/json",data:n,success:function(a){function l(a,b,c){i&&console.log("pendingBlobs is "+JSON.stringify(b,null,2));var d=b.shift();d?(i&&console.log("blob is "+JSON.stringify(d)),i&&console.log("FatFractal.createObjAtUri will save a blob called: "+d.name),i&&console.log("FatFractal.createObjAtUri is saving a blob with byteLength : "+d.blob.byteLength+" bytes: "),k.updateBlobForObj(a,d.blob,d.name,null,function(a){l(a,b,c)},function(a,b){j(a,"Failed to upload blob member: "+b)})):c(a)}i&&console.log("FatFractal.createObjAtUri: CREATE response is "+u(a)),A(b,a.result),i&&console.log("FatFractal.createObjAtUri: Adding object to local cache"),g[a.result.ffUrl]=b;var c=h[o];if(c){var d=[];for(var f in c)d.push({name:f,blob:c[f]});l(b,d,function(){C(b,function(){e(b,a.statusMessage)})})}else C(b,function(){e(b,a.statusMessage)})},error:function(a){console.error&&console.error("FatFractal.createObjAtUri "+a.status+", "+a.responseText),f="HTTP request failed - response code was "+a.status+" responseText was "+a.responseText,j(a.status,a.responseText)}})},this.updateObj=function(b,d,e){if(d||(d=a.defaultSuccessCallback),!d)throw new Error("FatFractal.updateObj: successCallback not supplied");if(e||(e=a.defaultErrorCallback),!e)throw new Error("FatFractal.updateObj: errorCallback not supplied");if(!b.ffUrl)throw new Error("Cannot update this object - doesn't have FatFractal metadata");var h=F(b),j=w(b.ffUrl);c&&(j=c+j),z({type:"PUT",url:j,dataType:"json",contentType:"application/json",data:h,success:function(a){i&&console.log("FatFractal.updateObj: UPDATE response is "+u(a)),A(b,a.result),i&&console.log("FatFractal.updateObj: Updating local cache"),g[a.result.ffUrl]=b,C(b),d(b,a.statusMessage)},error:function(a){console.error&&console.error("FatFractal.updateObj "+a.status+", "+a.responseText),f="HTTP request failed - response code was "+a.status+" responseText was "+a.responseText,e&&e(a.status,a.responseText)}})},this.updateBlobForObj=function(b,d,e,g,h,j){if(!b)throw new Error("updateBlobForObj - obj argument must be supplied");if(!b.ffUrl)throw new Error("updateBlobForObj - obj argument does not have ffUrl field");if("string"!=typeof b.ffUrl)throw new Error("updateBlobForObj - obj.ffUrl should be a string");if(!e||"string"!=typeof e||0==e.length)throw new Error("updateBlobForObj - memberName not supplied");if(!d||!d.byteLength||0==d.byteLength)throw new Error("updateBlobForObj - blob not supplied");if(h||(h=a.defaultSuccessCallback),!h)throw new Error("FatFractal.updateBlobForObj: successCallback not supplied");if(j||(j=a.defaultErrorCallback),!j)throw new Error("FatFractal.updateBlobForObj: errorCallback not supplied");if(i&&console.log("FatFractal.updateBlobForObj "+b.ffUrl+" memberName "+e+" mimeType "+g),g&&g.length&&0!=g.length||(g="application/octet-stream"),d.byteLength>0){var k=w(b.ffUrl);c&&(k=c+k),z({type:"PUT",url:k+"/"+e,dataType:g,contentType:g,data:d,success:function(a){i&&console.log("FatFractal.updateBlobForObj "+b.ffUrl+" memberName "+e+" : response status "+a.statusMessage),A(b,a.result),h(b,a.statusMessage)},error:function(a){console.error&&console.error("FatFractal.updateBlobForObj "+a.status+", "+a.responseText),f="HTTP request failed - response code was "+a.status+" responseText was "+a.responseText,j&&j(a.status,a.responseText)}})}},this.deleteBlobForObj=function(b,d,e,g){if(!b)throw new Error("deleteBlobForObj - obj argument must be supplied");if(!b.ffUrl)throw new Error("deleteBlobForObj - obj argument does not have ffUrl field");if("string"!=typeof b.ffUrl)throw new Error("deleteBlobForObj - obj.ffUrl should be a string");if(!d||"string"!=typeof d||0==d.length)throw new Error("deleteBlobForObj - memberName not supplied");if(!e)throw new Error("FatFractal.deleteBlobForObj: successCallback not supplied");if(g||(g=a.defaultErrorCallback),!g)throw new Error("FatFractal.deleteBlobForObj: errorCallback not supplied");i&&console.log("FatFractal.deleteBlobForObj "+b.ffUrl+" memberName "+d);var h=w(b.ffUrl);c&&(h=c+h),z({type:"DELETE",url:h+"/"+d,dataType:"json",success:function(a){console.log&&console.log("FatFractal.deleteBlobForObj "+b.ffUrl+" memberName "+d+" : response status "+a.status+", "+a.responseText),e(b,a.statusMessage)},error:function(a){console.error&&console.error("FatFractal.deleteBlobForObj "+a.status+", "+a.responseText),f="HTTP request failed - response code was "+a.status+" responseText was "+a.responseText,g&&g(a.status,a.responseText)}})},this.deleteObj=function(b,d,e){if(d||(d=a.defaultSuccessCallback),!d)throw new Error("FatFractal.deleteObj: successCallback not supplied");if(e||(e=a.defaultErrorCallback),!e)throw new Error("FatFractal.deleteObj: errorCallback not supplied");if(!b.ffUrl)throw new Error("Cannot delete this object - doesn't have FatFractal metadata");var h=w(b.ffUrl);c&&(h=c+h),z({type:"DELETE",url:h,dataType:"json",data:null,success:function(a){i&&console.log("FatFractal.deleteObj: Removing deleted object from local cache"),delete g[b.ffUrl],d(a.statusMessage)},error:function(a){console.error&&console.error("FatFractal.deleteObj "+a.status+", "+a.responseText),f="HTTP request failed - response code was "+a.status+" responseText was "+a.responseText,e&&e(a.status,a.responseText)}})},this.postObjToExtension=function(b,c,d,e){if(d||(d=a.defaultSuccessCallback),!d)throw new Error("FatFractal.postObjToExtension: successCallback not supplied");if(e||(e=a.defaultErrorCallback),!e)throw new Error("FatFractal.postObjToExtension: errorCallback not supplied");var g=w(c,"extension");this.createObjAtUri(b,g,function(a,b){d(a,b)},function(a,b){console.error&&console.error("FatFractal.postObjToExtension "+a+", "+b),f="HTTP request failed - response code was "+a+" responseText was "+b,e&&e(a,b)})},this.getObjFromExtension=function(a,b,c){var d=w(a,"extension");this.getArrayFromUri(d,function(a){var c=null;if(a.length>1)throw"getObjFromExtension received "+a.length+" objects from the server. Suggest use getArrayFromExtension() instead.";a.length>0&&(c=a[0]),b(c,a.statusMessage)},function(a,b){console.error&&console.error("FatFractal.getObjFromExtension "+a+", "+b),f="HTTP request failed - response code was "+a+" responseText was "+b,c&&c(a,b)})},this.getArrayFromExtension=function(a,b,c){var d=w(a,"extension");this.getArrayFromUri(d,function(a){b(a,a.statusMessage)},function(a,b){console.error&&console.error("FatFractal.getArrayFromExtension "+a+", "+b),f="HTTP request failed - response code was "+a+" responseText was "+b,c&&c(a,b)})},this.getObjFromUri=function(b,c,d){if(!c)throw new Error("FatFractal.getObjFromUri: successCallback not supplied");if(d||(d=a.defaultErrorCallback),!d)throw new Error("FatFractal.getObjFromUri: errorCallback not supplied");var e=w(b,"resources");this.getArrayFromUri(e,function(a){var b=null;a.length>0&&(b=a[0]),c(b,a.statusMessage)},function(a,b){console.error&&console.error("FatFractal.getObjFromUri.getArrayFromUri "+a+", "+b),f="HTTP request failed - response code was "+a+" responseText was "+b,d&&d(a,b)})};var B=function(a,b){var c=g[a.ffUrl];if(null==c)i&&console.log("FatFractal.getArrayFromUri: Adding "+a.ffUrl+" to cache"),g[a.ffUrl]=a;else{i&&console.log("FatFractal.getArrayFromUri: Updating existing "+a.ffUrl+" in cache");for(d in c)c[d]=null;for(var d in a)c[d]=a[d]}a=g[a.ffUrl],C(a,b)};this.getArrayFromUri=function(b,d,e){if(!d)throw new Error("FatFractal.getArrayFromUri: successCallback not supplied");if(e||(e=a.defaultErrorCallback),!e)throw new Error("FatFractal.getArrayFromUri: errorCallback not supplied");var h=w(b);c&&(h=c+h),z({type:"GET",url:h,dataType:"json",data:null,success:function(a){function n(c,e){h[c]&&(h[c].count--,0===h[c].count&&delete h[c]),l++,j&&console.log("getArrayFromUri.incrThingsDone for "+b+" : "+c+" : "+e+" : "+l+"/"+f+" remaining: "+JSON.stringify(h,null,2)),i&&console.log("thingsDone for "+b+" : "+l+"/"+f),l===f&&d(m,a.statusMessage)}var c;c=null===a||null===a.result?[]:Array.isArray(a.result)?a.result:[a.result];for(var e=a.references,f=(e?e.length:0)+2*c.length,h={},k=0;k<c.length;k++)c[k].ffUrl&&(h[c[k].ffUrl]={count:2});var l=0,m=[];if(j&&console.log("getArrayFromUri starting: "+b+" : "+l+"/"+f+" remaining: "+JSON.stringify(h,null,2)),e)for(var o=0;o<e.length;o++)B(e[o],function(){n()});for(k=0;k<c.length;k++)c[k].ffUrl?(B(c[k],function(a,b){n(a,"processResultCallback from "+b)}),m.push(g[c[k].ffUrl]),n(c[k].ffUrl,"Just because")):(m.push(c[k]),n(c[k].ffUrl,"Once"),n(c[k].ffUrl,"Twice"));0===f&&d(m,a.statusMessage)},error:function(a){console.error&&console.error("FatFractal.getArrayFromUri "+a.status+", "+a.responseText),f="HTTP request failed - response code was "+a.status+" responseText was "+a.responseText,e&&e(a.status,a.responseText)}})},this.executeFFDL=function(b,c,d){if(c||(c=a.defaultSuccessCallback),!c)throw new Error("FatFractal.executeFFDL: successCallback not supplied");if(d||(d=a.defaultErrorCallback),!d)throw new Error("FatFractal.executeFFDL: errorCallback not supplied");var e=this.getBaseUrl()+"ff/metadata";z({type:"POST",url:e,dataType:"json",contentType:"application/json",data:a._toJSON({ffdl:b}),success:function(a){c(a)},error:function(a){d&&d(a)}})},this.getFFDL=function(b,c){if(!b)throw new Error("FatFractal.getFFDL: successCallback not supplied");if(c||(c=a.defaultErrorCallback),!c)throw new Error("FatFractal.getFFDL: errorCallback not supplied");var d=this.getBaseUrl()+"ff/metadata";z({type:"GET",url:d,dataType:"json",data:null,success:function(a){b(a.result)},error:function(a){c&&c(a)}})},this.forgetObj=function(a){if(null==a||null==a.ffUrl)throw"forgetObj: An object with an ffUrl field must be supplied";i&&console.log("forgetObj: forgetting object "+a.ffUrl),delete g[a.ffUrl]},this.getFromInMemCache=function(a){return g[a]};var C=function(a,b){function c(){i&&console.log("m_loadAllReferences for "+a.ffUrl+" DONE"),b&&b(a.ffUrl,"Load All References")}function f(){e++,i&&console.log("loaded refs: "+e+"/"+d),e===d&&c()}if(p)if(null!=a.ffRefs&&0!=a.ffRefs.length){i&&console.log("m_loadAllReferences: Iterating over references: "+u(a.ffRefs));for(var d=a.ffRefs.length,e=0,h=0;d>e&&h<a.ffRefs.length;h++){var j=a.ffRefs[h],k=g[j.url];k?(a[j.name]=k,i&&console.log("m_loadAllReferences: Found cached reference for : "+u(j)),f()):(i&&console.log("m_loadAllReferences: Loading reference: "+u(j)+" for "+a.ffUrl),D(j,a,f))}}else c();else c()},D=function(b,d,e){function f(){i&&console.log("m_loadReference Calling done for reference "+u(b)+" of obj "+d.ffUrl),e&&e(d.ffUrl,"Load One Reference")}i&&console.log("m_loadReference: referringObj = "+JSON.stringify(d));var h=g[b.url];if(null==h)if(("FFO"==b.type||"FFB"==b.type&&q)&&(h={ffUrl:b.url},g[b.url]=h,d[b.name]=h),i&&console.log("m_loadReference: refItem.url is - "+b.url),"FFO"==b.type)a.getObjFromUri(b.url,function(a){if(!a)return console.error&&console.error("Reference for ["+b.url+"] was not returned to m_loadReference's success block"),f(),void 0;i&&console.log("Loaded reference: "+u(a));for(var c in a)h[c]=a[c];f()},function(){console.error&&console.error("Warning: Failed to load reference: "+u(b)),f()});else if("FFB"==b.type)if(q)if(t){i&&console.log("Warning: Attempting to load a blob: "+u(b));var j=w(d.ffUrl);c&&(j=c+j);var k=new XMLHttpRequest;k.open("GET",j+"/"+b.name,!0),k.responseType="arraybuffer",k.onload=function(){var c=k.response;if(i&&console.log("FatFractal.m_loadReference: arrayBuffer.byteLength "+c.byteLength),c){var e=new Uint8Array(c);d[b.name]=e,g[b.url]=e}f()},k.send(null)}else console.error&&(console.error("FatFractal.m_loadReference: browser does not support XMLHttpRequest version 2, cannot load blob as data."),f());else i&&console.log("FatFractal.m_loadReference: autoLoadBlobs is false so NOT loading "+u(b)),f();else console.error&&(console.error("FatFractal.m_loadReference: for "+b.url+" cannot determine the type of reference"),f());else console.error&&console.error("FatFractal.m_loadReference: for "+b.url+" called but the object is already in cache"),d[b.name]=h,f()},E=1e6,F=function(b){b.ffRefs&&delete b.ffRefs;var c={},d=!1,e=!1,f=null;b.ffUrl||(b.ffUrl=""+E++),h[b.ffUrl]&&delete h[b.ffUrl];for(var g in b){var j=b[g];i&&console.log("m_transformReferencesForPersistence: Checking if "+g+" ("+typeof j+") is a reference"),null!=j&&"object"==typeof j&&(i&&console.log("m_transformReferencesForPersistence: Found non-null : "+u(j)),null!=j.ffUrl&&""!=j.ffUrl?(i&&console.log("m_transformReferencesForPersistence: Found object field ["+g+"] : "+j.ffUrl+" - treating as reference"),c[g]=j.ffUrl,d=!0):j.byteLength&&(i&&console.log("m_transformReferencesForPersistence: Found BLOB for field : "+g),f=h[b.ffUrl],f||(f={},h[b.ffUrl]=f),f[g]=j,e=!0))}var k={};for(var l in b)k[l]=b[l];if(d){k.ffRefs=[];for(var m in c)delete k[m],k.ffRefs.push({name:m,type:"FFO",url:c[m]})}if(e&&f)for(var n in f)delete k[n];return a._toJSON(k)},H=this;return this}