var Ractive; require('./utils/ractive-provider').onLoad(function(loadedRactive) { Ractive = loadedRactive;});
var URLs = require('./utils/urls');
var XDMClient = require('./utils/xdm-client');
var SVGs = require('./svgs');

var pageSelector = '.antenna-login-page';

function createPage(options) {
    var groupSettings = options.groupSettings;
    var goBack = options.goBack;
    var retry = options.retry;
    var element = options.element;
    var ractive = Ractive({
        el: element,
        append: true,
        data: {
            loginPageUrl: computeLoginPageUrl(groupSettings)
        },
        template: require('../templates/login-page.hbs.html'),
        partials: {
            left: SVGs.left
        }
    });
    XDMClient.setMessageHandler("close login panel", function() {
        retry();
    });
    XDMClient.setMessageHandler("getUserLoginState", function() {
        retry();
    });
    ractive.on('back', function() {
        XDMClient.setMessageHandler("close login panel", undefined);
        XDMClient.setMessageHandler("getUserLoginState", undefined);
        goBack();
    });
    return {
        selector: pageSelector,
        teardown: function() {
            ractive.teardown();
            XDMClient.setMessageHandler("close login panel", undefined);
            XDMClient.setMessageHandler("getUserLoginState", undefined);
        }
    };
}

function computeLoginPageUrl(groupSettings) {
    return URLs.appServerUrl() + URLs.loginPageUrl() +
        '?parentUrl=' + window.location.href +
        '&parentHost=' + window.location.protocol + "//" + window.location.host +
        '&group_id=' + groupSettings.groupId() +
        '&group_name=' + groupSettings.groupName();
}

//noinspection JSUnresolvedVariable
module.exports = {
    createPage: createPage
};