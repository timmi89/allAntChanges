function getWindowProps(a){a=a||{};var b=a.width||400,c=a.height||350,d=window.screen.width/2-b/2,e=window.screen.height/2-c/2;return"menubar=1,resizable=1,scrollbars=yes,width="+b+",height="+c+",top="+e+",left="+d}var qs=(window.location.search+window.location.hash).substr(1).split("&"),qs_args=[];for(var i in qs){var this_arg=qs[i].split("=");qs_args[this_arg[0]]=this_arg[1]}"undefined"==typeof qs_args.group_id&&(qs_args.group_id="");var trackingUrl="local.readrboard.com"!=document.domain?"http://readrboard-events.appspot.com/":"http://localhost:8080";window.RDRAuth={isOffline:"local.readrboard.com"==document.domain,rdr_user:{},popups:{},openGenericLoginWindow:function(a){var b=getWindowProps(a);return RDRAuth.checkRBLoginWindow(),RDRAuth.popups.loginWindow=window.open(RDR_baseUrl+"/login/","readr_login",b),RDRAuth.popups.loginWindow.focus(),!1},openFBLoginWindowFromPopup:function(){return RDRAuth.closeWindowOnSuccess=!0,RDRAuth.doFBLogin(),!1},openRbLoginWindow:function(a){var b=getWindowProps(a);return RDRAuth.checkRBLoginWindow(),RDRAuth.popups.loginWindow=window.open(RDR_baseUrl+"/rb_login/","readr_login",b),RDRAuth.popups.loginWindow.focus(),!1},openRbCreateNewAccountWindow:function(a,b){var c=getWindowProps(a);return RDRAuth.checkRBLoginWindow(),RDRAuth.popups.loginWindow=window.open(RDR_baseUrl+"/user_create/","readr_create_user",c),RDRAuth.popups.loginWindow.focus(),b&&window.close(),!1},openRbForgotPasswordWindow:function(a){var b=getWindowProps(a);return RDRAuth.checkRBLoginWindow(),RDRAuth.popups.loginWindow=window.open(RDR_baseUrl+"/request_password/","readr_forgot_pw",b),RDRAuth.popups.loginWindow.focus(),!1},openRbAvatarUploadWindow:function(a){var b=getWindowProps(a);return RDRAuth.popups.loginWindow=window.open(RDR_baseUrl+"/user_modify/","readr_avatar_upload",b),RDRAuth.checkRBLoginWindow(),RDRAuth.popups.loginWindow.focus(),!1},events:{track:function(a){var b="";RDRAuth.rdr_user&&RDRAuth.rdr_user.user_id&&(b+="||uid::"+RDRAuth.rdr_user.user_id),qs_args&&qs_args.group_id&&(b+="||gid::"+qs_args.group_id);var c=a+b,d=$('<img src="'+RDR_baseUrl+"/static/widget/images/event.png?"+c+'" />');$("#rdr_event_pixels").append(d),RDRAuth.isOffline},trackEventToCloud:function(a){return $.ajax({url:trackingUrl,type:"get",contentType:"application/json",dataType:"jsonp",data:{json:$.toJSON(a)},success:function(){}}),void 0},helpers:{trackFBLoginAttempt:function(){var a="FBLogin attempted";RDRAuth.events.track(a),RDRAuth.events.trackEventToCloud({event_type:"login attempt facebook",event_value:"start"})},trackFBLoginFail:function(){var a="FBLogin failed or was canceled";RDRAuth.events.track(a),RDRAuth.events.trackEventToCloud({event_type:"login attempt facebook",event_value:"fail"})},trackRBLoginAttempt:function(){var a="RBLogin attempted";RDRAuth.events.track(a),RDRAuth.events.trackEventToCloud({event_type:"login attempt readrboard",event_value:"start"})},trackRBLoginFail:function(){return}}},postMessage:function(a){"function"==typeof $.postMessage&&$.postMessage(a.message,qs_args.parentUrl,parent)},notifyParent:function(a,b){a.status=b,RDRAuth.postMessage({message:JSON.stringify(a)})},getUser:function(){if(RDRAuth.readUserCookie(),RDRAuth.rdr_user.readr_token){if(RDRAuth.rdr_user.readr_token){var a={data:{first_name:RDRAuth.rdr_user.first_name,full_name:RDRAuth.rdr_user.full_name,img_url:RDRAuth.rdr_user.img_url,user_id:RDRAuth.rdr_user.user_id,readr_token:RDRAuth.rdr_user.readr_token,user_boards:RDRAuth.rdr_user.user_boards}};RDRAuth.notifyParent(a,"returning_user")}}else RDRAuth.createTempUser()},getReadrToken:function(a,b){if(a){var c=a.authResponse?a.authResponse:a,d={fb:c,group_id:qs_args.group_id?qs_args.group_id:1,user_id:RDRAuth.rdr_user.user_id,readr_token:RDRAuth.rdr_user.readr_token};$.ajax({url:"/api/fb/",type:"get",contentType:"application/json",dataType:"jsonp",data:{json:JSON.stringify(d)},success:function(a){"fail"==a.status?RDRAuth.createTempUser():(RDRAuth.setUser(a),RDRAuth.returnUser(),RDRAuth.notifyParent({},"close login panel"),b&&b())},error:function(){RDRAuth.createTempUser()}})}else RDRAuth.doFBLogin()},createTempUser:function(){if(parent.location!=window.location)if(!RDRAuth.rdr_user.user_id&&!RDRAuth.rdr_user.readr_token||RDRAuth.rdr_user.user_id&&RDRAuth.rdr_user.readr_token&&!RDRAuth.rdr_user.temp_user){var a={group_id:qs_args.group_id};$.ajax({url:"/api/tempuser/",type:"get",contentType:"application/json",dataType:"jsonp",data:{json:JSON.stringify(a)},success:function(a){RDRAuth.setUser(a);var b={data:{first_name:RDRAuth.rdr_user.first_name,full_name:RDRAuth.rdr_user.full_name,img_url:RDRAuth.rdr_user.img_url,user_id:RDRAuth.rdr_user.user_id,readr_token:RDRAuth.rdr_user.readr_token,user_boards:RDRAuth.rdr_user.user_boards}};RDRAuth.notifyParent(b,"got_temp_user")}})}else{var a={data:{first_name:RDRAuth.rdr_user.first_name,full_name:RDRAuth.rdr_user.full_name,img_url:RDRAuth.rdr_user.img_url,user_id:RDRAuth.rdr_user.user_id,readr_token:RDRAuth.rdr_user.readr_token,user_boards:RDRAuth.rdr_user.user_boards}};RDRAuth.notifyParent(a,"got_temp_user")}},reauthUser:function(){($.cookie("user_type")&&"facebook"==$.cookie("user_type")||!$.cookie("user_type"))&&(RDRAuth.readUserCookie(),FB.getAuthResponse()?RDRAuth.killUser(function(a){RDRAuth.getReadrToken(a)}):FB.getLoginStatus(function(a){a&&"connected"==a.status?RDRAuth.killUser(function(a){RDRAuth.getReadrToken(a)},a):RDRAuth.notifyParent({},"fb_user_needs_to_login")}))},quickFixAjaxLogout:function(){$("#group_settings_menu").hide(),$("#logged-in").hide(),$("#logged-out").css({display:"block",visibility:"visible"})},checkFBStatus:function(){FB.getLoginStatus(function(a){if(a.status&&"connected"==a.status){if(RDRAuth.checkIfWordpressRefresh())return;if(RDRAuth.closeWindowOnSuccess&&window.close(),top==self)if($.cookie("user_id")||RDRAuth.rdr_user&&RDRAuth.rdr_user.user_id){$.cookie("user_id")?$.cookie("user_id"):RDRAuth.rdr_user.user_id;var c=RDRAuth.rdr_user.img_url;$("#logged-in").show().css("visibility","visible"),$("#logged-out").hide().css("visibility","hidden"),FB.api("/me",function(a){if($("#fb-login-button a.logging-in").length){if($("#fb-login-button a").hasClass("logging-in"))return window.location.reload(),void 0;var b=$("<a/>"),d=$("<img/>"),e=$("<strong/>");b.attr("href","/user/"+f),d.attr("src",c+"?type=square"),e.text(a.name),b.append(d,e);var f=$.cookie("user_id"),g=$('<div id="log-out-link" />');g.append('<a href="/user/'+f+'">My Activity</a>'+'<a href="/follows/'+f+'">Activity I Follow</a>'+'<a href="javascript:void(0);" onclick="RDRAuth.logout();">Log Out</a>'+"<h5>Settings</h5>"+'<label for="private_profile">'+"(Reload the page to edit your setttings.)"+"</label>"),$("#logged-in").html(b).append(g)}})}else RDRAuth.getReadrToken(a.authResponse,function(){});else $("#logged-in").show().css("visibility","visible"),$("#logged-out").hide().css("visibility","hidden"),RDRAuth.returnUser()}else top==self&&($("#logged-in").hide().css("visibility","hidden"),$("#logged-out").show().css("visibility","visible"))})},FBLoginCallback:function(a){a.authResponse?RDRAuth.getReadrToken(FB.getAuthResponse(),function(){RDRAuth.checkFBStatus()}):RDRAuth.events.helpers.trackFBLoginFail()},checkIfWordpressRefresh:function(){var a=function(){var a=window.location.search;return a.search(/hostplatform=wordpress/i)>0}();if(a){var b="/wordpress_edit/",c=window.location.search||"?";c+="&refresh=true";var d=b+c;return window.location=d,!0}return!1},checkRBLoginWindow:function(){RDRAuth.checkingRBLoginWindow||(RDRAuth.checkingRBLoginWindow=setInterval(function(){if(RDRAuth.popups.loginWindow&&RDRAuth.popups.loginWindow.closed){if(RDRAuth.readUserCookie(),RDRAuth.returnUser(),RDRAuth.notifyParent({},"close login panel"),RDRAuth.popups.loginWindow.close(),clearInterval(RDRAuth.checkingRBLoginWindow),RDRAuth.checkIfWordpressRefresh())return;top==self&&window.location.reload()}},250))},setUser:function(a){RDRAuth.rdr_user={},a.data=a.data||{},RDRAuth.rdr_user.temp_user=a.data.first_name||a.data.full_name?!1:!0,RDRAuth.rdr_user.readr_token=a.data.readr_token,RDRAuth.rdr_user.user_id=a.data.user_id,RDRAuth.rdr_user.full_name=a.data.full_name,RDRAuth.rdr_user.first_name=a.data.full_name,RDRAuth.rdr_user.img_url=a.data.img_url,RDRAuth.rdr_user.user_type=a.data.user_type,RDRAuth.rdr_user.user_boards=JSON.stringify(a.data.user_boards);var b=new Date;b.setMinutes(b.getMinutes()+60);var c=90;$.cookie("temp_user",RDRAuth.rdr_user.temp_user,{expires:c,path:"/"}),$.cookie("readr_token",RDRAuth.rdr_user.readr_token,{expires:c,path:"/"}),$.cookie("user_id",RDRAuth.rdr_user.user_id,{expires:c,path:"/"}),$.cookie("user_type",RDRAuth.rdr_user.user_type,{expires:c,path:"/"})},readUserCookie:function(){RDRAuth.rdr_user.temp_user=$.cookie("temp_user"),RDRAuth.rdr_user.readr_token=$.cookie("readr_token"),RDRAuth.rdr_user.user_id=$.cookie("user_id"),RDRAuth.rdr_user.user_type=$.cookie("user_type")},returnUser:function(){if(RDRAuth.readUserCookie(),top==self){if($.cookie("user_type")&&"facebook"==$.cookie("user_type"))RDRAuth.checkFBStatus();else if($.cookie("user_id")){$("#logged-in").show().css("visibility","visible"),$("#logged-out").hide().css("visibility","hidden");var a=$("<a/>"),b=$("<strong/>");a.attr("href","/user/"+$.cookie("user_id"));var c="friend";b.text(c),a.append(b)}}else{var d={data:{first_name:RDRAuth.rdr_user.first_name,full_name:RDRAuth.rdr_user.full_name,img_url:RDRAuth.rdr_user.img_url,user_id:RDRAuth.rdr_user.user_id,readr_token:RDRAuth.rdr_user.readr_token,user_type:RDRAuth.rdr_user.user_type}};RDRAuth.notifyParent(d,"returning_user")}},killUser:function(a,b){if(RDRAuth.rdr_user&&"false"==RDRAuth.rdr_user.temp_user){var c={user_id:RDRAuth.rdr_user.user_id,readr_token:RDRAuth.rdr_user.readr_token};$.ajax({url:"/api/deauthorize/",type:"get",contentType:"application/json",context:{callback_args:b},dataType:"jsonp",data:{json:JSON.stringify(c)},success:function(){RDRAuth.clearSessionCookies(),RDRAuth.rdr_user={},a&&this.callback_args?a(this.callback_args):a&&a()}})}else RDRAuth.clearSessionCookies(),a&&b?a(b):a&&a()},clearSessionCookies:function(){$.cookie("temp_user",null,{path:"/"}),$.cookie("readr_token",null,{path:"/"}),$.cookie("user_id",null,{path:"/"}),$.cookie("user_type",null,{path:"/"}),$.cookie("rdr_session",null,{path:"/"}),$.cookie("rdr_user",null,{path:"/"})},doFBLogin:function(){RDRAuth.events.helpers.trackFBLoginAttempt(),FB.login(function(a){RDRAuth.FBLoginCallback(a)},{scope:"email"})},doRBLogin:function(){RDRAuth.events.helpers.trackRBLoginAttempt(),RDRAuth.openRbLoginWindow()},doRBlogout:function(){RDRAuth.killUser(function(){window.location.reload()})},logout:function(){$.cookie("user_type")&&"facebook"==$.cookie("user_type")?FB.getLoginStatus(function(a){a?FB.logout(function(){RDRAuth.killUser(function(){window.location.reload()})}):RDRAuth.killUser(function(){window.location.reload()})}):RDRAuth.killUser(function(){window.location.reload()})},init:function(){RDRAuth.notifyParent({},"xdm loaded"),$.cookie("user_type")&&"facebook"==$.cookie("user_type")?FB.getLoginStatus(function(a){a.status&&"connected"==a.status?RDRAuth.getReadrToken(a.authResponse,function(){}):RDRAuth.killUser(function(){})}):RDRAuth.returnUser()},decodeDjangoCookie:function(a){return a?a.replace(/"/g,"").replace(/\\054/g,",").replace(/\\073/g,";"):void 0}},$(document).ready(function(){window.fb_loader.done(function(){RDRAuth.init()}),window.fb_loader.done(function(){"function"==typeof $.receiveMessage&&$.receiveMessage(function(a){var c,d,b={registerEvent:"register-event::"};"getUser"==a.data?RDRAuth.getUser():"reloadXDMframe"==a.data?window.location.reload():"reauthUser"==a.data?RDRAuth.reauthUser():"returnUser"==a.data?RDRAuth.returnUser():"killUser"==a.data?RDRAuth.killUser():"TESTIT"==a.data?RDRAuth.testMessage():-1!=a.data.indexOf("page_hash")?$.cookie("page_hash",a.data.split("|")[1],{expires:365,path:"/"}):-1!=a.data.indexOf(b.registerEvent)&&(c=a.data.split(b.registerEvent)[1],d=$.parseJSON(c),RDRAuth.events.trackEventToCloud(d))},qs_args.parentHost)})});