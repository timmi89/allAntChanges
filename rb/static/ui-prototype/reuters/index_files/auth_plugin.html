

var isWebTrendsInitialized = false;
var isWebTrendsImageOverrided = false;
var _tr_commerce_webTrends_tag ;

if (!isWebTrendsInitialized  && typeof(WebTrends) != 'undefined' && (WebTrends != null)){
	WebTrends.prototype.dcsCreateImage=function(dcsSrc){
	  if (document.images){
	    this.images[this.index]=new Image();
	    this.images[this.index].onload = trWebTrendCallBack;
	    this.images[this.index].src=dcsSrc;
	    this.index++;
	  }
	  else{
	    document.write('<IMG ALT="" BORDER="0" NAME="DCSIMG" WIDTH="1" HEIGHT="1" SRC="'+dcsSrc+'">');
	  }
	}
	isWebTrendsImageOverrided = true;
	_tr_commerce_webTrends_tag = new WebTrends();
	_tr_commerce_webTrends_tag.dcsGetId();
	isWebTrendsInitialized = true;
}
trWebTrendCallBack = function(){
} 

var registeredCookieValue =  YAHOO.util.Cookie.get("ruus");
if(registeredCookieValue != null && registeredCookieValue != 'undefined'){
	document.write('<META  name="WT.z_registered" content=' + encodeURIComponent(registeredCookieValue) + '>');
}

var isWebTrendsSrcTrtExists = false; 
var _tr_commerce_webtrends_source = '';
var _tr_commerce_webtrends_target = '';
var _tr_defaultSite = "US_SITE";

function createMetaEle(name,content,id){
    meta = document.createElement('meta');
	meta.name = name;
	meta.content = content;
	if (id != null && id != ''){
		meta.id = '_tr_webTrends_WT_z_li';	
	}
	document.getElementsByTagName('head')[0].appendChild(meta);
}


 var _tr_sourcePatternList = '${1},[a-zA-z0-9.%:/&]+&regsrc=([a-zA-z0-9_]{1,30});;US_SITE,http://www\.reuters\.com;; US_PORTFOLIO,http://portfolio\.us\.;; US_NEWSLETTER,https://commerce\.us\.reuters\.com/([a-zA-Z0-9/]+)/newsletter/;; US_ARTICLE,http://www\.reuters\.com/article/;; US_COMMENTS,http://blogs\.reuters\.com/;; US_RESEARCH_REPORTS,https://commerce\.us\.reuters\.com/purchase/;; US_FUNDS,http://funds\.us\.reuters\.com/;; US_ALERTS,http://alerts\.us\.reuters\.com/;;  US_test_js,http://test.com';

 var _tr_targetPatternList = 'US_SITE,http://www\.reuters\.com;; US_PORTFOLIO,http://portfolio\.us\.;; US_NEWSLETTER,https://commerce\.us\.reuters\.com/([a-zA-Z0-9/]+)/newsletter/;; US_ARTICLE,http://www\.reuters\.com/article/;; US_COMMENTS,http://blogs\.reuters\.com/;; US_RESEARCH_REPORTS,https://commerce\.us\.reuters\.com/purchase/;; US_FUNDS,http://funds\.us\.reuters\.com/;; US_ALERTS,http://alerts\.us\.reuters\.com/;;  ';

_tr_defaultSite = 'US_UNKNOWN';




function getSrcTagUrl(goUrl, patternString){
	patternTestArray = patternString.split(";;");
	goUrl = decodeURIComponent(goUrl);
	patternArylength = patternTestArray.length;
	for(i=0;i<patternArylength; i++ ){
		var patternTest = patternTestArray[i];
		patternTest = patternTest.replace(/\./g, "\\\.");
		var pattern;
		var resultStr;
		if(patternTest.split(",").length==2){
			pattern = new RegExp(patternTest.split(",")[1]);
			resultStr = patternTest.split(",")[0];			
		}else if(patternTest.split(",").length==3){
			pattern = new RegExp(patternTest.split(",")[1]+","+patternTest.split(",")[2]);
			resultStr = patternTest.split(",")[0];
		}else{
			return null;
		}
		if(pattern.test(goUrl)){
			if("1"==resultStr){
				resultStr = goUrl.match(pattern)[1];
			}
			return resultStr;
		}
	}
	return null;
}


var trOverlayResources='';
trOverlayResources += '<link href="https://commerce.us.reuters.com/resources_v2/css/commerce/overlay.css" type="text/css" rel="stylesheet"/>';
document.write(trOverlayResources); 

trOverlaySizeCss = '<style>.overlay {height:550px !important;width:490px !important;}</style>';
document.write(trOverlaySizeCss); 
	document.write('<SCRIP' +'T type="text/javascript" lang="javascript" src="https://cdns.gigya.com/JS/gigya.js?services=socialize">' + '</SCR' + 'IPT>');
	document.write('<SCRIP' +'T type="text/javascript" lang="javascript" src="https://www.google.com/recaptcha/api/js/recaptcha_ajax.js">' + '</SCR' + 'IPT>');


var _tr_commerce_loginCallbackObj;
var _tr_commerce_regBackUrl;
var _tr_commerce_overlay_div_id;
var _tr_commerce_commerceHost = 'commerce.us.reuters.com';
var _tr_commerce_partner;
var _tr_commerce_displayStyle = "";
// define overlay css styles 
var trOverlayResources="";

//define variables for gigya login

	var _tr_gigyaUID;
	var _tr_gigyaSignature;
	var _tr_gigyaTimestamp;
	var _tr_gigyaUserInfo;
	var _tr_gigyaLoggedin;
	var _tr_gigyaLoginProvider = 'Social';
	var _tr_gigyaProviders = new Array();
	var _tr_gigyaEmail;
	var _tr_targetURL;
	var _tr_gigya_login = false;
	var _tr_gigya_notifyLogin = false;	
	var _tr_gigya_opt_to_new_account_flag = false;
	var _tr_email_from_FH = null;
	var _tr_gigya_loginHandler_registered = false;
	
	
var conf = {
	    APIKey:'2_5UlTf5KVL1qEVXO0ZoNYPoxhzCHYvubplalCtItzf8EuG3Tn6WKHR0hVysesYMdj',
	    

	    "enabledProviders": 'google,yahoo,facebook,linkedin,myspace,twitter,aol',

	 "disabledProviders": 'wordpress, blogger, hyves, livejournal, verisign, typepad',

        signIDs:"true"
	};

var _tr_gigya_timer_id;
var _tr_gigya_time_out_value = 10 * 1000;// default gigya timeout:10 seconds

 _tr_gigya_time_out_value = parseInt('10') * 1000; 

function trSetTimeOut(functionName){
	_tr_gigya_timer_id = window.setTimeout(functionName,_tr_gigya_time_out_value);
}
function trClearTimeOut(){
	if(_tr_gigya_timer_id != null && _tr_gigya_timer_id != 'undefined'){
				window.clearTimeout(_tr_gigya_timer_id);
			}
}
	
	var context = {
	    msg:'This is my params.context.msg'
	};
	
	
	var loginUIParams =
	{
	    "showTermsLink":false, 
	    "showGigyaLink":false,
	    "height":60, 
	    "width":275, 
	    "containerID":"gigyalogin",
	    "UIConfig":"<config><body><controls><snbuttons buttonsize=\"35\"></snbuttons></controls></body></config>"
	};	
	 



//overlay login header
function loginHeader(){
	var headVarArray = new Array();
	
	headVarArray.push('<div id="overlayContents" style="width: 490px; height: 540px; margin:10px 0px;" class="">');
	headVarArray.push('  <div id="modalLoginFlow" style="border: none">');
	if('rcom' != _tr_commerce_partner){	
		headVarArray.push('<div class="closer" style="top:5px;">');
		headVarArray.push('  <a href="javascript:trOverlayCancelLogin();">');
		headVarArray.push('  	<img src="https://commerce.us.reuters.com/resources_v2/images/btn_overlay_close.gif" style="border: none"></img>');
		headVarArray.push('  </a>');
		headVarArray.push('</div>');	
	}	
	
	return headVarArray.join('');
}


//overlay login footer
function loginFooter(){
	var footVarArray = new Array();
	footVarArray.push('<div style="clear: both;"></div>');
	footVarArray.push('  </div>');
	footVarArray.push('  </div>');	
	
	return footVarArray.join('');
}



//functions
function doAjajOperation(url){	
    var script = document.createElement("SCRIPT");
    script.src = url;
    script.type="text/javascript";
    overlayDiv = document.getElementById(_tr_commerce_overlay_div_id);
    overlayDiv.appendChild(script);    
}

function loginUser(overlayDivId, regBackURL, callbackObj,partner){
    //overlayDivId: The login popup div id.
    //regBackURL: Normally should be the current page's URL, when user clicks on the 'register' link in the overlay, he/she will be bring to the registration page and we would want to bring him/her back when register succeeded. If this parameter is left null, the window.location will be picked up.
    //callbackObj: The callback object instance.
    //partner: to present different page for different partner
    _tr_commerce_loginCallbackObj = callbackObj;
    _tr_commerce_regBackUrl = regBackURL;
    _tr_commerce_overlay_div_id = overlayDivId;
    _tr_commerce_partner = partner;

	 // Register Socialize event handlers
	 if(typeof gigya != 'undefined' && typeof gigya.services.socialize.addEventHandlers != 'undefined' && _tr_gigya_loginHandler_registered != true){
		 gigya.services.socialize.addEventHandlers(conf,
		 {
		   onLogin: onGigyaLoginHandler
		 }
		 );
		 _tr_gigya_loginHandler_registered = true;
	 }
	 
	 if(_tr_commerce_partner!='rcom'){
	 	var cssUrl = 'https://commerce.us.reuters.com/resources_v2/css/rcom-commerce.css';
	 	
	 	var cssNode = document.createElement("link");
	 	cssNode.setAttribute('rel', 'stylesheet');
		cssNode.setAttribute('href', cssUrl);
	 	document.body.appendChild(cssNode);
	 } 
	 
    var registeredCookieValue =  YAHOO.util.Cookie.get("ruus");
    // if not exist persistent cookie (ruus), show login page; else show registration page
    if(registeredCookieValue != null && registeredCookieValue != 'undefined'){
    	presentLoginFragment();
    } else {
    	presentRegFragment();
    }
    
	createMetaEle("WT.z_li","0","_tr_webTrends_WT_z_li");
	
    // fire web trends request
//    if (!isWebTrendsInitialized  && typeof(WebTrends) != 'undefined' && (WebTrends != null)){
	if (_tr_commerce_webTrends_tag == null &&  typeof(WebTrends) != 'undefined'){	    
		_tr_commerce_webTrends_tag = new WebTrends();
		//_tr_commerce_webTrends_tag.dcsGetId();
		isWebTrendsInitialized = true;
    }  
      
      if(isWebTrendsSrcTrtExists == null || isWebTrendsSrcTrtExists == false){
           var goPara = regBackURL == null || regBackURL == '' ? top.location.href : regBackURL ;
           if(typeof(_tr_sourcePatternList) == 'undefined' || _tr_sourcePatternList == null || _tr_sourcePatternList == ''){
                   _tr_commerce_webtrends_source = _tr_defaultSite;
           }else{
                   _tr_commerce_webtrends_source = getSrcTagUrl(goPara,_tr_sourcePatternList);
           }
              
           if(typeof(_tr_targetPatternList) == 'undefined' || _tr_targetPatternList == null || _tr_targetPatternList == ''){
               _tr_targetPatternList = _tr_sourcePatternList;
           }
           if(typeof(_tr_targetPatternList) == 'undefined' ||  _tr_targetPatternList == null || _tr_targetPatternList == ''){
                   _tr_commerce_webtrends_target = _tr_defaultSite;
           }else{
                   _tr_commerce_webtrends_target = getSrcTagUrl(goPara,_tr_targetPatternList);
           }
           createMetaEle("WT.z_li_src",_tr_commerce_webtrends_source,null);
           createMetaEle("WT.z_li_trg",_tr_commerce_webtrends_target,null);
       }
       if (_tr_commerce_webTrends_tag != null){
       		_tr_commerce_webTrends_tag.dcsCollect();
   			dscQuantcast(_tr_commerce_webTrends_tag);
	   }
}

function handlePostLogin(){
	   	if('fullpage' != _tr_commerce_displayStyle){
	   		_tr_commerce_loginCallbackObj.postLogin();
		}else{
			location.href=_tr_targetURL;
		}
	}
	
function updateScreenName(overlayDivId, callbackObj,partner){
    //overlayDivId: The login popup div id.
    //callbackObj: The callback object instance.
    //partner: to present different page for different partner
    _tr_commerce_loginCallbackObj = callbackObj;
    _tr_commerce_overlay_div_id = overlayDivId;
    _tr_commerce_partner = partner;
    
    if(_tr_commerce_partner!='rcom'){
	 	var cssUrl = 'https://commerce.us.reuters.com/resources_v2/css/rcom-commerce.css';
	 	
	 	var cssNode = document.createElement("link");
	 	cssNode.setAttribute('rel', 'stylesheet');
		cssNode.setAttribute('href', cssUrl);
	 	document.body.appendChild(cssNode);
	} 
    
    presentNoScreenNameFragment();
}

function presentLoginFragment(){
    overlayDiv = document.getElementById(_tr_commerce_overlay_div_id);    
    //constructNormalPage();
    //overlayDiv.innerHTML = strNormalLoginVar;
    strNormalLoginPageVar = loginHeader() + constructLogin() + contructGigyaLogin("loginOverlay") + loginFooter();    
    overlayDiv.innerHTML = strNormalLoginPageVar;
    if (typeof gigya != 'undefined' && typeof gigya.services.socialize.showLoginUI != 'undefined'){
    	gigya.services.socialize.showLoginUI(conf,loginUIParams);
    }
    
    return;
}

function presentRegFragment(){
    overlayDiv = document.getElementById(_tr_commerce_overlay_div_id);    
    //constructNormalPage();
    //overlayDiv.innerHTML = strNormalLoginVar;
    strNormalLoginPageVar = loginHeader() + constructRegEntry() + contructGigyaLogin("regOverlay") + loginFooter();    
    overlayDiv.innerHTML = strNormalLoginPageVar;
    if (typeof gigya != 'undefined' && typeof gigya.services.socialize.showLoginUI != 'undefined'){
    	gigya.services.socialize.showLoginUI(conf,loginUIParams);
    }
    
    return;
}


function presentNoScreenNameFragment(status, message){
    overlayDiv = document.getElementById(_tr_commerce_overlay_div_id);
    var strNoScreenNameVar = loginHeader() + constructNoScreenName(status, message) + loginFooter();
    overlayDiv.innerHTML = strNoScreenNameVar;
    return;
}

function presentLinkAccountSuccess(status, message){
    overlayDiv = document.getElementById(_tr_commerce_overlay_div_id);
    var strLinkAccountSuccessVar = constructLinkAccountSuccess(status, message);
    overlayDiv.innerHTML = strLinkAccountSuccessVar;
    return;
}
	
function presentEmailExistsFragment(){
    overlayDiv = document.getElementById(_tr_commerce_overlay_div_id);
    var strPostGigyaLoginVar = loginHeader() + contructPostGigyaLogin(true) + loginFooter();
    overlayDiv.innerHTML = strPostGigyaLoginVar;
    return;
}
	
function presentEmailNonExistsFragment(overlayDivId,partner){
    overlayDiv = document.getElementById(_tr_commerce_overlay_div_id);
    var strGigyaRegVar =  loginHeader() + contructGigyaReg() + loginFooter(); 
    overlayDiv.innerHTML = strGigyaRegVar;
    return;
}

function presentEmailVerificationFragment(){
	overlayDiv = document.getElementById(_tr_commerce_overlay_div_id);
    strGigyaRegVar =  loginHeader() + contructRegEmailVerification() + loginFooter(); 
    overlayDiv.innerHTML = strGigyaRegVar;
    return;
}

function presentForgetPasswordEmailVerificationFragment(userMail){
	overlayDiv = document.getElementById(_tr_commerce_overlay_div_id);
    strGigyaRegVar =  loginHeader() + contructForgotPasswordEmailVerification(userMail) + loginFooter(); 
    overlayDiv.innerHTML = strGigyaRegVar;
    return;
}

function presentNotifyVerifyEmail(userMail){
	overlayDiv = document.getElementById(_tr_commerce_overlay_div_id);
    strGigyaRegVar =  loginHeader() + contructNotifyVerifyEmail(userMail) + loginFooter(); 
    overlayDiv.innerHTML = strGigyaRegVar;
    return;
}

function presentNotifyVerifyEmailSent(userEmail){
	overlayDiv = document.getElementById(_tr_commerce_overlay_div_id);
    strGigyaRegVar =  loginHeader() + contructNotifyVerifyEmailSent(userEmail) + loginFooter(); 
    overlayDiv.innerHTML = strGigyaRegVar;
    return;
}

function presentRegEmailSentFragment(){
	overlayDiv = document.getElementById(_tr_commerce_overlay_div_id);
    strGigyaRegVar =  contructRegEmailSent(); 
    overlayDiv.innerHTML = strGigyaRegVar;
    return;
}

function presentLinkAccountSuccessFragment(){
	overlayDiv = document.getElementById(_tr_commerce_overlay_div_id);
    strGigyaRegVar =  loginHeader() + contructLinkAccountSuccess() + loginFooter(); 
    overlayDiv.innerHTML = strGigyaRegVar;
    return;
}

function trOverlayCancelLogin(){
    _tr_commerce_loginCallbackObj.cancelLogin();
}


function setTrOverlayMsg(divId,message){
    headLineDiv = document.getElementById(divId);
    if(headLineDiv != null){
        headLineDiv.innerHTML = message;
        headLineDiv.className  = "label error";
    }
}

function enableDisplay(elementId){
	element = document.getElementById(elementId);
	if( element != null && element != ''){
		element.style.display='';
	}
}

function disableDisplay(elementId){
	element = document.getElementById(elementId);
	if( element != null && element != ''){
		element.style.display='none';
	}
}

function trOverlayGoRestorePassword(){
    overlayDiv = document.getElementById(_tr_commerce_overlay_div_id);    
    strNormalLoginPageVar = loginHeader() + constructForgetPassword() + loginFooter();    
    overlayDiv.innerHTML = strNormalLoginPageVar;
    
    return;
}

function trOverlayGoReg(){
	overlayDiv = document.getElementById(_tr_commerce_overlay_div_id);
    strGigyaRegVar =  loginHeader() + constructRegistrtion() + loginFooter(); 
    overlayDiv.innerHTML = strGigyaRegVar;

    showRecaptcha(); 
}


function isSignin() {
  	var loggedIn = false;
  	var domain = 0;
 	if((_tr_commerce_commerceHost.indexOf(".us.") > -1) || (_tr_commerce_commerceHost.indexOf("www.") > -1)){
        domain=1;
  	}else if(_tr_commerce_commerceHost.indexOf(".uk.") > -1){
        domain=2;
 	}else if(_tr_commerce_commerceHost.indexOf(".jp.") > -1){
        domain=4;
  	}else if(_tr_commerce_commerceHost.indexOf(".in.") > -1){
        domain=9;
  	}else if(_tr_commerce_commerceHost.indexOf(".cn.") > -1){
        domain=10;
	}
        
  	var edition = YAHOO.util.Cookie.get('edition');
  	var customerId = YAHOO.util.Cookie.get('customerId');
  	if((null == edition) || ("" == edition)){
        //This is here to support the time before the edition cookie exists
        loggedIn = ((customerId != null) && (customerId != "@"));
  	}else{
        loggedIn = ((customerId != null) && (customerId != "@") && (domain == edition));
  	}
  	return loggedIn;  
}

function getCookie(NameOfCookie){
 if (document.cookie.length > 0){
    begin = document.cookie.indexOf(NameOfCookie+"=");
	if (begin != -1){
		begin += NameOfCookie.length+1;
		end = document.cookie.indexOf(";", begin);
		if (end == -1) end = document.cookie.length;
		return unescape(document.cookie.substring(begin, end)); 
	}
	}
	return null;
}

function commonPopup(url, width, height, toolsInd, wname){
	var options = "width=" + width + ",height=" + height + ",top=" + ((screen.height - height) / 4).toString() + ",left=" + ((screen.width - width) / 2).toString();

	switch (toolsInd){
		case 1:
			options += ",toolbar=no,status=no,resizable=no,scrollbars=yes";
			break;
		case 2:
			options += ",menubar=yes,toolbar=yes,status=yes,resizable=yes,location=yes,scrollbars=yes";
			break;
		default:
			//do nothing
			break;
	}

	if (!wname){
		wname = "reutersPopup";
	}

	popupWindow = window.open(url, wname, options);

	if (popupWindow){
		popupWindow.focus();
	}
}

function transformFormToQuery(aForm){
	var str = '';
	var elem = aForm.elements;
	for(var i = 0; i < elem.length; i++){
		t = elem[i].type;
		if(t == 'button'){
			break;
		}
		str+=elem[i].name;
		str+='=';
		str+=encodeURIComponent(elem[i].value);
		if(i < elem.length - 1){
			str+='&';
		}
	}
		
	return str;
}

function checkEmail(emailStr) {
	emailStr = emailStr.trim();
    if (emailStr.length == 0) {
        return true;
    }
    var emailPat = /^(.+)@(.+)$/;
    var specialChars = "\\(\\)<>@,;:'\\\\\\\"\\.\\[\\]";
    var validChars = "\[^\\s" + specialChars + "\]";
    var quotedUser = "(\"[^\"]*\")";
    var ipDomainPat = /^(\d{1,3})[.](\d{1,3})[.](\d{1,3})[.](\d{1,3})$/;
    var atom = validChars + '+';
    var word = "(" + atom + "|" + quotedUser + ")";
    var userPat = new RegExp("^" + word + "(\\." + word + ")*$");
    var domainPat = new RegExp("^" + atom + "(\\." + atom + ")*$");
    var matchArray = emailStr.match(emailPat);
    if (matchArray == null) {
        return false;
    }
	var user = matchArray[1];
    var domain = matchArray[2];
    if (user.match(userPat) == null) {
        return false;
    }
    var IPArray = domain.match(ipDomainPat);
    if (IPArray != null) {
        for (var i = 1; i <= 4; i++) {
            if (IPArray[i] > 255) {
                return false;
            }
        }
        return true;
    }
    var domainArray = domain.match(domainPat);
    if (domainArray == null) {
        return false;
    }
    var atomPat = new RegExp(atom, "g");
    var domArr = domain.match(atomPat);
    var len = domArr.length;
    if ((domArr[domArr.length - 1].length < 2) ||
        (domArr[domArr.length - 1].length > 3)) {
        return false;
    }
    if (len < 2) {    	
        return false;
    }
    return true;
}


var loginFormBackUrl =  "http://www.reuters.com"; 
var loginFormBackParameterEncoded = "false";
var loginFormSource = "";

function constructLogin(){

	var loginInFlag = false;
	var registeredCookieValue =  YAHOO.util.Cookie.get("ruus");
	
    if(registeredCookieValue != null && registeredCookieValue != 'undefined'){
    	loginInFlag = true;
    }
	var loginVarArray = new Array();
	
	loginVarArray.push('<div class="column1 gridPanel grid6">');
		
			loginVarArray.push('<h2>Sign in</h2>');
		
	

	loginVarArray.push('<p><h3>Enter your Reuters.com account info</h3></p>');
	loginVarArray.push('<div class="label error"><span id="trOverlayLoginHeadline"></span></div>');
	loginVarArray.push('<form onsubmit="javascript:validateLoginForm(this);return false;" action="" method="post" name="loginForm">');
	loginVarArray.push('  <input type="hidden" value="1288" name="__MOID__" />');
	loginVarArray.push('  <input type="hidden" value="LoginForm" name="__FH__" />');
	loginVarArray.push('  <input type="hidden" value="http://www.reuters.com" name="backUrl" />');
	loginVarArray.push('  <input type="hidden" value="false" name="backParameterEncoded" />');
	loginVarArray.push('  <input type="hidden" value="" name="source" />');
	loginVarArray.push('  <input type="hidden" value="true" name="overlay" />');
	loginVarArray.push('  <input type="hidden" value="' + 'COMMENTS' + '" name="flow" />');
	
	loginVarArray.push('  <div class="label">Email</div>');
	loginVarArray.push('  <div class="textfield"><input type="text" size="40" maxlength="100" name="loginName" value="" /></div>');
	loginVarArray.push('  <div class="label">Password</div>');
	loginVarArray.push('  <div class="textfield"><input type="password" value="" size="40" maxlength="20" name="password" /></div>');
	
	loginVarArray.push('  <div class="checkbox">');
	loginVarArray.push('    <input type="hidden" value="true" name="flag" />');
	loginVarArray.push('    <input type="checkbox" onclick="if(this.checked) this.form.flag.value=\'true\'; else this.form.flag.value=\'false\';" id="RememberCredentialsCBID" checked="checked"/>');
	loginVarArray.push('    <label class="label"  for="RememberCredentialsCBID">Remember me on this computer</label>');
	loginVarArray.push('  </div>');
	
	loginVarArray.push('  <div class="submit"><div class="button"><input type="image"	src="/resources_v2/images/btn_sign_in.gif" /></div></div>');

    loginVarArray.push('  <div class="textfield"><p><a href="javascript:trOverlayGoRestorePassword()">Forgot your password?</a></p></div>');
	
	loginVarArray.push('</form>');
	loginVarArray.push('</div>');
	
	return loginVarArray.join('');
}

function validateLoginForm(loginForm){
 if(loginForm != null){
	 user = loginForm.elements['loginName'].value;
	 if(user == null || user==''){
	 	alert('Email is required!');
	 	loginForm.elements['loginName'].focus();
	 	return false;
	 }
	 password = loginForm.elements['password'].value;
	 if(password == null || password==''){
	 	alert('Password is required');
	 	loginForm.elements['password'].focus();
	 	return false;
	 }
 	
 	var loginNameEle = document.forms['loginForm'].elements['loginName'].value;
 	if(loginNameEle != ""){
 		if(document.getElementById('notMe')!=null){
	 		document.getElementById('notMe').style.display='none';
	 	}
	 	if(document.getElementById('h2LoginHeader')!=null){
    		document.getElementById('h2LoginHeader').innerHTML='Sign in';
    	}
   	}
 	
 	queryString = transformFormToQuery(loginForm);
 	
 	url = "https://" + _tr_commerce_commerceHost + "/login/pages/login/login.do?"+queryString;
	
	doAjajOperation(url);		
 }
}

function clearEmailAddressAndPassword() {
    var loginNameEle = document.forms['loginForm'].elements['loginName'];
    loginNameEle.value = '';
    loginNameEle.focus();
    var passwordEle = document.forms['loginForm'].elements['password'];
    passwordEle.value = '';
    if(document.getElementById('notMe')!=null){
    	document.getElementById('notMe').style.display='none';
    }
    if(document.getElementById('h2LoginHeader')!=null){
    	document.getElementById('h2LoginHeader').innerHTML='Sign in';
    }
    
    headerSpan = document.getElementById('trOverlayLoginHeadline');
    headerSpan.innerHTML="";
  }



function constructRegEntry(){

	var regEntryVarArray = new Array();
	
	regEntryVarArray.push('<div class="column1 gridPanel grid6">');
	
	regEntryVarArray.push('  <h2>Register for a Reuters.com Account</h2>');	
	
	regEntryVarArray.push('  <p><h3>Create a new Reuters.com account:</h3></p>');
	
	regEntryVarArray.push('  <div class="submit">');
	regEntryVarArray.push('    <div class="button">');	
    regEntryVarArray.push('      <a href="javascript:trOverlayGoReg()">');
	regEntryVarArray.push('        <img src="https://' + _tr_commerce_commerceHost + '/resources_v2/images/btn_sign_up.gif" alt="Sign Up" border="0" />');	
	regEntryVarArray.push('      </a>');
	
	regEntryVarArray.push('    </div>');
	regEntryVarArray.push('  </div>');
	regEntryVarArray.push('</div>');
	
	return regEntryVarArray.join('');
}




     
function contructGigyaLogin(overlayType){
	var tmpArray = new Array();
	
     
    
    tmpArray.push('		<div class="columnLeft">');
    tmpArray.push('        <div class="gridPanel grid6">');
	tmpArray.push('            <h2></h2>');
	
	if(overlayType == "loginOverlay") {
		tmpArray.push('            <p><h3>Or sign in using a partner site...</h3></p>');
	} else if(overlayType == "regOverlay") {
		tmpArray.push('            <p><h3>Or register through a partner site:</h3></p>');
	}
	
	tmpArray.push('            <div id="gigyalogin" class="gigya_login" ></div>');	
	tmpArray.push('				<form action="" method="post" name="gigyaForm">');
	tmpArray.push('	  				<input type="hidden"	value="1290" name="__MOID__" />');
	tmpArray.push('					<input type="hidden"	value="CheckGigyaResponseForm" name="__FH__" />');	
	tmpArray.push('					<input type="hidden"  name="backUrl"/>');
	tmpArray.push('					<input type="hidden"  name="backParameterEncoded"/>');
	tmpArray.push('					<input type="hidden"  name="source"/>');	
	tmpArray.push('					<input type="hidden"  name="overlay" value="true"/>');
	tmpArray.push('					<input type="hidden"  name="flow" value="COMMENTS"/>');
	tmpArray.push('				</form>');
	
	if(overlayType == "loginOverlay") {
		tmpArray.push('            <p style="margin:15px 0px 5px;"><h3>New to Reuters.com? Register <a href="javascript:presentRegFragment()">here</a>.</h3></p>');
	} else if(overlayType == "regOverlay") {
		tmpArray.push('            <p style="margin:15px 0px 5px;"><h3>Already registered? Sign in <a href="javascript:presentLoginFragment()">here</a>.</h3></p>');
	}
	tmpArray.push('       </div>');
	tmpArray.push('    </div>');


	return tmpArray.join('');
}


	
	// onLogin Handler
 	function onGigyaLoginHandler(eventObj) { 	    
    
 	 	if (_tr_gigya_notifyLogin){
 	 		return;
 	 	}
 	 	
	 	_tr_gigyaUserInfo = eventObj.user;
	 	_tr_gigyaUID = _tr_gigyaUserInfo.UID;
	 	_tr_gigyaSignature = _tr_gigyaUserInfo.UIDSig;
	 	_tr_gigyaTimestamp = _tr_gigyaUserInfo.timestamp;
	 	_tr_gigyaEmail = _tr_gigyaUserInfo.email;
	 	if(_tr_gigyaUserInfo.loginProvider != null && _tr_gigyaUserInfo.loginProvider !=''){
			_tr_gigyaLoginProvider = _tr_gigyaUserInfo.loginProvider;
			_tr_gigyaProviders = _tr_gigyaUserInfo.providers;
		}
	
  		//ignore request if we are already logged in
  		if (_tr_gigyaLoggedin)
    		return;
    	    	
  		// ignore if either is empty
  		if (_tr_gigyaUID != null && _tr_gigyaUID!='' ) {

    		gigyaParams = 'uid='+encodeURIComponent(_tr_gigyaUID) + '&signature='+encodeURIComponent(_tr_gigyaSignature) + 
    			'&timestamp='+encodeURIComponent(_tr_gigyaTimestamp) + '&email='+encodeURIComponent(_tr_gigyaUserInfo.email)+    
    			'&providers='+encodeURIComponent(_tr_gigyaProviders.join(','))+'&loginProvider='+encodeURIComponent(_tr_gigyaLoginProvider);
    		    		
    		document.forms["gigyaForm"].elements["backUrl"].value= loginFormBackUrl;
    		document.forms["gigyaForm"].elements["backParameterEncoded"].value= loginFormBackParameterEncoded;
    		document.forms["gigyaForm"].elements["source"].value= loginFormSource;
    		
    		
    		queryString = transformFormToQuery(document.forms["gigyaForm"]);    		
			url = 'https' + '://' + _tr_commerce_commerceHost + '/login/pages/login/login.do?' + gigyaParams + '&' + queryString;			
   			doAjajOperation(url);
  		}
	 }


function contructPostGigyaLogin(emailAlreadyExists){

	var tmpArray = new Array(); 

	tmpArray.push('<div class="grid6 gridPanel">');
	
	//if (emailAlreadyExists) {
	//} else {
	//}
	tmpArray.push('<h2>Link Your Accounts</h2>');
	tmpArray.push('<h3>We see that you\'ve signed in Reuters.com before. Link your accounts by entering the email address and password associated to your Reuters account.</h3>');
	
	tmpArray.push('<div style="display: none;" id="loginFormRequiredPrompt" class="labelItalic">Fields marked with an asterisk(<font color="#dc0808">*</font>) are required.</div>');            
	  
	tmpArray.push('<form onsubmit="jsGigyaLoginSubmit(this);return false;" action="" method="post" name="loginForm">');  
	tmpArray.push('	    <input type="hidden" value="1291" name="__MOID__" />'); 
	tmpArray.push('		<input type="hidden" value="PostGigyaLoginForm" name="__FH__" />');              
	tmpArray.push('	 	<input type="hidden" value="http://www.reuters.com" name="backUrl" />'); 
	tmpArray.push('		<input type="hidden" value="false" name="backParameterEncoded" />'); 
	tmpArray.push('		<input type="hidden" value="" name="source" />');	
	tmpArray.push('		<input type="hidden"  name="loginProvider" value="'+ _tr_gigyaLoginProvider +'"/>'); 
	tmpArray.push('		<input type="hidden"  name="overlay" value="true"/>');
	tmpArray.push('		<input type="hidden"  name="flow" value="' + _tr_flow + '"/>'); 
	    
	tmpArray.push('    	<div class="label">');
	tmpArray.push('    	Email');
	tmpArray.push('     	<span id="loginFormEmailAsterisk" class="required">*</span>');

	tmpArray.push('    	</div>');            
	tmpArray.push('    	<div class="textfield">');   
	if (_tr_email_from_FH != null && _tr_email_from_FH != ''){
        tmpArray.push('         <input type="text" value="' + _tr_email_from_FH + '" name="loginName" maxlength="100" size="40"/>');
    }else if(_tr_gigyaEmail != null && _tr_gigyaEmail != ''){
		tmpArray.push('	    	<input type="text" value="' + _tr_gigyaEmail + '" name="loginName" maxlength="100" size="40"/>');
	}else {
		tmpArray.push('	    	<input type="text" name="loginName" maxlength="100" size="40"/>');
	}         
	tmpArray.push('    <a href="javascript:trOverlayNotMe()" class="linkshort">This isn\'t me</a>');
    tmpArray.push('    	</div>');            
	    
	tmpArray.push('    	<div class="label">');
	tmpArray.push('			Password');
	tmpArray.push('			<span id="loginFormPasswordAsterisk" class="required">*</span>');
	tmpArray.push('		</div>');            
	tmpArray.push('    <div class="textfield">');                
	tmpArray.push('     	<input type="password" name="password" maxlength="20" size="30"/>');
	       
		      		     
	tmpArray.push('	       	<a class="linkshort" href="javascript:trOverlayGoRestorePassword()">Choose password?</a>');	     
		  		
	tmpArray.push('    	</div>');
	tmpArray.push('    <div id="loginFormErrorMsg" class="labelItalic"></div>');            
	    
	
	
				
	tmpArray.push('	   <div class="checkbox">');                
	tmpArray.push('	      	<input type="hidden" value="true" name="flag"/>');                    
	tmpArray.push('	      	<input type="checkbox" name="useless" checked="checked" onclick="if(this.checked) this.form.flag.value=\'true\'; else this.form.flag.value=\'false\';" id="RememberCredentialsCBID1"/>');   
	tmpArray.push('	      	<label class="label" for="RememberCredentialsCBID1">Remember me</label>');            
	tmpArray.push('	   </div>');            
			    
	
	
	
	tmpArray.push('    <div class="submit">');                
	tmpArray.push('      <div class="button">');
	tmpArray.push('        <input type="image" src="https://commerce.us.reuters.com/resources_v2/images/btn_submit.gif"/>');
	tmpArray.push('      </div>');            
	tmpArray.push('    </div>');            
	tmpArray.push('</form>');        
    
    tmpArray.push('            <div class="linebreak" style="float:none"></div>');
    tmpArray.push('    <p>');                
    tmpArray.push('Don\'t want to link your account? ');      
    tmpArray.push(' <a href="javascript:trOverlayNewAccount()" class="linkshort">Click here</a> ');
    tmpArray.push('to register a new Reuters account automatically with the email address provided. ');       
    tmpArray.push('    </p>');
    
	tmpArray.push('</div>');
	
	return tmpArray.join('');
}

function jsGigyaLoginSubmit(formEle){
	loginName = formEle.elements["loginName"].value;
	password = formEle.elements["password"].value;
	back = formEle.elements["backUrl"].value;
	backParameterEncoded = formEle.elements["backParameterEncoded"].value;
	source = formEle.elements["source"].value;
	if(loginName == null ||loginName == ""){
		alert('Email is required!');
		promptLoginFormAsterisk();
		formEle.elements["loginName"].focus();
		return false;
	}
	if(password==null||password ==""){
		alert('Password is required');
		promptLoginFormAsterisk();
		formEle.elements["password"].focus();
		return false;
	}
		
	 //flag = formEle.elements["flag"].value;
	
	gigyaParams = 'uid='+encodeURIComponent(_tr_gigyaUID) + '&signature='+encodeURIComponent(_tr_gigyaSignature) + 
    			'&timestamp='+encodeURIComponent(_tr_gigyaTimestamp);
		
	queryString = transformFormToQuery(formEle);
	url = 'https://' + _tr_commerce_commerceHost + '/commerce/login/postGigyaLogin?' + gigyaParams + '&' + queryString;
   	doAjajOperation(url);	   
}

function promptLoginFormAsterisk(){
 	enableDisplay('loginFormRequiredPrompt');
 	enableDisplay('loginFormEmailAsterisk');
 	enableDisplay('loginFormPasswordAsterisk');
}
function trOverlayNotMe(){
	formEle = document.forms['loginForm'];
	formEle.elements["loginName"].value = '';
	formEle.elements["loginName"].focus();
}

function trOverlayNewAccount(){
	_tr_gigya_opt_to_new_account_flag = true;
	presentEmailNonExistsFragment(_tr_commerce_overlay_div_id,_tr_commerce_partner);
}



function contructGigyaReg(){

	var tmpArray = new Array(); 
	
	tmpArray.push('<div class="gridPanel grid6">');
	tmpArray.push('<h2>Almost There!</h2>');
	tmpArray.push('		<form action="" onsubmit="jsGigyaRegSubmit(this);return false;" id="trGigyaRegForm" method="post">');
	tmpArray.push('    		<input type="hidden" value="1292" name="__MOID__" />'); 
	tmpArray.push('			<input type="hidden" value="GigyaRegisterForm" name="__FH__" />');	
	tmpArray.push('			<input type="hidden" value="" name="ccode" />');
	tmpArray.push('			<input type="hidden" value="" name="ccodeReferer" />');
	tmpArray.push('		    <input type="hidden"  name="loginProvider" value="'+ _tr_gigyaLoginProvider +'"/>');
	tmpArray.push('			<input type="hidden"  name="overlay" value="true"/>');
	tmpArray.push('			<input type="hidden"  name="flow" value="GIGYAWITHSCREENNAME"/>');
	
			
	tmpArray.push('<h3>In order to sign in you with your ' + _tr_gigyaLoginProvider +' account, we need some additional information.</h3>');       
	tmpArray.push('        	<div class="linebreak"></div>'); 
	tmpArray.push('<p>');
	tmpArray.push('            <div class="linebreak"></div>');


	tmpArray.push('       		<div class="label">Email Address');
			
	tmpArray.push('				          <span class="required">*</span>');					      
			
	tmpArray.push('       		</div>');            
	tmpArray.push('      		<div class="textfield">'); 
	
			 
	if(_tr_gigyaEmail != null && _tr_gigyaEmail != '' && _tr_gigya_opt_to_new_account_flag == false){
		tmpArray.push('           		<input name="EMAILADDRESS" id="EMAILADDRESS" value="' + _tr_gigyaEmail + '" maxlength="100" size="40" type="text" >');
	} else {
	  tmpArray.push('              <input name="EMAILADDRESS" id="EMAILADDRESS" value="" maxlength="100" size="40" type="text">');
	}
				
				tmpArray.push('         		<div id="regFormEmailError">Your email address will not be shown anywhere on Reuters.com</div>');	 
			
	        
	tmpArray.push('       		</div>');            
	tmpArray.push('            <div class="linebreak"></div>');		
		
	tmpArray.push('       		<div class="label">Screen Name');
			
	tmpArray.push('				          <span class="required">*</span>');					      
			
	tmpArray.push('       		</div>');            
	tmpArray.push('      		<div class="textfield">'); 
	
			 
				tmpArray.push('<input name="SCREENNAME" id="SCREENNAME" value="" maxlength="20" size="40" type="text">');
				tmpArray.push('         		<div id="regFormScreenNameError">Your screen name will be displayed next to comments</div>');
			
	        
	tmpArray.push('       		</div>');            
	tmpArray.push('            <div class="linebreak"></div>');		
		
	tmpArray.push('       	<div class="checkbox">');                   
	tmpArray.push('        		<input name="SUBSCRIBERAGREEMENT" id="SUBSCRIBERAGREEMENT" type="checkbox" > ');                    
	tmpArray.push('        		<label for="Agree" class="label">I agree with the<a href="javascript:commonPopup(\'https://commerce.us.reuters.com/commerce/help/termsConditions\', 540, 525, 1, \'bottomNav\')">&nbsp;Terms &amp; Conditions</a></label>');				 
	tmpArray.push('        		<span class="required" id="regFormSubscribeAgreementAsterisk" style="display: ">*</span>');
	tmpArray.push('        		<div class="labelItalic" id="regFormSubscribeAgreement"></div>');	         
	tmpArray.push('		</div>');   
			
	         
	tmpArray.push('     <div class="submit">');                
	tmpArray.push('         <div class="button">');                    
	tmpArray.push('           	<input src="https://commerce.us.reuters.com/resources_v2/images/btn_submit.gif" alt="Register" border="0" type="image">');                
	tmpArray.push('         </div>');            
	tmpArray.push('     </div>'); 
	tmpArray.push('  </form>');
	  
	tmpArray.push('</div>');
	
	return tmpArray.join('');
}	

function jsGigyaRegSubmit(regForm){
	var ele = regForm.elements["EMAILADDRESS"];
	if (ele){
		if(ele.value.trim() == '') {
	  		setTrOverlayMsg('regFormEmailError','Email is required!');
	  		regForm.elements["EMAILADDRESS"].focus();
	  		return false;
		}else{
			setTrOverlayMsg('regFormEmailError','');
		}
	}
	
	ele = regForm.elements["SCREENNAME"];
  	if (ele){
		if(ele.value.trim() == '') {
  			setTrOverlayMsg('regFormScreenNameError','Screen name is required!');
  			regForm.elements["SCREENNAME"].focus();
  			return false;
  		}else{
	  		setTrOverlayMsg('regFormScreenNameError','');
		}
	}

	ele = regForm.elements["SUBSCRIBERAGREEMENT"];
  	if (ele){
  		if(ele.checked){
      		ele.value = "on";
    	}else{
      		ele.value = "";
    	}
  		if(!ele.checked){
  			setTrOverlayMsg('regFormSubscribeAgreement','You must agree to terms and conditions');
			return false;
		}else{
	  		setTrOverlayMsg('regFormSubscribeAgreement','');
		}	
	}
	
	gigyaParams = 'uid='+encodeURIComponent(_tr_gigyaUID) + '&signature='+encodeURIComponent(_tr_gigyaSignature) + 
    			'&timestamp='+encodeURIComponent(_tr_gigyaTimestamp); 
    //if (email == _tr_gigyaEmail){
    	//gigyaParams = gigyaParams + '&isEmailProvidedBySocial=true';
    //}
	queryString = transformFormToQuery(regForm);
	url = 'https://' + _tr_commerce_commerceHost + '/commerce/registration/gigyareg?' + gigyaParams + '&' + queryString;
   	doAjajOperation(url);     
}
		



function constructNoScreenName(status, message){
		
	var noScreenNameVarArray = new Array();
	
	noScreenNameVarArray.push('<div class="gridPanel grid6">');
	noScreenNameVarArray.push('    <h2><span id="trOverlayScreennameHeadline">Please enter a screen name</span></h2>');
	noScreenNameVarArray.push('          <form onsubmit="javascript:jsUpdateScreenNameSubmit(this);return false;" action="" id="trUpdateScreenNameForm">');   
	noScreenNameVarArray.push('            <input type="hidden" value="1293" name="__MOID__" />');
	noScreenNameVarArray.push('            <input type="hidden" value="UpdateScreenNameForm" name="__FH__" />');
	noScreenNameVarArray.push('            <input type="hidden" value="" name="targetURL" />');
	noScreenNameVarArray.push('            <input type="hidden" value="true" name="overlay" />');
	if(typeof(_tr_commerce_screenname_update_context) != "undefined" && 
	  _tr_commerce_screenname_update_context != "" && 
	  _tr_commerce_screenname_update_context != null){
		noScreenNameVarArray.push('            <input type="hidden" value="' + _tr_commerce_screenname_update_context + '" name="updateContext" />');
	} else {
		noScreenNameVarArray.push('            <input type="hidden" value="" name="updateContext" />');
	}
	
	noScreenNameVarArray.push('            <div class="label"><span id="trScreennameLable">A screen name is required to use this feature</span></div>');
	 
	noScreenNameVarArray.push('            <div class="textfield"><input type="text" size="40" maxlength="100" name="SCREENNAME" value=""/>');
    if (message!= null && message != ''){
        noScreenNameVarArray.push('    <div style="display: block;" class="label error" id="ERR-SCREENNAME">' + message + '</div>');
    }else{
        noScreenNameVarArray.push('    <div style="display: none;" class="label error" id="ERR-SCREENNAME"></div>');
    }
	noScreenNameVarArray.push('            </div>');
	noScreenNameVarArray.push('            <div class="submit"><div class="button">');	
	noScreenNameVarArray.push('					<input type="image" src="https://' + _tr_commerce_commerceHost + '/resources_v2/images/btn_submit.gif" />');
	noScreenNameVarArray.push('			   </div></div>');
		
	noScreenNameVarArray.push('          </form>');
	
	noScreenNameVarArray.push('  </div>');
	
	return noScreenNameVarArray.join('');

}


function jsUpdateScreenNameSubmit(noScreenNameForm){		   
   screenName = noScreenNameForm.elements["SCREENNAME"].value;
   if(screenName == null || screenName == ""){
      errorDiv = document.getElementById("ERR-SCREENNAME");
      if(errorDiv != null){
      	errorDiv.innerHTML = 'Please enter a screen name';
      	errorDiv.style.display="block";    	      	
      }
      return false;
   }
   
	queryString = transformFormToQuery(noScreenNameForm);		
 	url = "https://" + _tr_commerce_commerceHost + "/profile/noScreenName?"+queryString;
	
	doAjajOperation(url);		
}




function contructRegEmailVerification(){
		
	var tmpArray = new Array();
	
    tmpArray.push('        <div class="gridPanel grid6">');
	tmpArray.push('            <h2>Verify Your Email Address</h2>');
	
	tmpArray.push('  <div id="content">');
	tmpArray.push('    <div class="section">');
	tmpArray.push('      <div class="sectionContent">');
	tmpArray.push('        <div class="grid6 gridPanel">');
	tmpArray.push('          <p>Your account has successfully been created but in order to complete the registration process, you must verify your email address.&nbsp;Check your email and click on the link provided.</p>');
	tmpArray.push('        </div>');
	tmpArray.push('       </div>');
	tmpArray.push('    </div>');
	tmpArray.push('  </div>');
	tmpArray.push('</div>');

	return tmpArray.join('');

}



function contructLinkAccountSuccess(){
		
	var tmpArray = new Array();
	
	tmpArray.push('        <div class="grid6 gridPanel">');
	tmpArray.push('         <h2>You have just linked an account to your Reuters account</h2>');
	
	tmpArray.push('<p> In the future you can log into your Reuters account directly by using your ' + _tr_gigyaLoginProvider +' account.</p>');
	
	tmpArray.push('    <p>');
	tmpArray.push('       Manage  ');                
    tmpArray.push('       <a href="https://commerce.us.reuters.com/profile" class="linkshort" target="_blank">your Profile</a> ');
    tmpArray.push('    </p>');
	
	//tmpArray.push('	   <div>');  
	//tmpArray.push('       <span onclick="javascript:handlePostLogin()" class="hrefClone">Close Window</span>');
	//tmpArray.push('	   </div>');

	tmpArray.push('        </div>');
	
	return tmpArray.join('');
}
    
function constructForgetPassword(){
	var tmpArray = new Array();
	
     
	    tmpArray.push('        <div class="gridPanel grid6">');
		tmpArray.push('            <h2>Forgot Your Password?</h2>');
		tmpArray.push('            <p>Enter your email address to reset your password.</p>');
		tmpArray.push('            <div id="gigyalogin" class="gigya_login" ></div>');	
		tmpArray.push('             <form onsubmit="javascript:validateForgetPasswordForm(this);return false;" action="" method="post" name="changePasswordForm">');
		tmpArray.push('	  				<input type="hidden"	value="1296" name="__MOID__" />');
		tmpArray.push('					<input type="hidden"	value="ForgotPasswordForm" name="__FH__" />');	
		tmpArray.push('					<input type="hidden"  name="backUrl"/>');
		tmpArray.push('					<input type="hidden"  name="backParameterEncoded"/>');
		tmpArray.push('					<input type="hidden"  name="source"/>');	
		tmpArray.push('					<input type="hidden"  name="forgotType" value="forgotPassword"/>');
		tmpArray.push('					<input type="hidden"  name="overlay" value="true"/>');
		
		tmpArray.push('                 <div class="label">Email Address</div>');
		tmpArray.push('                 <div class="textfield"><input type="text" size="40" maxlength="100" name="emailAddress" value="" /></div>');
		tmpArray.push('			        <div id="ERRORMSG" class="label error" style="display: none;"></div>');
		
		tmpArray.push('                 <div class="submit"><div class="button"><input type="image"	src="/resources_v2/images/btn_submit.gif" /></div></div>');
		
		tmpArray.push('				</form>');
		tmpArray.push('			</div>');

	return tmpArray.join('');
}

function validateForgetPasswordForm(changePasswordForm){
 if(changePasswordForm != null){
	 emailAddress = changePasswordForm.elements['emailAddress'].value;
	 if(emailAddress == null || emailAddress==''){
	 	alert('Email address is required');
	 	changePasswordForm.elements['emailAddress'].focus();
	 	return false;
	 } else if(!checkEmail(emailAddress)) {
		alert('Email address is incorrect');
		changePasswordForm.elements['emailAddress'].focus();
		return false;
	}

 	queryString = transformFormToQuery(changePasswordForm);
 	
 	url = "https://" + _tr_commerce_commerceHost + "/login/pages/login/login.do?"+queryString;
 	
	doAjajOperation(url);		
 }
}

function promptForgotPasswordErrorMsg(){
 	enableDisplay('ERRORMSG');
}


function contructForgotPasswordEmailVerification(userMail){
		
	var tmpArray = new Array();
	
	tmpArray.push('        <div class="gridPanel grid6">');
	tmpArray.push('    <h2>Email Sent</h2>');
	tmpArray.push('<p>An email has been sent to '+userMail+'. &nbsp;Follow the link in the email to reset your password.</p>');
	
	tmpArray.push('        </div>');
	
	return tmpArray.join('');

}
    

validateAgreement = function () {
promptRegFormAsterisk();
           var formEle = document.getElementById("registrationForm");
           var errElements = new Array(); 
           
            var ele = formEle.elements["EMAILADDRESS"]; 	        
            if (ele && ele.value.trim() == '') {
              var errEle = document.getElementById("ERR-EMAILADDRESS");
              if (errEle) {
                errEle.innerHTML = "An email address must be entered\r\n";
                errElements.push("EMAILADDRESS");
                errEle.style.display="block";                
              }          
            
            }
            
            var ele = formEle.elements["SCREENNAME"]; 	        
            if (ele && ele.value.trim() == '') {
              var errEle = document.getElementById("ERR-SCREENNAME");
              if (errEle) {
                errEle.innerHTML = "A screen name must be entered\r\n";
                errElements.push("SCREENNAME");
                errEle.style.display="block";                
              }               
            }
            
            var ele = formEle.elements["POSTALCODE"]; 	        
            if (ele && ele.value.trim() == '') {
              var errEle = document.getElementById("ERR-POSTALCODE");
              if (errEle) {
                errEle.innerHTML = "Zip/Postal Code is requried\r\n";
                errElements.push("POSTALCODE");
                errEle.style.display="block";                
              }               
            }
           
   	        var ele = formEle.elements["SUBSCRIBERAGREEMENT"];
            if (!ele.checked) {
              var errEle = document.getElementById("ERR-SUBSCRIBERAGREEMENT");
              if (errEle) {
                errEle.innerHTML = "You must agree to the terms and conditions\r\n";
                errElements.push("SUBSCRIBERAGREEMENT");
                errEle.style.display="block";                
              }              
            } else {
            	disableDisplay("ERR-SUBSCRIBERAGREEMENT");
            }
            
            var ele = formEle.elements["YEAROFBIRTH"];
            if (ele && (ele.value.trim() == '' || ele.value.trim() == '-1')) {
              var errEle = document.getElementById("ERR-YEAROFBIRTH");
              if (errEle) {
                errEle.innerHTML = "Year of Birth is required\r\n";
                errElements.push("YEAROFBIRTH");
              }
            }
            
            var ele = formEle.elements["INVESTINGBACKGROUND"];
            if (ele && (ele.value.trim() == '' || ele.value.trim() == '-1')) {
              var errEle = document.getElementById("ERR-INVESTINGBACKGROUND");
              if (errEle) {
                errEle.innerHTML = "Please select an investing background\r\n";
                errElements.push("INVESTINGBACKGROUND");
              }
            }
            
            var ele = formEle.elements["RISKPROFILE"];
            if (ele && (ele.value.trim() == '' || ele.value.trim() == '-1')) {
              var errEle = document.getElementById("ERR-RISKPROFILE");
              if (errEle) {
                errEle.innerHTML = "Please select a risk profile\r\n";
                errElements.push("RISKPROFILE");
              }
            }
            
	         var ele = formEle.elements["PASSWORD"];
	          passwdEle = ele;
	          if(ele && (ele.value.trim() == ''|| ele.value.trim() == '-1')){	            
	            var errEle = document.getElementById("ERR-RE-PASSWORD");
               	if (errEle) {
                	errEle.innerHTML = "A password must be entered\r\n";
                	errElements.push("RE-PASSWORD");
              	}
              	 repasswdEle = formEle.elements["RE-PASSWORD"];	            
              	}else{
	            var ele_re = formEle.elements["RE-PASSWORD"];
	            repasswdEle = ele_re;
	            if(ele_re && (ele.value.length<6 || ele.value.length >15)){
	              var errEle2 = document.getElementById("ERR-RE-PASSWORD");
	              if(errEle2){
	                errEle2.innerHTML = "Password length must be between 6 and 15 characters\r\n";
	                errElements.push("RE-PASSWORD");
	              }
	            
	            }else if(ele_re && (ele_re.value.trim() == '' || ele_re.value.trim()=='-1') ){
	              var errEle2 = document.getElementById("ERR-RE-PASSWORD");
	              if(errEle2){
	                errEle2.innerHTML = "Your password must be verified\r\n";
	                errElements.push("RE-PASSWORD");
	              }
	              
	            }else if( ele_re && ele.value != ele_re.value){	              
	              var errEle2 = document.getElementById("ERR-RE-PASSWORD");
	              if(errEle2){
	                errEle2.innerHTML = "Your password must match\r\n";
	                errElements.push("RE-PASSWORD");
	              }
	            }
	           }
	           	  if (errElements.length > 0) {           	  
	       
	    if(passwdEle){	      
	      passwdEle.value = "";
	    }
	    if(repasswdEle){	      
	      repasswdEle.value = "";
	    }
	    
	    for (var i = 0; i < errElements.length; i++) {
	      
	      var fieldName = errElements[i];	
	      var errorEle = document.getElementById('ERR-' + fieldName);
	      if (i == 0) {
	    	  formEle.elements[fieldName].focus();
	      }
	      errorEle.style.display="block";
	    }
	    return false;
	  }	     
	  
	  
 	queryString = transformFormToQuery(formEle);
 	
 	url = "https://" + _tr_commerce_commerceHost + "/registration/pages/registration/begin.do?"+queryString;
	doAjajOperation(url);	
}

function clearErr(ele) {
	if (ele && ele.value.trim() != '') {
		if (document.getElementById("ERR-" + ele.id)) {
			document.getElementById("ERR-" + ele.id).innerHTML = '';
			document.getElementById("ERR-" + ele.id).style.display = 'none';
		}
	}
}



function constructRegistrtion(){
	var tmpArray = new Array();
	
     
    
    tmpArray.push('        <div class="gridPanel grid6">');
	tmpArray.push('            <h2>Register for a Reuters.com Account</h2>');
	tmpArray.push('            <p></p>');
	tmpArray.push('            <p><span class="required">*</span> Required Field</p>');
	tmpArray.push('                <form name="registrationForm" id="registrationForm" method="post" action="" onsubmit="javascript:validateAgreement(); return false;">');
    tmpArray.push('                    <input type="hidden"  value="1298" name="__MOID__" /> ');
    tmpArray.push('                    <input type="hidden"  value="RegistrationForm" name="__FH__" />');
    tmpArray.push('                    <input type="hidden"  value="COMMENTS" name="flow" />');
    tmpArray.push('                    <input name="soPosition" value="14" type="hidden">');
	tmpArray.push('	  				   <input type="hidden"  name="overlay" value="true"/>');

	
	tmpArray.push('					  <div class="label"><b>Email Address</b>');
				
	tmpArray.push('				          <span class="required">*</span>');					      
				
	tmpArray.push('					    ');
	tmpArray.push('					  </div>');
	tmpArray.push('				    <div class="textfield" style="margin: 0 0 5px">');
	tmpArray.push('				      <input type="text" name="EMAILADDRESS" id="EMAILADDRESS" value="" onblur="clearErr(this);">');
				
	tmpArray.push('<div class="labelItalic" id="regFormEmailError">');
    tmpArray.push('    Your email address will not be shown anywhere on Reuters.com');
    tmpArray.push('</div>');
	
				
tmpArray.push('				          <div id="ERR-EMAILADDRESS" class="label error" style="display: none;"></div>');
					
tmpArray.push('				    </div>');
		    
tmpArray.push('					  <div class="label"><b>Password</b>');
				
tmpArray.push('				          <span class="required">*</span>');					      
				
tmpArray.push('					  </div>');
tmpArray.push('			      <div class="textfield" style="margin: 0 0 5px">');
tmpArray.push('			        <input type="password" name="PASSWORD" id="PASSWORD" value="" onblur="clearErr(this);">'); 
tmpArray.push('			        <span class="label"></span>');
			        
tmpArray.push('			            <div id="ERR-PASSWORD" class="label error" style="display: none;"></div>');
			          
tmpArray.push('			      </div>');
			      
tmpArray.push('					    <div class="label"><b>Confirm &nbsp;Password</b>');
				
tmpArray.push('				          <span class="required">*</span>');					      
				
tmpArray.push('					    </div>');
tmpArray.push('				      <div class="textfield" style="margin: 0 0 5px">');
tmpArray.push('				        <input type="password" id="RE-PASSWORD"  name="RE-PASSWORD" value="" onblur="clearErr(this);">');
			          
tmpArray.push('			              <div id="ERR-RE-PASSWORD" class="label error" style="display: none;"></div>');
			            
tmpArray.push('				      </div>');        
			    
	tmpArray.push('					  <div class="label"><b>Screen Name</b>');
				
	tmpArray.push('				          <span class="required">*</span>');					      
				
	tmpArray.push('					    ');
	tmpArray.push('					  </div>');
	tmpArray.push('				    <div class="textfield" style="margin: 0 0 5px">');
	tmpArray.push('				      <input type="text" name="SCREENNAME" id="SCREENNAME" value="" onblur="clearErr(this);">');
				
	tmpArray.push('<div class="labelItalic" id="regFormScreenNameError">');
    tmpArray.push('    Your screen name will be displayed next to comments');
    tmpArray.push('</div>');
	
				
tmpArray.push('				          <div id="ERR-SCREENNAME" class="label error" style="display: none;"></div>');
					
tmpArray.push('				    </div>');
		    

tmpArray.push('					<div style="margin:0 0 5px;">');

    tmpArray.push('                 <div id="recaptcha_widget"><b>Type the letters shown below</b>&nbsp;<span class="required">*</span>');
    tmpArray.push('                     <div class="textfield" style="margin: 0 0 5px"><input type="text" id="recaptcha_response_field" name="recaptcha_response_field" value="" onblur="clearErr(this);"/></div>');
    tmpArray.push('                 <div id="recaptcha_image"></div>');    
    
    tmpArray.push('                     <div><a href="javascript:Recaptcha.reload()">Try a new set of characters</a></div>');
    tmpArray.push('                 </div>');


    tmpArray.push('                 <noscript>');
    tmpArray.push('                     <iframe src="https://www.google.com/recaptcha/api/noscript?k=6LdshQsAAAAAALmJ2691WNEK-FDvO7ycD9Glr9KA" height="300" width="500" frameborder="0"></iframe>');
    tmpArray.push('                     <textarea name="recaptcha_challenge_field" rows="3" cols="40">');
    tmpArray.push('                     </textarea>');
    tmpArray.push('                     <input type="hidden" name="recaptcha_response_field" value="manual_challenge">');
    tmpArray.push('                 </noscript>');


tmpArray.push('						<div id="ERR-RECAPTCHA" class="label error" style="display:none;">');
tmpArray.push('						</div>');
tmpArray.push('					</div>');

tmpArray.push('					<div class="checkbox" style="margin: 0 0 3px">');      
tmpArray.push('				      <input name="SUBSCRIBERAGREEMENT" id="SUBSCRIBERAGREEMENT" value="on" type="checkbox">');
var tcDiv = "<span class=\"label\">I agree with the </span><a href=\"javascript:commonPopup('"+"https://" + _tr_commerce_commerceHost+"/commerce/help/termsConditions"+"', 540, 525, 1, 'bottomNav')\">terms and conditions</a> <span class=\"required\">*</span>";
tmpArray.push(tcDiv);
tmpArray.push('				      <div id="ERR-SUBSCRIBERAGREEMENT" class="label error" style="display: none;"></div>');
tmpArray.push('				    </div>');			      
			      
			    


var privacyDiv = "<div style='position: absolute; right: 15px'><img src='"+"https://" + _tr_commerce_commerceHost+"/resources_v2/images/icon_privacy.gif' alt='privacy'>&nbsp;<a href=\"javascript:commonPopup('"+"https://" + _tr_commerce_commerceHost+"/commerce/help/privacy"+"', 540, 525, 1, 'bottomNav')\" style=\"text-decoration: underline\">Why is this secure?</a></div>";



	tmpArray.push('                 <div class="submit" style="margin:5 0 0;">');
	tmpArray.push('<div class="button"><input type="image"	src="/resources_v2/images/btn_register.gif" /></div>');
	tmpArray.push(privacyDiv);
	tmpArray.push('</div>');
	tmpArray.push('				</form>');
	tmpArray.push('				</div>');



	return tmpArray.join('');
}

function showRecaptcha() {
	Recaptcha.create("6LdshQsAAAAAALmJ2691WNEK-FDvO7ycD9Glr9KA", 'captchadiv', {
    
    theme: 'custom',
       lang: 'en',
       custom_theme_widget: 'recaptcha_widget',
    callback: Recaptcha.focus_response_field
    });
}

function promptRegFormAsterisk(){
 	enableDisplay('ERR-EMAILADDRESS');
 	enableDisplay('ERR-SCREENNAME');
 	enableDisplay('ERR-PASSWORD');
 	enableDisplay('ERR-RE-PASSWORD');
 	enableDisplay('ERR-RECAPTCHA');
 	enableDisplay('ERR-SUBSCRIBERAGREEMENT');
 }

function disablePromptRegFormAsterisk(){
 	disableDisplay('ERR-EMAILADDRESS');
 	disableDisplay('ERR-SCREENNAME');
 	disableDisplay('ERR-PASSWORD');
 	disableDisplay('ERR-RE-PASSWORD');
 	disableDisplay('ERR-RECAPTCHA');
 	disableDisplay('ERR-SUBSCRIBERAGREEMENT');
 }

    
function contructNotifyVerifyEmail(userMail){
	var tmpArray = new Array();
	
     
	    tmpArray.push('        <div class="gridPanel grid6">');
		tmpArray.push('            <h2>You Must Verify Your Email Address to Continue</h2>');
		tmpArray.push('            <p>Your account has successfully been created but in order to complete the registration process, you must verify your email address. Click on the submit button to receive a new confirmation email.</p>');
		tmpArray.push('            <div id="gigyalogin" class="gigya_login" ></div>');	
		tmpArray.push('             <form onsubmit="javascript:validateForm(this);return false;" action="" method="post" name="notifyVerifyEmailForm">');
		tmpArray.push('	  				<input type="hidden"	value="1299" name="__MOID__" />');
		tmpArray.push('					<input type="hidden"	value="NotifyVerifyEmailForm" name="__FH__" />');
		tmpArray.push('                 <input type="hidden" value="" name="go" />');
		tmpArray.push('					<input type="hidden"  name="overlay" value="true"/>');
		
		tmpArray.push('                 <div class="label">Email</div>');
		tmpArray.push('                 <div class="textfield"><input type="text" size="40" name="userEmail" value="'+userMail+'"></div>');
		tmpArray.push('			        <div id="ERRORMSG" class="label error" style="display: none;"></div>');
		tmpArray.push('                 <div class="submit"><div class="button"><input type="image"	src="/resources_v2/images/btn_submit.gif" /></div></div>');
		
		tmpArray.push('				</form>');
		tmpArray.push('			</div>');

	return tmpArray.join('');
}

function promptNotifyVerifyErrorMsg(){
 	enableDisplay('ERRORMSG');
}


function validateForm(form) { 
    var formValidationResult; 
    if (!validateRequired(form)){
    	alert('Email address is required');
    	return false;
    } else if (!validateEmail(form)) {
    	alert('Email address is incorrect');
    	return false;
    }
 	queryString = transformFormToQuery(form);
 	
 	url = "https://" + _tr_commerce_commerceHost + "/login/pages/login/login.do?"+queryString;

	doAjajOperation(url);		
} 

function validateRequired(form) {
    var isValid = true;
	email = form.elements['userEmail'].value;
	 if(email == null || email==''){	 	
	 	form.elements['userEmail'].focus();
	 	return false;
	 }
	 return isValid;
}

function validateEmail(form) { 
	var bValid = true;
    var field = form.elements['userEmail'].value

    if (!checkEmail(field)) {
        bValid = false;
    }
	form.elements['userEmail'].focus();
    return bValid;
}



function contructNotifyVerifyEmailSent(userEmail){
		
	var tmpArray = new Array();

	tmpArray.push('        <div class="gridPanel grid6">');
	tmpArray.push('    <h2>Email Sent</h2>');
   	var promptMsg = "An email has been sent to <b>{0}</b>.<br>Please follow the instructions in the email to complete the log in process.<br>Thank you";
	tmpArray.push("<p>"+promptMsg.replace("{0}", userEmail)+"</p>");
		    
	tmpArray.push('        </div>');
	
	return tmpArray.join('');

}

